<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>待办事项</title>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
<style>
  * { margin: 0; padding: 0; box-sizing: border-box; }

  body {
    font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
    background: linear-gradient(135deg, #e0f2fe 0%, #f0fdf4 50%, #fef9c3 100%);
    min-height: 100vh;
    display: flex;
    justify-content: center;
    padding: 40px 16px;
  }

  .app-layout {
    display: flex; gap: 20px; max-width: 1200px; width: 100%; align-self: flex-start;
    height: calc(100vh - 80px);
  }
  .left-panel { flex: 0 0 420px; position: relative; display: flex; flex-direction: column; }
  .left-panel .card {
    flex: 1; display: flex; flex-direction: column; overflow: hidden;
  }
  .right-panel { flex: 1; display: flex; flex-direction: column; position: relative; }

  .card {
    background: #fff;
    border-radius: 16px;
    box-shadow: 0 8px 30px rgba(0,0,0,0.08), inset 0 1px 0 rgba(255,255,255,0.6);
    padding: 32px 28px;
  }
  .left-panel .card { padding: 16px 18px; }

  h1 { font-size: 26px; font-weight: 700; color: #1e293b; text-align: center; margin-bottom: 24px; }
  .left-panel h1 { font-size: 17px; margin-bottom: 10px; }

  /* ===== Auth Overlay ===== */
  .auth-overlay {
    position: fixed; top: 0; left: 0; right: 0; bottom: 0;
    background: linear-gradient(135deg, #e0f2fe 0%, #f0fdf4 50%, #fef9c3 100%);
    z-index: 2000; display: flex; align-items: center; justify-content: center;
  }
  .auth-overlay.hidden { display: none; }
  .hidden { display: none !important; }
  .auth-box {
    background: #fff; border-radius: 16px; padding: 36px 32px; width: 90%; max-width: 400px;
    box-shadow: 0 8px 30px rgba(0,0,0,0.1);
  }
  .auth-box h2 { text-align: center; font-size: 24px; color: #1e293b; margin-bottom: 6px; }
  .auth-box .auth-subtitle { text-align: center; font-size: 13px; color: #94a3b8; margin-bottom: 20px; }
  .auth-tabs { display: flex; gap: 0; margin-bottom: 20px; border-bottom: 2px solid #e2e8f0; }
  .auth-tab {
    flex: 1; padding: 10px; text-align: center; font-size: 14px; font-weight: 600;
    color: #94a3b8; background: none; border: none; cursor: pointer;
    border-bottom: 2px solid transparent; margin-bottom: -2px; transition: all 0.2s;
  }
  .auth-tab.active { color: #3b82f6; border-bottom-color: #3b82f6; }
  .auth-tab:hover { color: #3b82f6; }
  .auth-field { margin-bottom: 14px; }
  .auth-field label { display: block; font-size: 13px; font-weight: 500; color: #64748b; margin-bottom: 5px; }
  .auth-field input {
    width: 100%; padding: 10px 14px; border: 2px solid #e2e8f0; border-radius: 10px;
    font-size: 14px; outline: none; transition: border-color 0.2s;
  }
  .auth-field input:focus { border-color: #60a5fa; }
  .auth-submit {
    width: 100%; padding: 12px; background: #3b82f6; color: #fff; border: none; border-radius: 10px;
    font-size: 15px; font-weight: 600; cursor: pointer; transition: background 0.2s; margin-top: 6px;
  }
  .auth-submit:hover { background: #2563eb; }
  .auth-submit:disabled { opacity: 0.5; cursor: not-allowed; }
  .auth-error { color: #dc2626; font-size: 13px; margin-top: 10px; text-align: center; min-height: 20px; }
  .auth-loading { text-align: center; color: #94a3b8; font-size: 14px; padding: 20px 0; }

  /* ===== User Bar ===== */
  .user-bar {
    display: flex; align-items: center; justify-content: flex-end; gap: 8px;
    margin-bottom: 8px; padding: 0;
  }
  .user-bar .user-email { font-size: 12px; color: #64748b; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; max-width: 200px; }
  .user-bar .logout-btn {
    padding: 4px 12px; border: 1.5px solid #e2e8f0; border-radius: 6px; background: #fff;
    font-size: 12px; cursor: pointer; color: #64748b; transition: all 0.2s;
  }
  .user-bar .logout-btn:hover { border-color: #fca5a5; color: #dc2626; background: #fef2f2; }
  .lang-toggle {
    padding: 3px 10px; border: 1.5px solid #e2e8f0; border-radius: 6px; background: #fff;
    font-size: 11px; cursor: pointer; color: #64748b; transition: all 0.2s; font-weight: 600;
  }
  .lang-toggle:hover { border-color: #93c5fd; color: #3b82f6; }

  /* ===== Input Row ===== */
  .input-row { display: flex; gap: 6px; margin-bottom: 8px; flex-wrap: wrap; align-items: center; }
  .input-row input[type="text"] {
    flex: 1; min-width: 100px; padding: 7px 10px; border: 1.5px solid #e2e8f0;
    border-radius: 8px; font-size: 13px; outline: none; transition: border-color 0.2s;
  }
  .input-row input[type="text"]:focus { border-color: #60a5fa; }
  .input-row input[type="date"] {
    padding: 7px 6px; border: 1.5px solid #e2e8f0; border-radius: 8px; font-size: 11px;
    outline: none; transition: border-color 0.2s; color: #64748b; max-width: 120px;
  }
  .input-row input[type="date"]:focus { border-color: #60a5fa; }
  .input-row select {
    padding: 7px 6px; border: 1.5px solid #e2e8f0; border-radius: 8px; font-size: 11px;
    outline: none; background: #fff; cursor: pointer; color: #64748b; transition: border-color 0.2s;
  }
  .input-row select:focus { border-color: #60a5fa; }
  .input-row .add-btn {
    padding: 7px 12px; background: #3b82f6; color: #fff; border: none; border-radius: 8px;
    font-size: 13px; font-weight: 600; cursor: pointer; transition: background 0.2s; white-space: nowrap;
  }
  .input-row .add-btn:hover { background: #2563eb; }
  .mic-btn {
    padding: 10px 14px; background: #f1f5f9; border: 2px solid #e2e8f0; border-radius: 10px;
    font-size: 16px; cursor: pointer; transition: all 0.2s; line-height: 1; flex-shrink: 0;
  }
  .mic-btn:hover { background: #e2e8f0; }
  .mic-btn.listening { background: #fee2e2; border-color: #fca5a5; animation: pulse 1s ease-in-out infinite; }
  .mic-btn.unsupported { opacity: 0.3; cursor: not-allowed; }
  .speak-btn {
    background: none; border: none; font-size: 16px; cursor: pointer; padding: 2px 6px;
    opacity: 0.5; transition: opacity 0.2s; vertical-align: middle;
  }
  .speak-btn:hover { opacity: 1; }
  .speak-btn.speaking { opacity: 1; animation: pulse 1s ease-in-out infinite; }
  .smart-add-trigger {
    padding: 7px 10px; background: #f5f3ff; border: 1.5px solid #c4b5fd; border-radius: 8px;
    font-size: 13px; cursor: pointer; color: #7c3aed; font-weight: 600; transition: all 0.2s;
    white-space: nowrap; line-height: 1; flex-shrink: 0;
  }
  .smart-add-trigger:hover { background: #ede9fe; border-color: #a78bfa; }
  .smart-modal-textarea {
    width: 100%; min-height: 120px; padding: 12px; padding-right: 50px; border: 2px solid #e2e8f0;
    border-radius: 10px; font-size: 14px; resize: vertical; outline: none; font-family: inherit;
    transition: border-color 0.2s; line-height: 1.6;
  }
  .smart-modal-textarea:focus { border-color: #a78bfa; }
  .smart-modal-actions { display: flex; gap: 10px; margin-top: 12px; align-items: center; }
  .smart-parse-btn {
    padding: 8px 20px; background: #7c3aed; color: #fff; border: none; border-radius: 8px;
    font-size: 14px; font-weight: 600; cursor: pointer; transition: background 0.2s;
  }
  .smart-parse-btn:hover { background: #6d28d9; }
  .smart-parse-btn:disabled { opacity: 0.5; cursor: not-allowed; }
  .smart-parse-btn.loading { animation: pulse 1.2s ease-in-out infinite; }
  .smart-parse-hint { font-size: 12px; color: #94a3b8; }

  /* ===== Filter Toolbar ===== */
  .toolbar { display: flex; gap: 5px; margin-bottom: 8px; flex-wrap: wrap; align-items: center; }
  .toolbar .search-input {
    flex: 1; min-width: 80px; padding: 5px 8px; border: 1.5px solid #e2e8f0;
    border-radius: 6px; font-size: 12px; outline: none; transition: border-color 0.2s;
  }
  .toolbar .search-input:focus { border-color: #60a5fa; }
  .filter-btns { display: flex; gap: 2px; }
  .filter-btn {
    padding: 4px 8px; border: 1.5px solid #e2e8f0; border-radius: 6px; background: #fff;
    font-size: 11px; cursor: pointer; color: #64748b; transition: all 0.2s; white-space: nowrap;
  }
  .filter-btn:hover { border-color: #93c5fd; color: #3b82f6; }
  .filter-btn.active { background: #3b82f6; color: #fff; border-color: #3b82f6; }
  .toolbar select {
    padding: 4px 6px; border: 1.5px solid #e2e8f0; border-radius: 6px; font-size: 11px;
    background: #fff; cursor: pointer; color: #64748b; outline: none;
  }

  /* ===== Todo List ===== */
  .todo-list { list-style: none; flex: 1; overflow-y: auto; min-height: 0; }
  .todo-item {
    display: flex; align-items: center; gap: 10px; padding: 12px 4px;
    border-bottom: 1px solid #f1f5f9; animation: fadeIn 0.25s ease;
    transition: opacity 0.2s, background 0.15s; border-radius: 8px;
  }
  .todo-item:last-child { border-bottom: none; }
  .todo-item.dragging { opacity: 0.4; background: #f0f9ff; }
  .todo-item.drag-over { border-top: 2px solid #3b82f6; }
  @keyframes fadeIn { from { opacity:0; transform:translateY(-6px); } to { opacity:1; transform:translateY(0); } }

  .drag-handle { cursor: grab; color: #cbd5e1; font-size: 14px; user-select: none; flex-shrink: 0; padding: 2px; transition: color 0.2s; line-height: 1; }
  .drag-handle:hover { color: #94a3b8; }
  .drag-handle:active { cursor: grabbing; }

  .todo-checkbox {
    width: 18px; height: 18px; cursor: pointer; flex-shrink: 0; accent-color: #7c3aed;
  }
  .complete-btn {
    padding: 3px 10px; border-radius: 6px; font-size: 11px; font-weight: 500; cursor: pointer;
    border: 1.5px solid #d1d5db; background: #fff; color: #64748b; transition: all 0.2s; flex-shrink: 0; white-space: nowrap;
  }
  .complete-btn:hover { border-color: #34d399; color: #16a34a; background: #f0fdf4; }
  .complete-btn.is-done { border-color: #bbf7d0; background: #dcfce7; color: #16a34a; }

  .select-bar {
    display: flex; gap: 8px; align-items: center; padding: 8px 12px; margin-bottom: 10px;
    background: #f5f3ff; border: 1.5px solid #e9d5ff; border-radius: 10px; flex-wrap: wrap;
  }
  .select-bar .select-count { font-size: 13px; font-weight: 600; color: #7c3aed; margin-right: 4px; }
  .select-bar .select-action {
    padding: 4px 12px; border: 1.5px solid #c4b5fd; border-radius: 6px; background: #faf5ff;
    font-size: 11px; cursor: pointer; color: #7c3aed; font-weight: 500; transition: all 0.2s;
  }
  .select-bar .select-action:hover { background: #ede9fe; border-color: #a78bfa; }
  .select-bar .select-action.danger { border-color: #fca5a5; color: #dc2626; background: #fef2f2; }
  .select-bar .select-action.danger:hover { background: #fee2e2; }
  .select-bar .select-cancel { background: none; border: none; color: #94a3b8; font-size: 12px; cursor: pointer; margin-left: auto; }

  .todo-item.subtask { margin-left: 28px; border-left: 2px solid #e9d5ff; padding-left: 12px; }
  .todo-item.subtask .todo-text { font-size: 13px; }
  .subtask-actions {
    margin-left: 28px; border-left: 2px solid #e9d5ff; padding: 6px 12px;
    display: flex; gap: 6px; align-items: center; flex-wrap: wrap;
  }
  .subtask-actions .sub-action-btn {
    padding: 3px 10px; border: 1px solid #e2e8f0; border-radius: 6px; background: #fff;
    font-size: 11px; cursor: pointer; color: #64748b; transition: all 0.2s;
  }
  .subtask-actions .sub-action-btn:hover { border-color: #93c5fd; color: #3b82f6; }
  .subtask-actions .sub-action-btn.danger:hover { border-color: #fca5a5; color: #dc2626; }

  .item-content { flex: 1; min-width: 0; }
  .todo-text { font-size: 14px; color: #334155; word-break: break-word; transition: color 0.2s; }
  .todo-text.done { text-decoration: line-through; color: #94a3b8; }
  .item-meta { display: flex; gap: 6px; margin-top: 4px; flex-wrap: wrap; align-items: center; }

  .cat-badge { display: inline-block; padding: 1px 8px; border-radius: 10px; font-size: 11px; font-weight: 500; line-height: 1.6; }
  .cat-work { background: #dbeafe; color: #2563eb; }
  .cat-life { background: #dcfce7; color: #16a34a; }
  .cat-study { background: #f3e8ff; color: #9333ea; }
  .cat-other { background: #f1f5f9; color: #64748b; }

  .due-badge { display: inline-block; padding: 1px 8px; border-radius: 10px; font-size: 11px; font-weight: 500; line-height: 1.6; }
  .due-overdue { background: #fee2e2; color: #dc2626; }
  .due-today { background: #ffedd5; color: #ea580c; }
  .due-future { background: #f1f5f9; color: #64748b; }

  .del-btn, .edit-btn { background: none; border: none; color: #cbd5e1; cursor: pointer; padding: 4px; line-height: 1; transition: color 0.2s; flex-shrink: 0; }
  .del-btn { font-size: 16px; }
  .del-btn:hover { color: #f87171; }
  .edit-btn { font-size: 14px; }
  .edit-btn:hover { color: #60a5fa; }

  /* Inline Edit */
  .edit-row { display: flex; gap: 6px; flex-wrap: wrap; align-items: center; width: 100%; }
  .edit-row input[type="text"] { flex:1; min-width:100px; padding:6px 10px; border:1.5px solid #93c5fd; border-radius:6px; font-size:14px; outline:none; }
  .edit-row input[type="date"] { padding:6px 8px; border:1.5px solid #93c5fd; border-radius:6px; font-size:12px; outline:none; max-width:140px; }
  .edit-row select { padding:6px 8px; border:1.5px solid #93c5fd; border-radius:6px; font-size:12px; outline:none; background:#fff; }
  .edit-row .save-edit-btn { padding:5px 12px; background:#34d399; color:#fff; border:none; border-radius:6px; font-size:12px; font-weight:600; cursor:pointer; }
  .edit-row .cancel-edit-btn { padding:5px 12px; background:#e2e8f0; color:#64748b; border:none; border-radius:6px; font-size:12px; cursor:pointer; }

  /* Stats & Empty */
  .stats { text-align: center; margin-top: 6px; font-size: 11px; color: #94a3b8; }
  .empty { text-align: center; padding: 24px 0; color: #cbd5e1; font-size: 13px; }

  /* Date Group Header */
  .date-header { display: flex; align-items: center; gap: 10px; padding: 10px 4px 6px; margin-top: 8px; font-size: 13px; font-weight: 600; color: #64748b; }
  .date-header:first-child { margin-top: 0; }
  .date-header-line { flex: 1; height: 1px; background: #e2e8f0; }
  .date-header-label { white-space: nowrap; }
  .date-header-label.is-overdue { color: #dc2626; }
  .date-header-label.is-today { color: #ea580c; font-weight: 700; }

  /* ===== Footer ===== */
  .footer-bar { display: flex; justify-content: center; gap: 6px; margin-top: 8px; padding-top: 8px; border-top: 1px solid #f1f5f9; flex-wrap: wrap; }
  .footer-btn {
    padding: 4px 10px; border: 1.5px solid #e2e8f0; border-radius: 6px; background: #fff;
    font-size: 11px; cursor: pointer; color: #64748b; transition: all 0.2s;
  }
  .footer-btn:hover { border-color: #93c5fd; color: #3b82f6; }

  /* ===== AI Buttons (reused in chat panel) ===== */
  .ai-btn {
    padding: 7px 14px; border: 1.5px solid #c4b5fd; border-radius: 8px; background: #faf5ff;
    font-size: 12px; cursor: pointer; color: #7c3aed; font-weight: 500; transition: all 0.2s;
  }
  .ai-btn:hover { background: #ede9fe; border-color: #a78bfa; }
  .ai-btn:disabled { opacity: 0.5; cursor: not-allowed; }
  .ai-btn.loading { animation: pulse 1.2s ease-in-out infinite; }
  @keyframes pulse { 0%,100% { opacity:1; } 50% { opacity:0.5; } }

  .ai-result {
    background: #faf5ff; border: 1px solid #e9d5ff; border-radius: 10px; padding: 14px 16px;
    font-size: 13px; line-height: 1.7; color: #334155; white-space: pre-wrap; max-height: none;
    overflow-y: auto; margin-top: 8px;
  }
  .ai-result .ai-task-item {
    display: flex; align-items: center; gap: 8px; padding: 6px 0; border-bottom: 1px solid #f3e8ff;
  }
  .ai-result .ai-task-item:last-child { border-bottom: none; }
  .ai-add-btn {
    padding: 3px 10px; background: #7c3aed; color: #fff; border: none; border-radius: 6px;
    font-size: 11px; cursor: pointer; white-space: nowrap; flex-shrink: 0;
  }
  .ai-add-btn:hover { background: #6d28d9; }

  /* ===== Right Panel Chat ===== */
  .right-panel .card {
    display: flex; flex-direction: column; flex: 1; overflow: hidden; min-height: 0;
  }
  .chat-header {
    border-bottom: 1px solid #e2e8f0; padding-bottom: 12px; margin-bottom: 0;
  }
  .chat-header h2 { font-size: 16px; font-weight: 700; color: #1e293b; margin-bottom: 10px; word-break: break-word; }
  .chat-actions { display: flex; gap: 8px; flex-wrap: wrap; }
  .chat-messages {
    flex: 1; overflow-y: auto; padding: 16px 0; display: flex; flex-direction: column; gap: 16px;
    min-height: 0;
  }
  .chat-msg {
    padding: 12px 16px; border-radius: 12px; line-height: 1.7; font-size: 14px; word-break: break-word;
  }
  .chat-msg.user {
    background: #ede9fe; align-self: flex-end; max-width: 80%;
  }
  .chat-msg.ai {
    background: #f8fafc; border: 1px solid #e2e8f0; align-self: flex-start; max-width: 90%;
  }
  .chat-msg.ai h1, .chat-msg.ai h2, .chat-msg.ai h3 {
    margin: 12px 0 6px; font-weight: 700; color: #1e293b;
  }
  .chat-msg.ai h1 { font-size: 18px; }
  .chat-msg.ai h2 { font-size: 16px; }
  .chat-msg.ai h3 { font-size: 14px; }
  .chat-msg.ai ul, .chat-msg.ai ol { margin: 6px 0; padding-left: 20px; }
  .chat-msg.ai li { margin: 3px 0; }
  .chat-msg.ai code {
    background: #f1f5f9; padding: 1px 5px; border-radius: 4px; font-size: 13px; font-family: monospace;
  }
  .chat-msg.ai pre { background: #f1f5f9; padding: 10px 14px; border-radius: 8px; overflow-x: auto; margin: 8px 0; }
  .chat-msg.ai pre code { background: none; padding: 0; }
  .chat-msg.ai table { border-collapse: collapse; width: 100%; margin: 8px 0; }
  .chat-msg.ai th, .chat-msg.ai td { border: 1px solid #e2e8f0; padding: 6px 10px; font-size: 13px; text-align: left; }
  .chat-msg.ai th { background: #f1f5f9; font-weight: 600; }
  .chat-msg.ai p { margin: 6px 0; }
  .chat-msg.ai strong { font-weight: 700; }
  .chat-msg.ai blockquote { border-left: 3px solid #c4b5fd; padding-left: 12px; color: #64748b; margin: 8px 0; }
  .chat-empty {
    flex: 1; display: flex; align-items: center; justify-content: center; color: #cbd5e1;
    font-size: 14px; text-align: center; padding: 40px 0;
  }
  .chat-input-bar {
    display: flex; gap: 8px; padding-top: 12px; border-top: 1px solid #e2e8f0; margin-top: 8px;
  }
  .chat-input-bar input {
    flex: 1; padding: 9px 14px; border: 2px solid #e2e8f0; border-radius: 10px;
    font-size: 14px; outline: none; transition: border-color 0.2s;
  }
  .chat-input-bar input:focus { border-color: #60a5fa; }
  .chat-input-bar button {
    padding: 9px 18px; background: #3b82f6; color: #fff; border: none; border-radius: 10px;
    font-size: 14px; font-weight: 600; cursor: pointer; transition: background 0.2s; white-space: nowrap;
  }
  .chat-input-bar button:hover { background: #2563eb; }
  .chat-export-bar {
    display: flex; gap: 8px; padding-top: 10px; justify-content: flex-end;
  }
  .chat-export-bar button {
    padding: 6px 14px; border: 1.5px solid #e2e8f0; border-radius: 8px; background: #fff;
    font-size: 12px; cursor: pointer; color: #64748b; transition: all 0.2s;
  }
  .chat-export-bar button:hover { border-color: #93c5fd; color: #3b82f6; }

  .todo-item.selected-task { background: #f5f3ff; }

  /* ===== Scroll Down Button ===== */
  .scroll-down-btn {
    position: absolute; bottom: 18px; left: 50%; transform: translateX(-50%);
    width: 36px; height: 36px; border-radius: 50%; border: 1.5px solid #e2e8f0;
    background: #fff; color: #64748b; font-size: 18px; cursor: pointer;
    box-shadow: 0 2px 8px rgba(0,0,0,0.1); display: none;
    align-items: center; justify-content: center; z-index: 10; transition: all 0.2s;
    line-height: 1; padding: 0;
  }
  .scroll-down-btn:hover { background: #f1f5f9; border-color: #93c5fd; color: #3b82f6; }
  .scroll-down-btn.show { display: flex; }

  /* ===== Modal ===== */
  .modal-overlay {
    display: none; position: fixed; top:0; left:0; right:0; bottom:0;
    background: rgba(0,0,0,0.4); z-index: 1000; align-items: center; justify-content: center;
  }
  .modal-overlay.show { display: flex; }
  .modal-box {
    background: #fff; border-radius: 14px; padding: 28px; width: 90%; max-width: 480px;
    box-shadow: 0 20px 60px rgba(0,0,0,0.2); max-height: 80vh; overflow-y: auto;
  }
  .modal-box h3 { font-size: 18px; margin-bottom: 14px; color: #7c3aed; }
  .modal-box .ai-result { max-height: 50vh; }
  .modal-close {
    display: block; margin: 14px auto 0; padding: 8px 24px; background: #e2e8f0; border: none;
    border-radius: 8px; font-size: 13px; cursor: pointer; color: #64748b;
  }

  /* ===== Responsive ===== */
  @media (max-width: 900px) {
    .app-layout { flex-direction: column; height: auto; }
    .left-panel { flex: none; width: 100%; max-height: 60vh; }
    .right-panel { min-height: 60vh; }
  }
  @media (max-width: 480px) {
    body { padding: 16px 8px; }
    .card { padding: 20px 16px; }
    .input-row input[type="date"] { max-width: 130px; }
  }
</style>
</head>
<body>

<!-- Auth Overlay -->
<div class="auth-overlay" id="authOverlay">
  <div class="auth-box">
    <div style="text-align:right;margin-bottom:8px"><button class="lang-toggle" id="authLangToggle">EN</button></div>
    <h2>&#128221; <span data-i18n="appTitle">待办事项</span></h2>
    <p class="auth-subtitle" data-i18n="authSubtitle">登录后数据云端同步，多设备访问</p>
    <div class="auth-tabs">
      <button class="auth-tab active" id="loginTab" data-i18n="login">登录</button>
      <button class="auth-tab" id="registerTab" data-i18n="register">注册</button>
    </div>
    <div id="authForm" class="hidden">
      <div class="auth-field">
        <label for="authEmail" data-i18n="email">邮箱</label>
        <input type="email" id="authEmail" placeholder="your@email.com" autocomplete="email">
      </div>
      <div class="auth-field">
        <label for="authPassword" data-i18n="password">密码</label>
        <input type="password" id="authPassword" data-i18n-ph="passwordPh" placeholder="至少6位密码" autocomplete="current-password">
      </div>
      <button class="auth-submit" id="authSubmit" data-i18n="login">登录</button>
      <div class="auth-error" id="authError"></div>
    </div>
    <div class="auth-loading" id="authLoading" data-i18n="checkingAuth">正在检查登录状态...</div>
  </div>
</div>

<div class="app-layout">
  <!-- Left Panel: Todo List -->
  <div class="left-panel">
    <div class="card">
      <div class="user-bar" id="userBar" style="display:none">
        <span class="user-email" id="userEmail"></span>
        <button class="lang-toggle" id="langToggle">EN</button>
        <button class="logout-btn" id="logoutBtn" data-i18n="logout">退出登录</button>
      </div>

      <h1>&#128221; <span data-i18n="appTitle">待办事项</span></h1>

      <div class="input-row">
        <input id="todoInput" type="text" data-i18n-ph="addTodoPh" placeholder="添加新待办..." autocomplete="off">
        <input id="dueDateInput" type="date" title="截止日期">
        <select id="categoryInput" title="分类">
          <option value="other" data-i18n="catOther">其他</option>
          <option value="work" data-i18n="catWork">工作</option>
          <option value="life" data-i18n="catLife">生活</option>
          <option value="study" data-i18n="catStudy">学习</option>
        </select>
        <button class="add-btn" id="addBtn" data-i18n="add">添加</button>
        <button class="smart-add-trigger" id="smartAddBtn" title="智能添加（支持语音）">&#x2728;</button>
      </div>

      <div class="toolbar">
        <input class="search-input" id="searchInput" type="text" data-i18n-ph="searchPh" placeholder="搜索..." autocomplete="off">
        <div class="filter-btns">
          <button class="filter-btn active" data-filter="all" data-i18n="filterAll">全部</button>
          <button class="filter-btn" data-filter="active" data-i18n="filterActive">未完成</button>
          <button class="filter-btn" data-filter="done" data-i18n="filterDone">已完成</button>
        </div>
        <select id="catFilter">
          <option value="all" data-i18n="allCats">全部分类</option>
          <option value="work" data-i18n="catWork">工作</option>
          <option value="life" data-i18n="catLife">生活</option>
          <option value="study" data-i18n="catStudy">学习</option>
          <option value="other" data-i18n="catOther">其他</option>
        </select>
      </div>

      <div id="selectBar" class="select-bar" style="display:none"></div>
      <ul class="todo-list" id="todoList"></ul>
      <div class="stats" id="stats"></div>

      <div class="footer-bar">
        <button class="footer-btn" id="exportBtn">&#128230; <span data-i18n="export">导出</span></button>
        <button class="footer-btn" id="importBtn">&#128229; <span data-i18n="import">导入</span></button>
        <input type="file" id="importFile" accept=".json" style="display:none">
      </div>
    </div>
    <button class="scroll-down-btn" id="leftScrollBtn" title="滚动到底部">&#8595;</button>
  </div>

  <!-- Right Panel: Chat -->
  <div class="right-panel">
    <div class="card">
      <div class="chat-header">
        <h2 id="chatTaskTitle">选择一个任务开始...</h2>
        <div class="chat-actions">
          <button class="ai-btn" id="chatBreakdownBtn" disabled>&#127919; 拆解</button>
          <button class="ai-btn" id="chatExecuteBtn" disabled>&#9889; 执行</button>
          <button class="ai-btn" id="chatPlanBtn">&#128197; 每日规划</button>
          <button class="ai-btn" id="chatWeekReviewBtn">&#128202; 一周回顾</button>
        </div>
      </div>
      <div class="chat-messages" id="chatMessages">
        <div class="chat-empty" id="chatEmpty">&#x2728; 点击左侧任务，开始 AI 对话</div>
      </div>
      <div class="chat-input-bar">
        <input id="chatInput" placeholder="输入追问..." disabled>
        <button id="chatSendBtn" disabled>发送</button>
      </div>
      <div class="chat-export-bar">
        <button id="exportWordBtn">&#128196; 导出 Word</button>
        <button id="exportPdfBtn">&#128196; 导出 PDF</button>
      </div>
    </div>
    <button class="scroll-down-btn" id="rightScrollBtn" title="滚动到底部">&#8595;</button>
  </div>
</div>

<!-- Smart Add Modal -->
<div class="modal-overlay" id="smartAddModal">
  <div class="modal-box">
    <h3>&#x2728; <span data-i18n="smartAddTitle">智能添加</span></h3>
    <p style="font-size:13px;color:#64748b;margin-bottom:12px" data-i18n="smartAddDesc">粘贴文字或语音输入，AI 自动识别并生成待办事项</p>
    <div style="position:relative">
      <textarea class="smart-modal-textarea" id="smartAddText" data-i18n-ph="smartAddPh" placeholder="在此粘贴或输入文字...&#10;例如：明天下午开会讨论项目进度，后天交周报，今天买菜做饭"></textarea>
      <div style="position:absolute;right:8px;bottom:8px;display:flex;gap:4px;align-items:center">
        <button class="mic-btn" id="smartMicBtn" title="语音输入">&#127908;</button>
      </div>
    </div>
    <div class="smart-modal-actions">
      <button class="smart-parse-btn" id="smartParseBtn">&#129302; <span data-i18n="aiParse">AI 解析</span></button>
      <span class="smart-parse-hint" id="smartParseHint"></span>
    </div>
    <div id="smartAddResult"></div>
    <div style="display:flex;gap:8px;justify-content:center;margin-top:14px">
      <button class="modal-close" id="smartAddClose" data-i18n="close">关闭</button>
    </div>
  </div>
</div>

<script>
(function () {
  // ===== Supabase Configuration =====
  var SUPABASE_URL = 'https://cokplvhmunogtjubuuud.supabase.co';
  var SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImNva3BsdmhtdW5vZ3RqdWJ1dXVkIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzA2MjE2NzksImV4cCI6MjA4NjE5NzY3OX0.dLYyQzWk8r-CLaitelSPrgQZPnrRwpRaGJ3SIeJKeGs';
  var supabaseClient;
  try {
    supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
  } catch(e) {
    document.getElementById('authLoading').textContent = '网络连接失败，请刷新页面重试';
  }
  var currentUser = null;

  // ===== Auth =====
  var authOverlay = document.getElementById('authOverlay');
  var authLoading = document.getElementById('authLoading');
  var authForm = document.getElementById('authForm');
  var loginTab = document.getElementById('loginTab');
  var registerTab = document.getElementById('registerTab');
  var authEmail = document.getElementById('authEmail');
  var authPassword = document.getElementById('authPassword');
  var authSubmit = document.getElementById('authSubmit');
  var authError = document.getElementById('authError');
  var userBar = document.getElementById('userBar');
  var userEmailEl = document.getElementById('userEmail');
  var logoutBtn = document.getElementById('logoutBtn');

  var isLoginMode = true;

  loginTab.addEventListener('click', function() {
    isLoginMode = true;
    loginTab.classList.add('active');
    registerTab.classList.remove('active');
    authSubmit.textContent = T('login');
    authError.textContent = '';
  });

  registerTab.addEventListener('click', function() {
    isLoginMode = false;
    registerTab.classList.add('active');
    loginTab.classList.remove('active');
    authSubmit.textContent = T('register');
    authError.textContent = '';
  });

  authPassword.addEventListener('keydown', function(e) {
    if (e.key === 'Enter') authSubmit.click();
  });

  authSubmit.addEventListener('click', async function() {
    var email = authEmail.value.trim();
    var password = authPassword.value;
    if (!email || !password) { authError.textContent = T('fillEmailPwd'); return; }
    if (password.length < 6) { authError.textContent = T('pwdMinLen'); return; }

    authSubmit.disabled = true;
    authError.textContent = '';

    try {
      var result;
      if (isLoginMode) {
        result = await supabaseClient.auth.signInWithPassword({ email: email, password: password });
      } else {
        result = await supabaseClient.auth.signUp({ email: email, password: password });
      }

      if (result.error) {
        var msg = result.error.message;
        if (msg.includes('Invalid login')) msg = T('wrongCredentials');
        else if (msg.includes('already registered')) msg = T('alreadyRegistered');
        else if (msg.includes('Email not confirmed')) msg = T('verifyEmail');
        else if (msg.includes('Password should')) msg = T('pwdTooShort');
        authError.textContent = msg;
      } else if (result.data && result.data.user) {
        if (!isLoginMode && result.data.user.identities && result.data.user.identities.length === 0) {
          authError.textContent = T('alreadyRegistered');
        } else if (!isLoginMode && !result.data.session) {
          authError.textContent = T('registerSuccess');
          authError.style.color = '#16a34a';
        }
        // onAuthStateChange will handle the rest
      }
    } catch(e) {
      authError.textContent = T('networkError');
    }
    authSubmit.disabled = false;
  });

  logoutBtn.addEventListener('click', async function() {
    if (!supabaseClient) return;
    await supabaseClient.auth.signOut();
    // onAuthStateChange will handle UI
  });

  // Language toggle
  document.getElementById('authLangToggle').addEventListener('click', function() {
    updateLanguage(currentLang === 'zh' ? 'en' : 'zh');
  });
  document.getElementById('langToggle').addEventListener('click', function() {
    updateLanguage(currentLang === 'zh' ? 'en' : 'zh');
  });

  function showApp(user) {
    currentUser = user;
    authOverlay.classList.add('hidden');
    userBar.style.display = 'flex';
    userEmailEl.textContent = user.email;
    loadChatMap();
    loadTodosFromDB();
  }

  function showAuth() {
    currentUser = null;
    todos = [];
    taskChatMap = {};
    chatHistory = [];
    selectedTask = null;
    authOverlay.classList.remove('hidden');
    authForm.classList.remove('hidden');
    authLoading.classList.add('hidden');
    userBar.style.display = 'none';
    render();
  }

  async function checkAuth() {
    if (!supabaseClient) { showAuth(); return; }
    authForm.classList.add('hidden');
    authLoading.classList.remove('hidden');

    try {
      var sessionPromise = supabaseClient.auth.getSession();
      var timeoutPromise = new Promise(function(_, reject) {
        setTimeout(function() { reject(new Error('timeout')); }, 6000);
      });
      var { data: { session } } = await Promise.race([sessionPromise, timeoutPromise]);
      if (session && session.user) {
        showApp(session.user);
      } else {
        showAuth();
      }
    } catch(e) {
      showAuth();
    }

    // Listen for auth state changes
    supabaseClient.auth.onAuthStateChange(function(event, session) {
      if (event === 'SIGNED_IN' && session && session.user) {
        showApp(session.user);
      } else if (event === 'SIGNED_OUT') {
        showAuth();
      }
    });
  }

  // ===== DOM refs =====
  var input = document.getElementById('todoInput');
  var dueDateInput = document.getElementById('dueDateInput');
  var categoryInput = document.getElementById('categoryInput');
  var addBtn = document.getElementById('addBtn');
  var listEl = document.getElementById('todoList');
  var statsEl = document.getElementById('stats');
  var searchInput = document.getElementById('searchInput');
  var catFilter = document.getElementById('catFilter');
  var exportBtn = document.getElementById('exportBtn');
  var importBtn = document.getElementById('importBtn');
  var importFile = document.getElementById('importFile');
  // Chat panel refs
  var chatTaskTitle = document.getElementById('chatTaskTitle');
  var chatMessages = document.getElementById('chatMessages');
  var chatEmpty = document.getElementById('chatEmpty');
  var chatInput = document.getElementById('chatInput');
  var chatSendBtn = document.getElementById('chatSendBtn');
  var chatBreakdownBtn = document.getElementById('chatBreakdownBtn');
  var chatExecuteBtn = document.getElementById('chatExecuteBtn');
  var chatPlanBtn = document.getElementById('chatPlanBtn');
  var chatWeekReviewBtn = document.getElementById('chatWeekReviewBtn');
  var exportWordBtn = document.getElementById('exportWordBtn');
  var exportPdfBtn = document.getElementById('exportPdfBtn');
  var selectBar = document.getElementById('selectBar');
  var smartAddBtn = document.getElementById('smartAddBtn');
  var smartAddModal = document.getElementById('smartAddModal');
  var smartAddText = document.getElementById('smartAddText');
  var smartMicBtn = document.getElementById('smartMicBtn');
  var smartParseBtn = document.getElementById('smartParseBtn');
  var smartParseHint = document.getElementById('smartParseHint');
  var smartAddResult = document.getElementById('smartAddResult');
  var smartAddClose = document.getElementById('smartAddClose');

  var currentFilter = 'all';
  var dragSrcIndex = null;
  var editingId = null;
  var selectedIds = new Set();
  var selectedTask = null;
  var chatHistory = [];
  var taskChatMap = {}; // { taskId: { history: [...], html: '' } }

  var CAT_KEYS = ['work', 'life', 'study', 'other'];

  // ===== i18n =====
  var currentLang = localStorage.getItem('app-lang') || 'zh';
  var i18n = {
    zh: {
      appTitle: '待办事项', authSubtitle: '登录后数据云端同步，多设备访问',
      login: '登录', register: '注册', email: '邮箱', password: '密码',
      passwordPh: '至少6位密码', checkingAuth: '正在检查登录状态...',
      logout: '退出登录', add: '添加', smartAdd: '智能添加（支持语音）',
      addTodoPh: '添加新的待办事项...', searchPh: '搜索...',
      filterAll: '全部', filterActive: '未完成', filterDone: '已完成',
      allCats: '全部分类', catWork: '工作', catLife: '生活', catStudy: '学习', catOther: '其他',
      aiTitle: 'AI 助手', aiBreakdown: '拆解任务', aiExecute: '任务执行', aiPlan: '每日规划',
      export: '导出', import: '导入', close: '关闭',
      smartAddTitle: '智能添加', smartAddDesc: '粘贴文字或语音输入，AI 自动识别并生成待办事项',
      smartAddPh: '在此粘贴或输入文字...\n例如：明天下午开会讨论项目进度，后天交周报，今天买菜做饭',
      aiParse: 'AI 解析', aiReady: 'AI 已就绪 \u2705',
      // Dynamic text
      done: '完成', isDone: '已完成', save: '保存', cancel: '取消',
      emptyList: '暂无待办事项，添加一个吧', noMatch: '没有匹配的待办事项',
      statsText: '{0} 项未完成 / 共 {1} 项',
      selected: '已选 {0} 项', breakdown: '拆解', execute: '执行',
      doneAll: '全部完成', delete: '删除', cancelSelect: '取消选择',
      selectAll: '全选', doneAllSub: '全部完成', deleteAllSub: '全部删除',
      breakingDown: '拆解中...', executing: '执行中...', planning: '规划中...',
      parsing: '解析中...',
      aiBreakdownLabel: 'AI 拆解: ', parseResult: '解析结果 ({0} 条待办)',
      addBtn: '+ 添加', added: '已添加', addAllSub: '全部添加为子任务', addAll: '全部添加',
      allAdded: '已全部添加',
      confirmDeleteSel: '确定删除选中的 {0} 项？',
      confirmDeleteSub: '确定删除全部 {0} 个子任务？',
      confirmImport: '导入将替换当前所有数据，确定继续吗？',
      importSuccess: '导入成功！共 {0} 条记录', invalidFormat: '无效的数据格式',
      fileParseFail: '文件解析失败：', aiError: 'AI 错误: ', error: '错误: ',
      recording: '正在录音...点击停止', recognizing: '识别中...',
      voiceRecorded: '语音已录入，点击 "AI 解析" 生成待办',
      noVoice: '未检测到语音内容，请重试', recognizeFail: '识别失败: ',
      micPermission: '请允许麦克风权限', micFail: '无法启动录音: ',
      parseFail: '解析失败: ', parseRetry: '解析失败，请重试',
      inputHint: '请先输入内容',
      fillEmailPwd: '请填写邮箱和密码', pwdMinLen: '密码至少6位',
      wrongCredentials: '邮箱或密码错误', alreadyRegistered: '该邮箱已注册，请直接登录',
      verifyEmail: '请先前往邮箱验证账号', pwdTooShort: '密码至少6位',
      registerSuccess: '注册成功！请前往邮箱点击验证链接后登录',
      networkError: '网络错误，请重试',
      noDateSet: '未设定日期', today: '今天', tomorrow: '明天', dayAfter: '后天',
      weekdays: ['日','一','二','三','四','五','六'],
      dateFormat: '{0}年{1}月{2}日 周{3}',
      todayPrefix: '今天 - ',
      noTodosToBreak: '请先勾选要拆解的任务', noTodosToExec: '请先勾选要执行的任务',
      noTodosPlan: '没有未完成的待办事项', weekReview: '一周回顾', reviewing: '回顾中...',
      noTodosReview: '本周没有任何任务记录',
      inputTask: '请输入要拆解的大任务：',
      execResultTitle: '\u26A1 任务执行结果', planTitle: '\u{1F4CB} 今日规划',
      ttsUnsupported: '您的浏览器不支持语音朗读'
    },
    en: {
      appTitle: 'Todo List', authSubtitle: 'Sync data to cloud after login, access from any device',
      login: 'Login', register: 'Register', email: 'Email', password: 'Password',
      passwordPh: 'At least 6 characters', checkingAuth: 'Checking login status...',
      logout: 'Logout', add: 'Add', smartAdd: 'Smart Add (Voice)',
      addTodoPh: 'Add a new todo...', searchPh: 'Search...',
      filterAll: 'All', filterActive: 'Active', filterDone: 'Done',
      allCats: 'All Categories', catWork: 'Work', catLife: 'Life', catStudy: 'Study', catOther: 'Other',
      aiTitle: 'AI Assistant', aiBreakdown: 'Plan', aiExecute: 'Execute', aiPlan: 'Daily Plan',
      export: 'Export', import: 'Import', close: 'Close',
      smartAddTitle: 'Smart Add', smartAddDesc: 'Paste text or use voice input, AI will auto-generate todos',
      smartAddPh: 'Paste or type here...\nE.g.: Meeting tomorrow afternoon, submit report day after tomorrow',
      aiParse: 'AI Parse', aiReady: 'AI Ready \u2705',
      done: 'Done', isDone: 'Completed', save: 'Save', cancel: 'Cancel',
      emptyList: 'No todos yet, add one!', noMatch: 'No matching todos',
      statsText: '{0} remaining / {1} total',
      selected: '{0} selected', breakdown: 'Breakdown', execute: 'Execute',
      doneAll: 'Complete All', delete: 'Delete', cancelSelect: 'Cancel',
      selectAll: 'Select All', doneAllSub: 'Complete All', deleteAllSub: 'Delete All',
      breakingDown: 'Breaking down...', executing: 'Executing...', planning: 'Planning...',
      parsing: 'Parsing...',
      aiBreakdownLabel: 'AI Breakdown: ', parseResult: 'Results ({0} todos)',
      addBtn: '+ Add', added: 'Added', addAllSub: 'Add All as Subtasks', addAll: 'Add All',
      allAdded: 'All Added',
      confirmDeleteSel: 'Delete {0} selected items?',
      confirmDeleteSub: 'Delete all {0} subtasks?',
      confirmImport: 'Import will replace all current data. Continue?',
      importSuccess: 'Imported {0} items', invalidFormat: 'Invalid data format',
      fileParseFail: 'File parse error: ', aiError: 'AI Error: ', error: 'Error: ',
      recording: 'Recording... click to stop', recognizing: 'Recognizing...',
      voiceRecorded: 'Voice recorded, click "AI Parse" to generate todos',
      noVoice: 'No speech detected, please try again', recognizeFail: 'Recognition failed: ',
      micPermission: 'Please allow microphone access', micFail: 'Cannot start recording: ',
      parseFail: 'Parse failed: ', parseRetry: 'Parse failed, please retry',
      inputHint: 'Please enter content first',
      fillEmailPwd: 'Please fill in email and password', pwdMinLen: 'Password must be at least 6 characters',
      wrongCredentials: 'Invalid email or password', alreadyRegistered: 'Email already registered, please login',
      verifyEmail: 'Please verify your email first', pwdTooShort: 'Password must be at least 6 characters',
      registerSuccess: 'Registration successful! Please verify your email to login',
      networkError: 'Network error, please retry',
      noDateSet: 'No date set', today: 'Today', tomorrow: 'Tomorrow', dayAfter: 'Day after',
      weekdays: ['Sun','Mon','Tue','Wed','Thu','Fri','Sat'],
      dateFormat: '{3} {1}/{2}/{0}',
      todayPrefix: 'Today - ',
      noTodosToBreak: 'Please select tasks to break down', noTodosToExec: 'Please select tasks to execute',
      noTodosPlan: 'No pending todos', weekReview: 'Weekly Review', reviewing: 'Reviewing...',
      noTodosReview: 'No tasks recorded this week',
      inputTask: 'Enter the task to break down:',
      execResultTitle: '\u26A1 Execution Results', planTitle: '\u{1F4CB} Daily Plan',
      ttsUnsupported: 'Your browser does not support text-to-speech'
    }
  };

  function T(key) {
    var args = Array.prototype.slice.call(arguments, 1);
    var s = (i18n[currentLang] && i18n[currentLang][key]) || (i18n.zh[key]) || key;
    args.forEach(function(a, i) { s = s.replace('{' + i + '}', a); });
    return s;
  }

  var CATEGORIES = { work: T('catWork'), life: T('catLife'), study: T('catStudy'), other: T('catOther') };

  function updateCATEGORIES() {
    CATEGORIES = { work: T('catWork'), life: T('catLife'), study: T('catStudy'), other: T('catOther') };
  }

  function updateLanguage(lang) {
    currentLang = lang;
    localStorage.setItem('app-lang', lang);
    updateCATEGORIES();
    // Update static elements with data-i18n
    document.querySelectorAll('[data-i18n]').forEach(function(el) {
      var key = el.getAttribute('data-i18n');
      if (i18n[lang] && i18n[lang][key]) el.textContent = i18n[lang][key];
    });
    // Update placeholders
    document.querySelectorAll('[data-i18n-ph]').forEach(function(el) {
      var key = el.getAttribute('data-i18n-ph');
      if (i18n[lang] && i18n[lang][key]) el.placeholder = i18n[lang][key];
    });
    // Update lang toggle buttons
    var toggleText = lang === 'zh' ? 'EN' : '中文';
    var authToggle = document.getElementById('authLangToggle');
    var mainToggle = document.getElementById('langToggle');
    if (authToggle) authToggle.textContent = toggleText;
    if (mainToggle) mainToggle.textContent = toggleText;
    // Update title
    document.title = T('appTitle');
    // Update AI key area
    renderKeyArea();
    // Re-render todo list
    if (currentUser) render();
  }

  // ===== Data =====
  var todos = [];

  async function loadTodosFromDB() {
    if (!supabaseClient || !currentUser) return;
    try {
      var { data, error } = await supabaseClient
        .from('todos')
        .select('*')
        .order('sort_order', { ascending: true });
      if (error) { console.error('Load error:', error); return; }
      todos = (data || []).map(function(row) {
        return {
          id: row.id,
          text: row.text,
          done: row.done || false,
          category: row.category || 'other',
          dueDate: row.due_date || '',
          createdAt: row.created_at || new Date().toISOString(),
          parentId: row.parent_id || null,
          sortOrder: row.sort_order || 0
        };
      });
      render();
    } catch(e) {
      console.error('Load error:', e);
    }
  }

  async function saveTodoDB(todo) {
    if (!supabaseClient || !currentUser) return;
    var row = {
      id: todo.id,
      user_id: currentUser.id,
      text: todo.text,
      done: todo.done,
      category: todo.category,
      due_date: todo.dueDate || '',
      parent_id: todo.parentId || null,
      sort_order: todo.sortOrder || 0
    };
    var { error } = await supabaseClient.from('todos').upsert(row);
    if (error) console.error('Save error:', error);
  }

  async function deleteTodoDB(id) {
    if (!supabaseClient || !currentUser) return;
    var { error } = await supabaseClient.from('todos').delete().eq('id', id);
    if (error) console.error('Delete error:', error);
  }

  async function updateTodoDB(id, fields) {
    if (!supabaseClient || !currentUser) return;
    var dbFields = {};
    if ('done' in fields) dbFields.done = fields.done;
    if ('text' in fields) dbFields.text = fields.text;
    if ('category' in fields) dbFields.category = fields.category;
    if ('dueDate' in fields) dbFields.due_date = fields.dueDate;
    if ('parentId' in fields) dbFields.parent_id = fields.parentId;
    if ('sortOrder' in fields) dbFields.sort_order = fields.sortOrder;
    var { error } = await supabaseClient.from('todos').update(dbFields).eq('id', id);
    if (error) console.error('Update error:', error);
  }

  async function saveAllSortOrders() {
    if (!supabaseClient || !currentUser) return;
    var promises = todos.map(function(t, i) {
      t.sortOrder = i;
      return supabaseClient.from('todos').update({ sort_order: i }).eq('id', t.id);
    });
    await Promise.all(promises);
  }

  // ===== Date Helpers =====
  function todayStr() {
    var d = new Date();
    return d.getFullYear() + '-' + String(d.getMonth()+1).padStart(2,'0') + '-' + String(d.getDate()).padStart(2,'0');
  }
  function formatDate(s) { if (!s) return ''; var p=s.split('-'); return p[1]+'/'+p[2]; }
  function formatDateFull(s) {
    if (!s) return T('noDateSet');
    var today = todayStr(), p = s.split('-');
    var wd = T('weekdays');
    var d = new Date(+p[0], +p[1]-1, +p[2]);
    var label = T('dateFormat', p[0], parseInt(p[1]), parseInt(p[2]), wd[d.getDay()]);
    if (s === today) label = T('todayPrefix') + label;
    return label;
  }
  function dateHeaderClass(s) { if(!s) return ''; var t=todayStr(); if(s<t) return 'is-overdue'; if(s===t) return 'is-today'; return ''; }
  function dueDateClass(s,done) { if(!s||done) return 'due-future'; var t=todayStr(); if(s<t) return 'due-overdue'; if(s===t) return 'due-today'; return 'due-future'; }

  // ===== AI Configuration =====
  var API_BACKEND = 'https://my-todo-api-sooty.vercel.app/api/chat';

  function renderKeyArea() { /* no-op, AI key area removed */ }

  // ===== Chat Panel Helpers =====
  function selectTask(todo) {
    // Save current task's chat before switching (exclude loading indicator)
    if (selectedTask && chatHistory.length > 0) {
      removeChatLoading();
      taskChatMap[selectedTask.id] = {
        history: chatHistory.slice(),
        html: chatMessages.innerHTML
      };
    }

    selectedTask = todo;
    chatTaskTitle.textContent = todo.text;
    chatInput.disabled = false;
    chatSendBtn.disabled = false;

    // Restore or reset chat
    var saved = taskChatMap[todo.id];
    if (saved && saved.history.length > 0) {
      chatHistory = saved.history.slice();
      chatMessages.innerHTML = saved.html;
      if (chatEmpty) chatEmpty.style.display = 'none';
    } else {
      chatMessages.innerHTML = '';
      chatHistory = [];
      var emptyDiv = document.getElementById('chatEmpty');
      if (!emptyDiv) {
        chatMessages.innerHTML = '<div class="chat-empty" id="chatEmpty">&#x2728; 点击按钮开始 AI 对话</div>';
      }
    }
    // Show loading if this task is currently executing
    if (executingTaskIds.has(todo.id)) {
      addChatLoading();
    }
    chatMessages.scrollTop = chatMessages.scrollHeight;
    render();
  }

  function addChatMessage(role, content) {
    if (chatEmpty) chatEmpty.style.display = 'none';
    var div = document.createElement('div');
    div.className = 'chat-msg ' + role;
    if (role === 'ai') {
      try { div.innerHTML = marked.parse(content); } catch(e) { div.textContent = content; }
    } else {
      div.textContent = content;
    }
    chatMessages.appendChild(div);
    chatMessages.scrollTop = chatMessages.scrollHeight;
    chatHistory.push({ role: role, content: content });
    saveChatState();
    return div;
  }

  function saveChatState() {
    if (selectedTask && chatHistory.length > 0) {
      // Remove loading indicator before saving HTML
      removeChatLoading();
      taskChatMap[selectedTask.id] = {
        history: chatHistory.slice(),
        html: chatMessages.innerHTML
      };
      // Re-add loading if task is still executing
      if (executingTaskIds.has(selectedTask.id)) {
        addChatLoading();
      }
    }
    persistChatMap();
  }

  function persistChatMap() {
    if (!currentUser) return;
    try {
      localStorage.setItem('todo-chat-' + currentUser.id, JSON.stringify(taskChatMap));
    } catch (e) {
      // localStorage quota exceeded — prune oldest entries
      var keys = Object.keys(taskChatMap);
      if (keys.length > 5) {
        delete taskChatMap[keys[0]];
        delete taskChatMap[keys[1]];
        try { localStorage.setItem('todo-chat-' + currentUser.id, JSON.stringify(taskChatMap)); } catch(e2) {}
      }
    }
  }

  function loadChatMap() {
    if (!currentUser) return;
    try {
      var raw = localStorage.getItem('todo-chat-' + currentUser.id);
      if (raw) taskChatMap = JSON.parse(raw);
      else taskChatMap = {};
    } catch (e) {
      taskChatMap = {};
    }
  }

  function deleteChatForTask(taskId) {
    if (taskChatMap[taskId]) {
      delete taskChatMap[taskId];
      persistChatMap();
    }
  }

  // Track which tasks are currently executing AI calls
  var executingTaskIds = new Set();

  function addChatLoading() {
    var div = document.createElement('div');
    div.className = 'chat-msg ai';
    div.id = 'chatLoading';
    div.textContent = '思考中...';
    div.style.opacity = '0.6';
    div.style.animation = 'pulse 1.2s ease-in-out infinite';
    chatMessages.appendChild(div);
    chatMessages.scrollTop = chatMessages.scrollHeight;
    return div;
  }

  function removeChatLoading() {
    var el = document.getElementById('chatLoading');
    if (el) el.remove();
  }

  // Render a chat history array to HTML string (for off-screen tasks)
  function renderChatHistoryHTML(history) {
    return history.map(function(msg) {
      var cls = 'chat-msg ' + msg.role;
      var inner;
      if (msg.role === 'ai') {
        try { inner = marked.parse(msg.content); } catch(e) { inner = msg.content.replace(/</g,'&lt;').replace(/>/g,'&gt;'); }
      } else {
        inner = msg.content.replace(/</g,'&lt;').replace(/>/g,'&gt;');
      }
      return '<div class="' + cls + '">' + inner + '</div>';
    }).join('');
  }


  // ===== AI API Call =====
  var SYSTEM_PROMPT = '你是一个专业的工作助手，帮助用户管理和执行待办任务。\n' +
    '要求：\n' +
    '- 直接产出成果，不要教用户怎么做\n' +
    '- 用中文回答，内容专业、详实\n' +
    '- 使用 Markdown 格式，结构清晰\n' +
    '- 回答简洁有力，避免废话和客套';

  // opts: { messages, temperature, history }
  function callAI(promptOrOpts, callback) {
    var body;
    if (typeof promptOrOpts === 'string') {
      // Legacy: simple prompt string
      body = {
        messages: [
          { role: 'system', content: SYSTEM_PROMPT },
          { role: 'user', content: promptOrOpts }
        ],
        temperature: 0.7
      };
    } else {
      // New: options object with messages, temperature, history
      var opts = promptOrOpts;
      var msgs = [{ role: 'system', content: SYSTEM_PROMPT }];
      if (opts.history && opts.history.length > 0) {
        opts.history.forEach(function(m) {
          msgs.push({ role: m.role === 'ai' ? 'assistant' : m.role, content: m.content });
        });
      }
      if (opts.messages) {
        opts.messages.forEach(function(m) { msgs.push(m); });
      }
      body = {
        messages: msgs,
        temperature: opts.temperature || 0.7
      };
    }
    fetch(API_BACKEND, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(body)
    })
    .then(function(r) { return r.json(); })
    .then(function(data) {
      if (data.error) { callback(null, data.error); return; }
      callback(data.text || '', null);
    })
    .catch(function(err) { callback(null, err.message); });
  }

  // ===== AI Feature 1: Task Breakdown (checkbox-based) =====
  function aiBreakdown() {
    var sel = getSelectedTodos();
    if (sel.length > 0) {
      // Switch chat to the first selected task
      selectTask(sel[0]);
      var taskText = sel.map(function(t) { return t.text; }).join('、');
      var parentId = sel.length === 1 ? sel[0].id : null;
      doBreakdown(taskText, parentId);
    } else {
      var task = prompt(T('inputTask'));
      if (!task) return;
      doBreakdown(task, null);
    }
  }

  function aiBreakdownSelected() {
    var sel = getSelectedTodos();
    if (sel.length === 0) { alert(T('noTodosToBreak')); return; }
    selectTask(sel[0]);
    var taskText = sel.map(function(t) { return t.text; }).join('、');
    var parentId = sel.length === 1 ? sel[0].id : null;
    doBreakdown(taskText, parentId);
  }

  function doBreakdown(task, parentId) {
    chatBreakdownBtn.disabled = true;
    chatBreakdownBtn.classList.add('loading');

    addChatMessage('user', '请拆解任务：' + task);
    var loadingEl = addChatLoading();

    var today = todayStr();
    var p = '你是一个任务管理助手。用户输入了一个大任务（可能包含多个），请将其拆解为3-7个具体的子任务。\n\n' +
      '今天日期: ' + today + '\n' +
      '任务: ' + task + '\n\n' +
      '请以JSON数组格式返回，每个子任务包含:\n' +
      '- text: 子任务描述（简洁，中文）\n' +
      '- category: 分类（work/life/study/other 之一）\n' +
      '- dueDate: 建议截止日期（YYYY-MM-DD格式，根据合理性安排）\n\n' +
      '只返回JSON数组，不要其他内容。示例:\n' +
      '[{"text":"调研竞品","category":"work","dueDate":"2026-02-10"}]';

    callAI({ messages: [{ role: 'user', content: p }], temperature: 0.3 }, function(text, err) {
      chatBreakdownBtn.disabled = false;
      chatBreakdownBtn.classList.remove('loading');
      removeChatLoading();

      if (err) { addChatMessage('ai', T('error') + err); return; }

      try {
        var match = text.match(/\[[\s\S]*\]/);
        var tasks = JSON.parse(match[0]);
        var html = '<div class="ai-result">';
        html += '<div style="font-weight:600;margin-bottom:8px;color:#7c3aed">' + T('aiBreakdownLabel') + task + '</div>';
        tasks.forEach(function(t, i) {
          html += '<div class="ai-task-item">' +
            '<span style="flex:1">' + (i+1) + '. ' + t.text +
            ' <span class="cat-badge cat-' + (t.category||'other') + '">' + (CATEGORIES[t.category]||T('catOther')) + '</span>' +
            (t.dueDate ? ' <span class="due-badge due-future">' + formatDate(t.dueDate) + '</span>' : '') +
            '</span>' +
            '<button class="ai-add-btn" data-idx="' + i + '">' + T('addBtn') + '</button></div>';
        });
        html += '<div style="margin-top:8px;text-align:right"><button class="ai-add-btn" id="aiAddAll">' + T('addAllSub') + '</button></div>';
        html += '</div>';

        var msgDiv = document.createElement('div');
        msgDiv.className = 'chat-msg ai';
        msgDiv.innerHTML = html;
        chatMessages.appendChild(msgDiv);
        chatMessages.scrollTop = chatMessages.scrollHeight;
        chatHistory.push({ role: 'ai', content: text });
        saveChatState();

        async function addSubtask(idx, btnEl) {
          var t = tasks[idx];
          var newTodo = {
            id: Date.now() + idx, text: t.text, done: false,
            category: t.category || 'other', dueDate: t.dueDate || '',
            createdAt: new Date().toISOString(), parentId: parentId || null,
            sortOrder: todos.length + idx
          };
          todos.push(newTodo);
          await saveTodoDB(newTodo);
          if (btnEl) { btnEl.textContent = T('added'); btnEl.disabled = true; btnEl.style.background = '#94a3b8'; }
        }

        msgDiv.querySelectorAll('.ai-add-btn[data-idx]').forEach(function(btn) {
          btn.addEventListener('click', async function() {
            await addSubtask(parseInt(this.getAttribute('data-idx')), this);
            render();
          });
        });

        msgDiv.querySelector('#aiAddAll').addEventListener('click', async function() {
          var btns = msgDiv.querySelectorAll('.ai-add-btn[data-idx]');
          for (var i = 0; i < tasks.length; i++) {
            if (btns[i] && btns[i].disabled) continue;
            await addSubtask(i, null);
          }
          render();
          this.textContent = T('allAdded'); this.disabled = true; this.style.background = '#94a3b8';
          msgDiv.querySelectorAll('.ai-add-btn[data-idx]').forEach(function(b) {
            b.textContent = T('added'); b.disabled = true; b.style.background = '#94a3b8';
          });
        });
      } catch(e) {
        addChatMessage('ai', text);
      }
    });
  }

  // ===== AI Feature: Task Execution (checkbox-based) =====
  // Helper: add a message to a specific task's chatMap (without touching DOM)
  function addChatToTaskMap(taskId, role, content) {
    if (!taskChatMap[taskId]) {
      taskChatMap[taskId] = { history: [], html: '' };
    }
    var entry = taskChatMap[taskId];
    entry.history.push({ role: role, content: content });
    entry.html = renderChatHistoryHTML(entry.history);
  }

  // Helper: if the given task is currently displayed, refresh the DOM from its chatMap
  function syncTaskToDOM(taskId) {
    if (!selectedTask || selectedTask.id !== taskId) return;
    var entry = taskChatMap[taskId];
    if (!entry) return;
    chatHistory = entry.history.slice();
    chatMessages.innerHTML = entry.html;
    if (executingTaskIds.has(taskId)) {
      addChatLoading();
    }
    chatMessages.scrollTop = chatMessages.scrollHeight;
  }

  function aiExecuteSelected() {
    var sel = getSelectedTodos();
    if (sel.length === 0) { alert(T('noTodosToExec')); return; }

    chatExecuteBtn.disabled = true;
    chatExecuteBtn.classList.add('loading');

    var total = sel.length;
    var idx = 0;

    // Mark all tasks as executing + add user messages upfront
    sel.forEach(function(task) {
      executingTaskIds.add(task.id);
      addChatToTaskMap(task.id, 'user', '请执行任务：' + task.text);
    });
    persistChatMap();

    // Show the first task's chat
    selectTask(sel[0]);
    chatExecuteBtn.disabled = true;
    chatExecuteBtn.classList.add('loading');

    // Process tasks one by one (avoids API rate limits)
    function processNext() {
      if (idx >= total) {
        chatExecuteBtn.disabled = false;
        chatExecuteBtn.classList.remove('loading');
        return;
      }

      var task = sel[idx];
      idx++;

      // Build prompt
      var today = todayStr();
      var taskLine = '1. ' + task.text +
        ' [分类:' + (CATEGORIES[task.category] || '其他') + ']' +
        (task.dueDate ? ' [截止:' + task.dueDate + ']' : '');

      var p = '今天日期: ' + today + '\n\n' +
        '需要执行的任务:\n' + taskLine + '\n\n' +
        '请直接产出实际可用的工作成果，不要教用户怎么做。\n' +
        '先用标题标明任务名，然后给出完整的工作成果（可以直接复制使用的程度）。\n' +
        '如果任务描述信息不足，请基于合理假设补充完整。';

      // Get existing history for this task (for context)
      var taskEntry = taskChatMap[task.id];
      var taskHist = taskEntry ? taskEntry.history.slice(-6) : [];

      // Update DOM if viewing this task (show loading)
      syncTaskToDOM(task.id);

      callAI({ messages: [{ role: 'user', content: p }], history: taskHist, temperature: 0.7 }, function(text, err) {
        var result = err ? (T('aiError') + err) : text;

        // Write result to taskChatMap (always re-fetch, never use stale ref)
        addChatToTaskMap(task.id, 'ai', result);
        executingTaskIds.delete(task.id);
        persistChatMap();

        // Refresh DOM if viewing this task
        syncTaskToDOM(task.id);

        processNext();
      });
    }

    processNext();
  }

  // ===== AI Feature 2: Daily Plan =====
  function aiDailyPlan() {
    var pending = todos.filter(function(t) { return !t.done; });
    if (pending.length === 0) { alert(T('noTodosPlan')); return; }

    chatPlanBtn.disabled = true;
    chatPlanBtn.classList.add('loading');

    addChatMessage('user', '请生成今日规划');
    addChatLoading();

    var today = todayStr();
    var todoList = pending.map(function(t) {
      return '- ' + t.text + ' [分类:' + (CATEGORIES[t.category]||'其他') + ']' +
        (t.dueDate ? ' [截止:' + t.dueDate + ']' : ' [无截止日期]');
    }).join('\n');

    var p = '今天日期: ' + today + '\n\n' +
      '待办事项:\n' + todoList + '\n\n' +
      '请生成今日行动计划:\n' +
      '1. 优先级排序（考虑截止日期紧迫性）\n' +
      '2. 时间安排（上午/下午/晚上）\n' +
      '3. 一句话激励';

    callAI({ messages: [{ role: 'user', content: p }], temperature: 0.8 }, function(text, err) {
      chatPlanBtn.disabled = false;
      chatPlanBtn.classList.remove('loading');
      removeChatLoading();

      if (err) { addChatMessage('ai', T('aiError') + err); return; }
      addChatMessage('ai', text);
    });
  }

  // ===== AI Feature 3: Weekly Review =====
  function aiWeekReview() {
    var today = new Date();
    var weekAgo = new Date(today);
    weekAgo.setDate(today.getDate() - 7);
    function fmtD(d) { return d.getFullYear() + '-' + String(d.getMonth()+1).padStart(2,'0') + '-' + String(d.getDate()).padStart(2,'0'); }
    var todayS = fmtD(today);
    var weekAgoS = fmtD(weekAgo);

    // Gather all tasks (done + pending) created or due within the past week
    var weekTasks = todos.filter(function(t) {
      var created = t.createdAt ? t.createdAt.substring(0, 10) : '';
      return created >= weekAgoS || (t.dueDate >= weekAgoS && t.dueDate <= todayS);
    });

    if (weekTasks.length === 0) { alert(T('noTodosReview')); return; }

    var completed = weekTasks.filter(function(t) { return t.done; });
    var pending = weekTasks.filter(function(t) { return !t.done; });

    chatWeekReviewBtn.disabled = true;
    chatWeekReviewBtn.classList.add('loading');

    // Clear chat for review (not tied to a specific task)
    selectedTask = null;
    chatTaskTitle.textContent = T('weekReview');
    chatMessages.innerHTML = '';
    chatHistory = [];
    chatInput.disabled = false;
    chatSendBtn.disabled = false;

    addChatMessage('user', T('weekReview') + ' (' + weekAgoS + ' ~ ' + todayS + ')');
    addChatLoading();

    var completedList = completed.length > 0
      ? completed.map(function(t) {
          return '- [x] ' + t.text + ' [' + (CATEGORIES[t.category]||T('catOther')) + ']' +
            (t.dueDate ? ' [截止:' + t.dueDate + ']' : '');
        }).join('\n')
      : '（无）';

    var pendingList = pending.length > 0
      ? pending.map(function(t) {
          return '- [ ] ' + t.text + ' [' + (CATEGORIES[t.category]||T('catOther')) + ']' +
            (t.dueDate ? ' [截止:' + t.dueDate + ']' : '');
        }).join('\n')
      : '（无）';

    var p = '今天日期: ' + todayS + '\n' +
      '回顾周期: ' + weekAgoS + ' 至 ' + todayS + '\n\n' +
      '已完成 (' + completed.length + ' 项):\n' + completedList + '\n\n' +
      '未完成 (' + pending.length + ' 项):\n' + pendingList + '\n\n' +
      '请生成一份一周工作回顾报告，包含:\n' +
      '1. 本周成果总结（按分类归纳已完成的任务）\n' +
      '2. 未完成事项分析（原因推测与建议）\n' +
      '3. 效率评估（完成率、时间分配等）\n' +
      '4. 下周改进建议\n' +
      '5. 一句话总结本周';

    callAI({ messages: [{ role: 'user', content: p }], temperature: 0.8 }, function(text, err) {
      chatWeekReviewBtn.disabled = false;
      chatWeekReviewBtn.classList.remove('loading');
      removeChatLoading();

      if (err) { addChatMessage('ai', T('aiError') + err); return; }
      addChatMessage('ai', text);
    });
  }

  // ===== Smart Add Modal =====
  function openSmartAdd() {
    smartAddText.value = '';
    smartAddResult.innerHTML = '';
    smartParseHint.textContent = '';
    smartParseHint.style.color = '';
    smartAddModal.classList.add('show');
    setTimeout(function() { smartAddText.focus(); }, 100);
  }

  function closeSmartAdd() {
    smartAddModal.classList.remove('show');
    if (isListening) stopRecording();
  }

  function smartParse() {
    var text = smartAddText.value.trim();
    if (!text) { smartParseHint.textContent = T('inputHint'); smartParseHint.style.color = '#f87171'; return; }

    smartParseBtn.disabled = true;
    smartParseBtn.innerHTML = '\u{1F916} ' + T('parsing');
    smartParseBtn.classList.add('loading');
    smartParseHint.textContent = '';
    smartParseHint.style.color = '';

    var today = todayStr();
    var d = new Date();
    var tomorrow = new Date(d); tomorrow.setDate(d.getDate()+1);
    var dayAfter = new Date(d); dayAfter.setDate(d.getDate()+2);
    function fmt(dt) { return dt.getFullYear()+'-'+String(dt.getMonth()+1).padStart(2,'0')+'-'+String(dt.getDate()).padStart(2,'0'); }

    var p = '你是一个待办事项解析助手。用户输入了一段文字，请提取所有待办事项信息。\n\n' +
      '今天日期: ' + today + '（' + fmt(d) + '）\n' +
      '明天日期: ' + fmt(tomorrow) + '\n' +
      '后天日期: ' + fmt(dayAfter) + '\n\n' +
      '用户输入: "' + text + '"\n\n' +
      '请提取并返回JSON（可能包含多个待办）:\n' +
      '{"items":[{"text":"任务描述","dueDate":"YYYY-MM-DD","category":"work/life/study/other"}]}\n\n' +
      '规则:\n' +
      '- text: 简洁的任务描述，去掉时间词（今天、明天、后天、下周等）\n' +
      '- dueDate: 根据文字中的时间词推算具体日期。"今天"=' + today + '，"明天"=' + fmt(tomorrow) + '，"后天"=' + fmt(dayAfter) + '。"下周X"请计算具体日期。没提到时间就默认填今天(' + today + ')\n' +
      '- category: work(工作/开会/项目/汇报), life(生活/买/吃/运动), study(学习/看书/课程), other(其他)\n' +
      '- 如果内容包含多个任务，拆分为多个items\n' +
      '- 如果只有一个任务也要返回数组格式\n\n' +
      '只返回JSON，不要其他内容。';

    callAI({ messages: [{ role: 'user', content: p }], temperature: 0.3 }, function(result, err) {
      smartParseBtn.disabled = false;
      smartParseBtn.innerHTML = '\u{1F916} <span data-i18n="aiParse">' + T('aiParse') + '</span>';
      smartParseBtn.classList.remove('loading');

      if (err) {
        smartParseHint.textContent = T('parseFail') + err;
        smartParseHint.style.color = '#f87171';
        return;
      }

      try {
        var match = result.match(/\{[\s\S]*\}/);
        var data = JSON.parse(match[0]);
        var items = data.items || [];
        if (items.length === 0) throw new Error('empty');
        renderSmartResults(items);
      } catch(e) {
        smartParseHint.textContent = T('parseRetry');
        smartParseHint.style.color = '#f87171';
      }
    });
  }

  function renderSmartResults(items) {
    var today = todayStr();
    var d = new Date();
    var tomorrow = new Date(d); tomorrow.setDate(d.getDate()+1);
    var dayAfter = new Date(d); dayAfter.setDate(d.getDate()+2);
    function fmt(dt) { return dt.getFullYear()+'-'+String(dt.getMonth()+1).padStart(2,'0')+'-'+String(dt.getDate()).padStart(2,'0'); }

    var html = '<div class="ai-result" style="margin-top:12px">';
    html += '<div style="font-weight:600;margin-bottom:8px;color:#7c3aed">' + T('parseResult', items.length) + '</div>';

    items.forEach(function(item, i) {
      var dateLabel = '';
      if (item.dueDate) {
        if (item.dueDate === today) dateLabel = T('today');
        else if (item.dueDate === fmt(tomorrow)) dateLabel = T('tomorrow');
        else if (item.dueDate === fmt(dayAfter)) dateLabel = T('dayAfter');
        else dateLabel = formatDate(item.dueDate);
      }
      html += '<div class="ai-task-item">' +
        '<span style="flex:1">' + (i+1) + '. ' + item.text +
        ' <span class="cat-badge cat-' + (item.category||'other') + '">' + (CATEGORIES[item.category]||T('catOther')) + '</span>' +
        (dateLabel ? ' <span class="due-badge ' + dueDateClass(item.dueDate, false) + '">' + dateLabel + '</span>' : '') +
        '</span>' +
        '<button class="ai-add-btn" data-sidx="' + i + '">' + T('addBtn') + '</button></div>';
    });

    html += '<div style="margin-top:10px;text-align:right">' +
      '<button class="ai-add-btn" id="smartAddAllBtn" style="padding:5px 16px;font-size:12px">' + T('addAll') + '</button></div>';
    html += '</div>';

    smartAddResult.innerHTML = html;
    smartParseHint.textContent = '';
    smartParseHint.style.color = '';

    smartAddResult.querySelectorAll('.ai-add-btn[data-sidx]').forEach(function(btn) {
      btn.addEventListener('click', async function() {
        var idx = parseInt(this.getAttribute('data-sidx'));
        var item = items[idx];
        var newTodo = {
          id: Date.now() + idx, text: item.text, done: false,
          category: item.category || 'other', dueDate: item.dueDate || todayStr(),
          createdAt: new Date().toISOString(), parentId: null,
          sortOrder: todos.length
        };
        todos.push(newTodo);
        await saveTodoDB(newTodo);
        render();
        this.textContent = T('added'); this.disabled = true; this.style.background = '#94a3b8';
      });
    });

    document.getElementById('smartAddAllBtn').addEventListener('click', async function() {
      var btns = smartAddResult.querySelectorAll('.ai-add-btn[data-sidx]');
      for (var i = 0; i < items.length; i++) {
        if (btns[i] && btns[i].disabled) continue;
        var item = items[i];
        var newTodo = {
          id: Date.now() + i, text: item.text, done: false,
          category: item.category || 'other', dueDate: item.dueDate || todayStr(),
          createdAt: new Date().toISOString(), parentId: null,
          sortOrder: todos.length + i
        };
        todos.push(newTodo);
        await saveTodoDB(newTodo);
      }
      render();
      this.textContent = T('allAdded'); this.disabled = true; this.style.background = '#94a3b8';
      smartAddResult.querySelectorAll('.ai-add-btn[data-sidx]').forEach(function(b) {
        b.textContent = T('added'); b.disabled = true; b.style.background = '#94a3b8';
      });
    });
  }

  // ===== Filtering =====
  function getFiltered() {
    var search = searchInput.value.trim().toLowerCase();
    var cat = catFilter.value;
    return todos.filter(function(todo) {
      if (currentFilter === 'active' && todo.done) return false;
      if (currentFilter === 'done' && !todo.done) return false;
      if (cat !== 'all' && todo.category !== cat) return false;
      if (search && todo.text.toLowerCase().indexOf(search) === -1) return false;
      return true;
    });
  }

  // ===== Selection =====
  function getSelectedTodos() {
    return todos.filter(function(t) { return selectedIds.has(t.id); });
  }

  function renderSelectBar() {
    var count = selectedIds.size;
    chatExecuteBtn.disabled = (count === 0);
    chatBreakdownBtn.disabled = (count === 0);
    if (count === 0) { selectBar.style.display = 'none'; return; }
    selectBar.style.display = 'flex';
    selectBar.innerHTML =
      '<span class="select-count">' + T('selected', count) + '</span>' +
      '<button class="select-action" id="selBreakdown">&#127919; ' + T('breakdown') + '</button>' +
      '<button class="select-action" id="selExecute">&#9889; ' + T('execute') + '</button>' +
      '<button class="select-action" id="selDone">&#x2705; ' + T('doneAll') + '</button>' +
      '<button class="select-action danger" id="selDelete">&#x2715; ' + T('delete') + '</button>' +
      '<button class="select-cancel" id="selClear">' + T('cancelSelect') + '</button>';
    document.getElementById('selBreakdown').addEventListener('click', function() { aiBreakdownSelected(); });
    document.getElementById('selExecute').addEventListener('click', function() {
      aiExecuteSelected();
    });
    document.getElementById('selDone').addEventListener('click', async function() {
      var sel = getSelectedTodos();
      for (var i = 0; i < sel.length; i++) {
        sel[i].done = true;
        await updateTodoDB(sel[i].id, { done: true });
      }
      selectedIds.clear(); render();
    });
    document.getElementById('selDelete').addEventListener('click', async function() {
      if (!confirm(T('confirmDeleteSel', count))) return;
      var ids = new Set(selectedIds);
      var toDelete = todos.filter(function(t) { return ids.has(t.id) || ids.has(t.parentId); });
      for (var i = 0; i < toDelete.length; i++) {
        await deleteTodoDB(toDelete[i].id);
        deleteChatForTask(toDelete[i].id);
      }
      todos = todos.filter(function(t) { return !ids.has(t.id) && !ids.has(t.parentId); });
      selectedIds.clear(); render();
    });
    document.getElementById('selClear').addEventListener('click', function() {
      selectedIds.clear(); render();
    });
  }

  // ===== Render =====
  function render() {
    listEl.innerHTML = '';
    var filtered = getFiltered();

    if (todos.length === 0) {
      listEl.innerHTML = '<li class="empty">' + T('emptyList') + '</li>';
      statsEl.textContent = '';
      return;
    }
    if (filtered.length === 0) {
      listEl.innerHTML = '<li class="empty">' + T('noMatch') + '</li>';
      var r = todos.filter(function(t){return !t.done;}).length;
      statsEl.textContent = T('statsText', r, todos.length);
      return;
    }

    var parents = filtered.filter(function(t) { return !t.parentId; });
    var childMap = {};
    filtered.forEach(function(t) {
      if (t.parentId) {
        if (!childMap[t.parentId]) childMap[t.parentId] = [];
        childMap[t.parentId].push(t);
      }
    });

    var sorted = parents.slice().sort(function(a,b) {
      var da = a.dueDate || '\uffff', db = b.dueDate || '\uffff';
      return da < db ? -1 : da > db ? 1 : 0;
    });

    var lastDate = null;
    sorted.forEach(function(todo) {
      var dateKey = todo.dueDate || '';

      if (dateKey !== lastDate) {
        lastDate = dateKey;
        var header = document.createElement('li');
        header.className = 'date-header';
        var lbl = document.createElement('span');
        lbl.className = 'date-header-label ' + dateHeaderClass(dateKey);
        lbl.textContent = formatDateFull(dateKey);
        var ln = document.createElement('span');
        ln.className = 'date-header-line';
        header.appendChild(lbl);
        header.appendChild(ln);
        listEl.appendChild(header);
      }

      appendTodoLi(todo, false);
      var children = childMap[todo.id] || [];
      children.forEach(function(child) { appendTodoLi(child, true); });
      if (children.length > 0) {
        appendSubtaskActions(todo.id, children);
      }
    });

    function appendSubtaskActions(parentId, children) {
      var bar = document.createElement('li');
      bar.className = 'subtask-actions';

      var selAllBtn = document.createElement('button');
      selAllBtn.className = 'sub-action-btn';
      selAllBtn.textContent = '\u2610 ' + T('selectAll');
      selAllBtn.addEventListener('click', function() {
        var allSelected = children.every(function(c) { return selectedIds.has(c.id); });
        children.forEach(function(c) {
          if (allSelected) selectedIds.delete(c.id); else selectedIds.add(c.id);
        });
        render();
      });

      var doneAllBtn = document.createElement('button');
      doneAllBtn.className = 'sub-action-btn';
      doneAllBtn.textContent = '\u2705 ' + T('doneAllSub');
      doneAllBtn.addEventListener('click', async function() {
        for (var i = 0; i < children.length; i++) {
          children[i].done = true;
          await updateTodoDB(children[i].id, { done: true });
        }
        render();
      });

      var delAllBtn = document.createElement('button');
      delAllBtn.className = 'sub-action-btn danger';
      delAllBtn.textContent = '\u2715 ' + T('deleteAllSub');
      delAllBtn.addEventListener('click', async function() {
        if (!confirm(T('confirmDeleteSub', children.length))) return;
        for (var i = 0; i < children.length; i++) {
          await deleteTodoDB(children[i].id);
          deleteChatForTask(children[i].id);
        }
        var childIds = new Set(children.map(function(c) { return c.id; }));
        todos = todos.filter(function(t) { return !childIds.has(t.id); });
        childIds.forEach(function(id) { selectedIds.delete(id); });
        render();
      });

      bar.appendChild(selAllBtn);
      bar.appendChild(doneAllBtn);
      bar.appendChild(delAllBtn);
      listEl.appendChild(bar);
    }

    function appendTodoLi(todo, isSubtask) {
      var realIndex = todos.indexOf(todo);
      var li = document.createElement('li');
      li.className = 'todo-item' + (isSubtask ? ' subtask' : '') + (selectedTask && selectedTask.id === todo.id ? ' selected-task' : '');
      li.setAttribute('data-index', realIndex);
      var isEditing = editingId === todo.id;

      if (!isEditing) {
        li.setAttribute('draggable', 'true');
        li.addEventListener('dragstart', handleDragStart);
        li.addEventListener('dragover', handleDragOver);
        li.addEventListener('dragleave', handleDragLeave);
        li.addEventListener('drop', handleDrop);
        li.addEventListener('dragend', handleDragEnd);

        var chk = document.createElement('input');
        chk.type = 'checkbox';
        chk.className = 'todo-checkbox';
        chk.checked = selectedIds.has(todo.id);
        (function(tid) {
          chk.addEventListener('change', function() {
            if (this.checked) selectedIds.add(tid); else selectedIds.delete(tid);
            renderSelectBar();
          });
        })(todo.id);

        var handle = document.createElement('span');
        handle.className = 'drag-handle';
        handle.textContent = '\u2807';

        var content = document.createElement('div');
        content.className = 'item-content';
        content.style.cursor = 'pointer';
        (function(t) {
          content.addEventListener('click', function() { selectTask(t); });
        })(todo);
        var textSpan = document.createElement('span');
        textSpan.className = 'todo-text' + (todo.done ? ' done' : '');
        textSpan.textContent = todo.text;
        var meta = document.createElement('div');
        meta.className = 'item-meta';
        var catBadge = document.createElement('span');
        catBadge.className = 'cat-badge cat-' + todo.category;
        catBadge.textContent = CATEGORIES[todo.category] || T('catOther');
        meta.appendChild(catBadge);
        content.appendChild(textSpan);
        content.appendChild(meta);

        var compBtn = document.createElement('button');
        compBtn.className = 'complete-btn' + (todo.done ? ' is-done' : '');
        compBtn.textContent = todo.done ? T('isDone') : T('done');
        compBtn.addEventListener('click', async function() {
          todo.done = !todo.done;
          await updateTodoDB(todo.id, { done: todo.done });
          render();
        });

        var eb = document.createElement('button');
        eb.className = 'edit-btn';
        eb.innerHTML = '&#9998;';
        eb.addEventListener('click', function() { editingId = todo.id; render(); });

        var db = document.createElement('button');
        db.className = 'del-btn';
        db.innerHTML = '&#x2715;';
        db.addEventListener('click', async function() {
          var tid = todo.id;
          var children = todos.filter(function(t) { return t.parentId === tid; });
          await deleteTodoDB(tid);
          for (var i = 0; i < children.length; i++) {
            await deleteTodoDB(children[i].id);
            deleteChatForTask(children[i].id);
          }
          deleteChatForTask(tid);
          todos = todos.filter(function(t) { return t.id !== tid && t.parentId !== tid; });
          selectedIds.delete(tid); render();
        });

        li.appendChild(chk);
        li.appendChild(handle);
        li.appendChild(content);
        li.appendChild(compBtn);
        li.appendChild(eb);
        li.appendChild(db);
      } else {
        var er = document.createElement('div');
        er.className = 'edit-row';
        var et = document.createElement('input'); et.type='text'; et.value=todo.text;
        var ed = document.createElement('input'); ed.type='date'; ed.value=todo.dueDate||'';
        var ec = document.createElement('select');
        CAT_KEYS.forEach(function(k){ var o=document.createElement('option'); o.value=k; o.textContent=CATEGORIES[k]; if(todo.category===k) o.selected=true; ec.appendChild(o); });
        var sb = document.createElement('button'); sb.className='save-edit-btn'; sb.textContent=T('save');
        sb.addEventListener('click', async function(){
          var v=et.value.trim(); if(!v)return;
          todo.text=v; todo.dueDate=ed.value||''; todo.category=ec.value;
          editingId=null;
          await updateTodoDB(todo.id, { text: v, dueDate: ed.value||'', category: ec.value });
          render();
        });
        var cb2 = document.createElement('button'); cb2.className='cancel-edit-btn'; cb2.textContent=T('cancel');
        cb2.addEventListener('click', function(){ editingId=null; render(); });
        et.addEventListener('keydown', function(e){ if(e.key==='Enter') sb.click(); if(e.key==='Escape') cb2.click(); });
        er.appendChild(et); er.appendChild(ed); er.appendChild(ec); er.appendChild(sb); er.appendChild(cb2);
        li.appendChild(er);
        setTimeout(function(){ et.focus(); et.select(); }, 0);
      }
      listEl.appendChild(li);
    }

    var remaining = todos.filter(function(t){return !t.done;}).length;
    statsEl.textContent = T('statsText', remaining, todos.length);
    renderSelectBar();
  }

  // ===== Add Todo =====
  async function addTodo() {
    var text = input.value.trim();
    if (!text) return;
    var newTodo = {
      id: Date.now(), text: text, done: false,
      category: categoryInput.value, dueDate: dueDateInput.value || '',
      createdAt: new Date().toISOString(), parentId: null,
      sortOrder: todos.length
    };
    todos.push(newTodo);
    input.value = '';
    dueDateInput.value = '';
    render();
    input.focus();
    await saveTodoDB(newTodo);
  }

  // ===== Drag & Drop =====
  function handleDragStart(e) { dragSrcIndex=parseInt(this.getAttribute('data-index')); this.classList.add('dragging'); e.dataTransfer.effectAllowed='move'; e.dataTransfer.setData('text/plain',dragSrcIndex); }
  function handleDragOver(e) { e.preventDefault(); e.dataTransfer.dropEffect='move'; this.classList.add('drag-over'); }
  function handleDragLeave() { this.classList.remove('drag-over'); }
  async function handleDrop(e) {
    e.preventDefault(); this.classList.remove('drag-over');
    var t=parseInt(this.getAttribute('data-index'));
    if(dragSrcIndex===null||dragSrcIndex===t) return;
    var item=todos.splice(dragSrcIndex,1)[0];
    todos.splice(t,0,item);
    render();
    await saveAllSortOrders();
  }
  function handleDragEnd() { this.classList.remove('dragging'); dragSrcIndex=null; listEl.querySelectorAll('.todo-item').forEach(function(i){i.classList.remove('drag-over');}); }

  // ===== Export / Import =====
  function exportData() {
    var blob = new Blob([JSON.stringify(todos,null,2)], {type:'application/json'});
    var url = URL.createObjectURL(blob);
    var a = document.createElement('a'); a.href=url; a.download='my-todo-backup.json';
    document.body.appendChild(a); a.click(); document.body.removeChild(a); URL.revokeObjectURL(url);
  }
  async function importData(file) {
    var reader = new FileReader();
    reader.onload = async function(e) {
      try {
        var data = JSON.parse(e.target.result);
        if (!Array.isArray(data)) { alert(T('invalidFormat')); return; }
        if (!confirm(T('confirmImport'))) return;

        // Delete all existing todos from DB + chat history
        for (var i = 0; i < todos.length; i++) {
          await deleteTodoDB(todos[i].id);
        }
        taskChatMap = {};
        persistChatMap();

        todos = data.map(function(item,idx) {
          if(!item.id) item.id=Date.now()+idx; if(!item.category) item.category='other';
          if(item.dueDate===undefined) item.dueDate=''; if(!item.createdAt) item.createdAt=new Date().toISOString();
          if(item.done===undefined) item.done=false; if(!item.text) item.text='';
          if(item.parentId===undefined) item.parentId=null;
          item.sortOrder = idx;
          return item;
        });

        // Save all to DB
        for (var j = 0; j < todos.length; j++) {
          await saveTodoDB(todos[j]);
        }

        render();
        alert(T('importSuccess', todos.length));
      } catch(err) { alert(T('fileParseFail') + err.message); }
    };
    reader.readAsText(file);
  }

  // ===== Voice Input (Web Speech API + MediaRecorder fallback) =====
  var WHISPER_BACKEND = 'https://my-todo-api-sooty.vercel.app/api/whisper';
  var mediaRecorder = null;
  var audioChunks = [];
  var isListening = false;
  var recognition = null;
  var voiceBaseText = '';

  var SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;

  function toggleSmartVoice() {
    if (isListening) {
      if (recognition) {
        stopSpeechRecognition();
      } else {
        stopRecording();
      }
    } else {
      if (SpeechRecognition) {
        startSpeechRecognition();
      } else {
        startRecording();
      }
    }
  }

  // --- Web Speech API ---
  function startSpeechRecognition() {
    try {
      recognition = new SpeechRecognition();
    } catch(e) {
      // SpeechRecognition constructor failed, fall back
      recognition = null;
      startRecording();
      return;
    }
    recognition.continuous = true;
    recognition.interimResults = true;
    recognition.maxAlternatives = 1;
    recognition.lang = currentLang === 'zh' ? 'zh-CN' : 'en-US';

    voiceBaseText = smartAddText.value;

    recognition.onresult = function(event) {
      var finalText = '';
      var interimText = '';
      for (var i = 0; i < event.results.length; i++) {
        var t = event.results[i][0].transcript;
        if (event.results[i].isFinal) {
          finalText += t;
        } else {
          interimText += t;
        }
      }
      var fullTranscript = (finalText + interimText).trim();
      if (fullTranscript) {
        var sep = '';
        if (voiceBaseText && !voiceBaseText.endsWith('\n') && !voiceBaseText.endsWith('，') && !voiceBaseText.endsWith('。') && !voiceBaseText.endsWith(',') && !voiceBaseText.endsWith('.')) {
          sep = currentLang === 'zh' ? '，' : ', ';
        }
        smartAddText.value = voiceBaseText + sep + fullTranscript;
        smartAddText.scrollTop = smartAddText.scrollHeight;
        // Show real-time hint
        if (interimText) {
          smartParseHint.textContent = currentLang === 'zh' ? '正在听...' : 'Listening...';
          smartParseHint.style.color = '#7c3aed';
        } else {
          smartParseHint.textContent = currentLang === 'zh' ? '✓ 已识别，继续说话...' : '✓ Got it, keep talking...';
          smartParseHint.style.color = '#16a34a';
        }
      }
    };

    recognition.onend = function() {
      // If user didn't manually stop, restart (some browsers auto-stop)
      if (isListening) {
        try { recognition.start(); } catch(e) {}
        return;
      }
      smartMicBtn.classList.remove('listening');
      smartMicBtn.innerHTML = '&#127908;';
      if (smartAddText.value.trim() !== voiceBaseText.trim()) {
        smartParseHint.textContent = T('voiceRecorded');
        smartParseHint.style.color = '#16a34a';
      } else {
        smartParseHint.textContent = T('noVoice');
        smartParseHint.style.color = '#f87171';
      }
      recognition = null;
    };

    recognition.onerror = function(event) {
      // 'no-speech' is non-fatal when continuous, just keep going
      if (event.error === 'no-speech' && isListening) return;
      isListening = false;
      smartMicBtn.classList.remove('listening');
      smartMicBtn.innerHTML = '&#127908;';
      recognition = null;
      if (event.error === 'not-allowed') {
        smartParseHint.textContent = T('micPermission');
      } else if (event.error === 'no-speech') {
        smartParseHint.textContent = T('noVoice');
      } else {
        smartParseHint.textContent = T('recognizeFail') + event.error;
      }
      smartParseHint.style.color = '#f87171';
    };

    try {
      recognition.start();
      isListening = true;
      smartMicBtn.classList.add('listening');
      smartParseHint.textContent = currentLang === 'zh' ? '请说话...' : 'Speak now...';
      smartParseHint.style.color = '#7c3aed';
    } catch(e) {
      recognition = null;
      startRecording();
    }
  }

  function stopSpeechRecognition() {
    isListening = false;
    if (recognition) {
      try { recognition.stop(); } catch(e) {}
    }
  }

  // --- MediaRecorder fallback (for browsers without Web Speech API) ---
  async function startRecording() {
    try {
      var stream = await navigator.mediaDevices.getUserMedia({ audio: true });
      audioChunks = [];
      mediaRecorder = new MediaRecorder(stream, { mimeType: 'audio/webm' });

      mediaRecorder.ondataavailable = function(e) {
        if (e.data.size > 0) audioChunks.push(e.data);
      };

      mediaRecorder.onstop = async function() {
        stream.getTracks().forEach(function(t) { t.stop(); });
        if (audioChunks.length === 0) return;

        smartMicBtn.classList.remove('listening');
        smartMicBtn.innerHTML = '&#8987;';
        smartParseHint.textContent = T('recognizing');
        smartParseHint.style.color = '#7c3aed';

        try {
          var blob = new Blob(audioChunks, { type: 'audio/webm' });
          var reader = new FileReader();
          reader.onloadend = async function() {
            var base64 = reader.result.split(',')[1];
            var resp = await fetch(WHISPER_BACKEND, {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ audio: base64 })
            });
            var data = await resp.json();
            if (data.error) {
              smartParseHint.textContent = T('recognizeFail') + data.error;
              smartParseHint.style.color = '#f87171';
              smartMicBtn.innerHTML = '&#127908;';
              return;
            }
            var transcript = (data.text || '').trim();
            if (transcript) {
              var current = smartAddText.value;
              var sep = '';
              if (current && !current.endsWith('\n') && !current.endsWith('，') && !current.endsWith('。') && !current.endsWith(',') && !current.endsWith('.')) {
                sep = currentLang === 'zh' ? '，' : ', ';
              }
              smartAddText.value = current + sep + transcript;
              smartParseHint.textContent = T('voiceRecorded');
              smartParseHint.style.color = '#16a34a';
            } else {
              smartParseHint.textContent = T('noVoice');
              smartParseHint.style.color = '#f87171';
            }
            smartMicBtn.innerHTML = '&#127908;';
          };
          reader.readAsDataURL(blob);
        } catch(e) {
          smartParseHint.textContent = T('recognizeFail') + e.message;
          smartParseHint.style.color = '#f87171';
          smartMicBtn.innerHTML = '&#127908;';
        }
      };

      mediaRecorder.start();
      isListening = true;
      smartMicBtn.classList.add('listening');
      smartParseHint.textContent = T('recording');
      smartParseHint.style.color = '#7c3aed';
    } catch(e) {
      if (e.name === 'NotAllowedError') {
        smartParseHint.textContent = T('micPermission');
      } else {
        smartParseHint.textContent = T('micFail') + e.message;
      }
      smartParseHint.style.color = '#f87171';
    }
  }

  function stopRecording() {
    isListening = false;
    if (mediaRecorder && mediaRecorder.state !== 'inactive') {
      mediaRecorder.stop();
    }
  }

  // ===== Chat Follow-up =====
  function chatSendFollowUp() {
    var text = chatInput.value.trim();
    if (!text) return;
    chatInput.value = '';

    addChatMessage('user', text);
    addChatLoading();

    // Build user message with task context
    var userMsg = text;
    if (selectedTask) {
      userMsg = '（当前任务: ' + selectedTask.text + '）\n' + text;
    }

    // Send with full chat history for context
    callAI({
      messages: [{ role: 'user', content: userMsg }],
      history: chatHistory.slice(-10),
      temperature: 0.7
    }, function(result, err) {
      removeChatLoading();
      if (err) { addChatMessage('ai', T('error') + err); return; }
      addChatMessage('ai', result);
    });
  }

  // ===== Export Functions =====
  function exportWord() {
    var content = chatMessages.innerHTML;
    if (!content || chatMessages.querySelectorAll('.chat-msg').length === 0) return;
    var html = '<html xmlns:o="urn:schemas-microsoft-com:office:office" xmlns:w="urn:schemas-microsoft-com:office:word" xmlns="http://www.w3.org/TR/REC-html40"><head><meta charset="utf-8"><style>body{font-family:sans-serif;font-size:14px;line-height:1.7}.chat-msg{margin:10px 0;padding:10px;border-radius:8px}.chat-msg.user{background:#ede9fe;text-align:right}.chat-msg.ai{background:#f8fafc;border:1px solid #e2e8f0}table{border-collapse:collapse;width:100%}th,td{border:1px solid #ccc;padding:6px 10px}</style></head><body>' + content + '</body></html>';
    var blob = new Blob(['\ufeff' + html], { type: 'application/msword' });
    var url = URL.createObjectURL(blob);
    var a = document.createElement('a');
    a.href = url;
    a.download = (selectedTask ? selectedTask.text.substring(0, 20) : 'chat') + '.doc';
    document.body.appendChild(a); a.click(); document.body.removeChild(a); URL.revokeObjectURL(url);
  }

  function exportPdf() {
    if (chatMessages.querySelectorAll('.chat-msg').length === 0) return;
    var opt = {
      margin: 10,
      filename: (selectedTask ? selectedTask.text.substring(0, 20) : 'chat') + '.pdf',
      image: { type: 'jpeg', quality: 0.98 },
      html2canvas: { scale: 2 },
      jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' }
    };
    html2pdf().set(opt).from(chatMessages).save();
  }

  // ===== Event Listeners =====
  addBtn.addEventListener('click', addTodo);
  input.addEventListener('keydown', function(e) { if(e.key==='Enter') addTodo(); });

  smartAddBtn.addEventListener('click', openSmartAdd);
  smartMicBtn.addEventListener('click', toggleSmartVoice);
  smartParseBtn.addEventListener('click', smartParse);
  smartAddClose.addEventListener('click', closeSmartAdd);

  document.querySelectorAll('.filter-btn').forEach(function(btn) {
    btn.addEventListener('click', function() {
      document.querySelectorAll('.filter-btn').forEach(function(b){b.classList.remove('active');});
      btn.classList.add('active');
      currentFilter = btn.getAttribute('data-filter');
      render();
    });
  });

  searchInput.addEventListener('input', render);
  catFilter.addEventListener('change', render);

  exportBtn.addEventListener('click', exportData);
  importBtn.addEventListener('click', function() { importFile.click(); });
  importFile.addEventListener('change', function() { if(this.files&&this.files[0]){importData(this.files[0]);this.value='';} });

  // Chat panel buttons
  chatBreakdownBtn.addEventListener('click', aiBreakdown);
  chatExecuteBtn.addEventListener('click', function() { aiExecuteSelected(); });
  chatPlanBtn.addEventListener('click', aiDailyPlan);
  chatWeekReviewBtn.addEventListener('click', aiWeekReview);
  chatSendBtn.addEventListener('click', chatSendFollowUp);
  chatInput.addEventListener('keydown', function(e) { if(e.key==='Enter') chatSendFollowUp(); });
  exportWordBtn.addEventListener('click', exportWord);
  exportPdfBtn.addEventListener('click', exportPdf);

  // ===== Scroll-down buttons =====
  var leftScrollBtn = document.getElementById('leftScrollBtn');
  var rightScrollBtn = document.getElementById('rightScrollBtn');

  function updateScrollBtn(scrollEl, btn) {
    if (!scrollEl || !btn) return;
    var gap = scrollEl.scrollHeight - scrollEl.scrollTop - scrollEl.clientHeight;
    if (gap > 80) {
      btn.classList.add('show');
    } else {
      btn.classList.remove('show');
    }
  }

  listEl.addEventListener('scroll', function() { updateScrollBtn(listEl, leftScrollBtn); });
  chatMessages.addEventListener('scroll', function() { updateScrollBtn(chatMessages, rightScrollBtn); });

  leftScrollBtn.addEventListener('click', function() {
    listEl.scrollTo({ top: listEl.scrollHeight, behavior: 'smooth' });
  });
  rightScrollBtn.addEventListener('click', function() {
    chatMessages.scrollTo({ top: chatMessages.scrollHeight, behavior: 'smooth' });
  });

  // Re-check scroll buttons after render
  var _origRender = render;
  render = function() {
    _origRender();
    setTimeout(function() { updateScrollBtn(listEl, leftScrollBtn); }, 50);
  };

  renderKeyArea();

  // ===== Init =====
  // Apply saved language preference
  if (currentLang !== 'zh') {
    updateLanguage(currentLang);
  }
  checkAuth();
})();
</script>

</body>
</html>
