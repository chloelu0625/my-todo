<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>å¾…åŠäº‹é¡¹</title>
<style>
  * { margin: 0; padding: 0; box-sizing: border-box; }

  body {
    font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
    background: linear-gradient(135deg, #e0f2fe 0%, #f0fdf4 50%, #fef9c3 100%);
    min-height: 100vh;
    display: flex;
    justify-content: center;
    padding: 40px 16px;
  }

  .container { width: 100%; max-width: 580px; align-self: flex-start; }

  .card {
    background: #fff;
    border-radius: 16px;
    box-shadow: 0 8px 30px rgba(0,0,0,0.08), inset 0 1px 0 rgba(255,255,255,0.6);
    padding: 32px 28px;
  }

  h1 { font-size: 26px; font-weight: 700; color: #1e293b; text-align: center; margin-bottom: 24px; }

  /* ===== Input Row ===== */
  .input-row { display: flex; gap: 8px; margin-bottom: 12px; flex-wrap: wrap; }
  .input-row input[type="text"] {
    flex: 1; min-width: 160px; padding: 10px 14px; border: 2px solid #e2e8f0;
    border-radius: 10px; font-size: 15px; outline: none; transition: border-color 0.2s;
  }
  .input-row input[type="text"]:focus { border-color: #60a5fa; }
  .input-row input[type="date"] {
    padding: 10px 10px; border: 2px solid #e2e8f0; border-radius: 10px; font-size: 13px;
    outline: none; transition: border-color 0.2s; color: #64748b; max-width: 150px;
  }
  .input-row input[type="date"]:focus { border-color: #60a5fa; }
  .input-row select {
    padding: 10px 10px; border: 2px solid #e2e8f0; border-radius: 10px; font-size: 13px;
    outline: none; background: #fff; cursor: pointer; color: #64748b; transition: border-color 0.2s;
  }
  .input-row select:focus { border-color: #60a5fa; }
  .input-row .add-btn {
    padding: 10px 18px; background: #3b82f6; color: #fff; border: none; border-radius: 10px;
    font-size: 15px; font-weight: 600; cursor: pointer; transition: background 0.2s; white-space: nowrap;
  }
  .input-row .add-btn:hover { background: #2563eb; }
  .mic-btn {
    padding: 10px 14px; background: #f1f5f9; border: 2px solid #e2e8f0; border-radius: 10px;
    font-size: 16px; cursor: pointer; transition: all 0.2s; line-height: 1; flex-shrink: 0;
  }
  .mic-btn:hover { background: #e2e8f0; }
  .mic-btn.listening { background: #fee2e2; border-color: #fca5a5; animation: pulse 1s ease-in-out infinite; }
  .mic-btn.unsupported { opacity: 0.3; cursor: not-allowed; }
  .speak-btn {
    background: none; border: none; font-size: 16px; cursor: pointer; padding: 2px 6px;
    opacity: 0.5; transition: opacity 0.2s; vertical-align: middle;
  }
  .speak-btn:hover { opacity: 1; }
  .speak-btn.speaking { opacity: 1; animation: pulse 1s ease-in-out infinite; }
  .smart-add-trigger {
    padding: 10px 14px; background: #f5f3ff; border: 2px solid #c4b5fd; border-radius: 10px;
    font-size: 15px; cursor: pointer; color: #7c3aed; font-weight: 600; transition: all 0.2s;
    white-space: nowrap; line-height: 1; flex-shrink: 0;
  }
  .smart-add-trigger:hover { background: #ede9fe; border-color: #a78bfa; }
  .smart-modal-textarea {
    width: 100%; min-height: 120px; padding: 12px; padding-right: 50px; border: 2px solid #e2e8f0;
    border-radius: 10px; font-size: 14px; resize: vertical; outline: none; font-family: inherit;
    transition: border-color 0.2s; line-height: 1.6;
  }
  .smart-modal-textarea:focus { border-color: #a78bfa; }
  .smart-modal-actions { display: flex; gap: 10px; margin-top: 12px; align-items: center; }
  .smart-parse-btn {
    padding: 8px 20px; background: #7c3aed; color: #fff; border: none; border-radius: 8px;
    font-size: 14px; font-weight: 600; cursor: pointer; transition: background 0.2s;
  }
  .smart-parse-btn:hover { background: #6d28d9; }
  .smart-parse-btn:disabled { opacity: 0.5; cursor: not-allowed; }
  .smart-parse-btn.loading { animation: pulse 1.2s ease-in-out infinite; }
  .smart-parse-hint { font-size: 12px; color: #94a3b8; }

  /* ===== Filter Toolbar ===== */
  .toolbar { display: flex; gap: 8px; margin-bottom: 16px; flex-wrap: wrap; align-items: center; }
  .toolbar .search-input {
    flex: 1; min-width: 120px; padding: 7px 12px; border: 1.5px solid #e2e8f0;
    border-radius: 8px; font-size: 13px; outline: none; transition: border-color 0.2s;
  }
  .toolbar .search-input:focus { border-color: #60a5fa; }
  .filter-btns { display: flex; gap: 4px; }
  .filter-btn {
    padding: 5px 12px; border: 1.5px solid #e2e8f0; border-radius: 8px; background: #fff;
    font-size: 12px; cursor: pointer; color: #64748b; transition: all 0.2s; white-space: nowrap;
  }
  .filter-btn:hover { border-color: #93c5fd; color: #3b82f6; }
  .filter-btn.active { background: #3b82f6; color: #fff; border-color: #3b82f6; }
  .toolbar select {
    padding: 5px 8px; border: 1.5px solid #e2e8f0; border-radius: 8px; font-size: 12px;
    background: #fff; cursor: pointer; color: #64748b; outline: none;
  }

  /* ===== Todo List ===== */
  .todo-list { list-style: none; }
  .todo-item {
    display: flex; align-items: center; gap: 10px; padding: 12px 4px;
    border-bottom: 1px solid #f1f5f9; animation: fadeIn 0.25s ease;
    transition: opacity 0.2s, background 0.15s; border-radius: 8px;
  }
  .todo-item:last-child { border-bottom: none; }
  .todo-item.dragging { opacity: 0.4; background: #f0f9ff; }
  .todo-item.drag-over { border-top: 2px solid #3b82f6; }
  @keyframes fadeIn { from { opacity:0; transform:translateY(-6px); } to { opacity:1; transform:translateY(0); } }

  .drag-handle { cursor: grab; color: #cbd5e1; font-size: 14px; user-select: none; flex-shrink: 0; padding: 2px; transition: color 0.2s; line-height: 1; }
  .drag-handle:hover { color: #94a3b8; }
  .drag-handle:active { cursor: grabbing; }

  .todo-checkbox {
    width: 18px; height: 18px; cursor: pointer; flex-shrink: 0; accent-color: #7c3aed;
  }
  .complete-btn {
    padding: 3px 10px; border-radius: 6px; font-size: 11px; font-weight: 500; cursor: pointer;
    border: 1.5px solid #d1d5db; background: #fff; color: #64748b; transition: all 0.2s; flex-shrink: 0; white-space: nowrap;
  }
  .complete-btn:hover { border-color: #34d399; color: #16a34a; background: #f0fdf4; }
  .complete-btn.is-done { border-color: #bbf7d0; background: #dcfce7; color: #16a34a; }

  .select-bar {
    display: flex; gap: 8px; align-items: center; padding: 8px 12px; margin-bottom: 10px;
    background: #f5f3ff; border: 1.5px solid #e9d5ff; border-radius: 10px; flex-wrap: wrap;
  }
  .select-bar .select-count { font-size: 13px; font-weight: 600; color: #7c3aed; margin-right: 4px; }
  .select-bar .select-action {
    padding: 4px 12px; border: 1.5px solid #c4b5fd; border-radius: 6px; background: #faf5ff;
    font-size: 11px; cursor: pointer; color: #7c3aed; font-weight: 500; transition: all 0.2s;
  }
  .select-bar .select-action:hover { background: #ede9fe; border-color: #a78bfa; }
  .select-bar .select-action.danger { border-color: #fca5a5; color: #dc2626; background: #fef2f2; }
  .select-bar .select-action.danger:hover { background: #fee2e2; }
  .select-bar .select-cancel { background: none; border: none; color: #94a3b8; font-size: 12px; cursor: pointer; margin-left: auto; }

  .todo-item.subtask { margin-left: 28px; border-left: 2px solid #e9d5ff; padding-left: 12px; }
  .todo-item.subtask .todo-text { font-size: 13px; }

  .item-content { flex: 1; min-width: 0; }
  .todo-text { font-size: 14px; color: #334155; word-break: break-word; transition: color 0.2s; }
  .todo-text.done { text-decoration: line-through; color: #94a3b8; }
  .item-meta { display: flex; gap: 6px; margin-top: 4px; flex-wrap: wrap; align-items: center; }

  .cat-badge { display: inline-block; padding: 1px 8px; border-radius: 10px; font-size: 11px; font-weight: 500; line-height: 1.6; }
  .cat-work { background: #dbeafe; color: #2563eb; }
  .cat-life { background: #dcfce7; color: #16a34a; }
  .cat-study { background: #f3e8ff; color: #9333ea; }
  .cat-other { background: #f1f5f9; color: #64748b; }

  .due-badge { display: inline-block; padding: 1px 8px; border-radius: 10px; font-size: 11px; font-weight: 500; line-height: 1.6; }
  .due-overdue { background: #fee2e2; color: #dc2626; }
  .due-today { background: #ffedd5; color: #ea580c; }
  .due-future { background: #f1f5f9; color: #64748b; }

  .del-btn, .edit-btn { background: none; border: none; color: #cbd5e1; cursor: pointer; padding: 4px; line-height: 1; transition: color 0.2s; flex-shrink: 0; }
  .del-btn { font-size: 16px; }
  .del-btn:hover { color: #f87171; }
  .edit-btn { font-size: 14px; }
  .edit-btn:hover { color: #60a5fa; }

  /* Inline Edit */
  .edit-row { display: flex; gap: 6px; flex-wrap: wrap; align-items: center; width: 100%; }
  .edit-row input[type="text"] { flex:1; min-width:100px; padding:6px 10px; border:1.5px solid #93c5fd; border-radius:6px; font-size:14px; outline:none; }
  .edit-row input[type="date"] { padding:6px 8px; border:1.5px solid #93c5fd; border-radius:6px; font-size:12px; outline:none; max-width:140px; }
  .edit-row select { padding:6px 8px; border:1.5px solid #93c5fd; border-radius:6px; font-size:12px; outline:none; background:#fff; }
  .edit-row .save-edit-btn { padding:5px 12px; background:#34d399; color:#fff; border:none; border-radius:6px; font-size:12px; font-weight:600; cursor:pointer; }
  .edit-row .cancel-edit-btn { padding:5px 12px; background:#e2e8f0; color:#64748b; border:none; border-radius:6px; font-size:12px; cursor:pointer; }

  /* Stats & Empty */
  .stats { text-align: center; margin-top: 16px; font-size: 13px; color: #94a3b8; }
  .empty { text-align: center; padding: 32px 0; color: #cbd5e1; font-size: 14px; }

  /* Date Group Header */
  .date-header { display: flex; align-items: center; gap: 10px; padding: 10px 4px 6px; margin-top: 8px; font-size: 13px; font-weight: 600; color: #64748b; }
  .date-header:first-child { margin-top: 0; }
  .date-header-line { flex: 1; height: 1px; background: #e2e8f0; }
  .date-header-label { white-space: nowrap; }
  .date-header-label.is-overdue { color: #dc2626; }
  .date-header-label.is-today { color: #ea580c; font-weight: 700; }

  /* ===== Footer ===== */
  .footer-bar { display: flex; justify-content: center; gap: 8px; margin-top: 16px; padding-top: 14px; border-top: 1px solid #f1f5f9; flex-wrap: wrap; }
  .footer-btn {
    padding: 6px 14px; border: 1.5px solid #e2e8f0; border-radius: 8px; background: #fff;
    font-size: 12px; cursor: pointer; color: #64748b; transition: all 0.2s;
  }
  .footer-btn:hover { border-color: #93c5fd; color: #3b82f6; }

  /* ===== AI Section ===== */
  .ai-section {
    margin-top: 20px; padding-top: 16px; border-top: 2px solid #e0f2fe;
  }
  .ai-section h2 {
    font-size: 15px; font-weight: 700; color: #7c3aed; margin-bottom: 12px; display: flex; align-items: center; gap: 6px;
  }
  .ai-bar { display: flex; gap: 8px; flex-wrap: wrap; margin-bottom: 10px; }
  .ai-btn {
    padding: 7px 14px; border: 1.5px solid #c4b5fd; border-radius: 8px; background: #faf5ff;
    font-size: 12px; cursor: pointer; color: #7c3aed; font-weight: 500; transition: all 0.2s;
  }
  .ai-btn:hover { background: #ede9fe; border-color: #a78bfa; }
  .ai-btn:disabled { opacity: 0.5; cursor: not-allowed; }
  .ai-btn.loading { animation: pulse 1.2s ease-in-out infinite; }
  @keyframes pulse { 0%,100% { opacity:1; } 50% { opacity:0.5; } }

  .ai-key-hint { font-size: 11px; color: #94a3b8; margin-bottom: 10px; }

  .ai-result {
    background: #faf5ff; border: 1px solid #e9d5ff; border-radius: 10px; padding: 14px 16px;
    font-size: 13px; line-height: 1.7; color: #334155; white-space: pre-wrap; max-height: 350px;
    overflow-y: auto; margin-top: 8px;
  }
  .ai-result .ai-task-item {
    display: flex; align-items: center; gap: 8px; padding: 6px 0; border-bottom: 1px solid #f3e8ff;
  }
  .ai-result .ai-task-item:last-child { border-bottom: none; }
  .ai-add-btn {
    padding: 3px 10px; background: #7c3aed; color: #fff; border: none; border-radius: 6px;
    font-size: 11px; cursor: pointer; white-space: nowrap; flex-shrink: 0;
  }
  .ai-add-btn:hover { background: #6d28d9; }

  /* ===== Modal ===== */
  .modal-overlay {
    display: none; position: fixed; top:0; left:0; right:0; bottom:0;
    background: rgba(0,0,0,0.4); z-index: 1000; align-items: center; justify-content: center;
  }
  .modal-overlay.show { display: flex; }
  .modal-box {
    background: #fff; border-radius: 14px; padding: 28px; width: 90%; max-width: 480px;
    box-shadow: 0 20px 60px rgba(0,0,0,0.2); max-height: 80vh; overflow-y: auto;
  }
  .modal-box h3 { font-size: 18px; margin-bottom: 14px; color: #7c3aed; }
  .modal-box .ai-result { max-height: 50vh; }
  .modal-close {
    display: block; margin: 14px auto 0; padding: 8px 24px; background: #e2e8f0; border: none;
    border-radius: 8px; font-size: 13px; cursor: pointer; color: #64748b;
  }

  /* ===== Responsive ===== */
  @media (max-width: 480px) {
    body { padding: 16px 8px; }
    .card { padding: 20px 16px; }
    .input-row input[type="date"] { max-width: 130px; }
  }
</style>
</head>
<body>

<div class="container">
  <div class="card">
    <h1>&#128221; å¾…åŠäº‹é¡¹</h1>

    <div class="input-row">
      <input id="todoInput" type="text" placeholder="æ·»åŠ æ–°çš„å¾…åŠäº‹é¡¹..." autocomplete="off">
      <input id="dueDateInput" type="date" title="æˆªæ­¢æ—¥æœŸ">
      <select id="categoryInput" title="åˆ†ç±»">
        <option value="other">å…¶ä»–</option>
        <option value="work">å·¥ä½œ</option>
        <option value="life">ç”Ÿæ´»</option>
        <option value="study">å­¦ä¹ </option>
      </select>
      <button class="add-btn" id="addBtn">æ·»åŠ </button>
      <button class="smart-add-trigger" id="smartAddBtn" title="æ™ºèƒ½æ·»åŠ  / è¯­éŸ³è¾“å…¥">&#x2728;</button>
    </div>

    <div class="toolbar">
      <input class="search-input" id="searchInput" type="text" placeholder="æœç´¢..." autocomplete="off">
      <div class="filter-btns">
        <button class="filter-btn active" data-filter="all">å…¨éƒ¨</button>
        <button class="filter-btn" data-filter="active">æœªå®Œæˆ</button>
        <button class="filter-btn" data-filter="done">å·²å®Œæˆ</button>
      </div>
      <select id="catFilter" title="æŒ‰åˆ†ç±»ç­›é€‰">
        <option value="all">å…¨éƒ¨åˆ†ç±»</option>
        <option value="work">å·¥ä½œ</option>
        <option value="life">ç”Ÿæ´»</option>
        <option value="study">å­¦ä¹ </option>
        <option value="other">å…¶ä»–</option>
      </select>
    </div>

    <div id="selectBar" class="select-bar" style="display:none"></div>
    <ul class="todo-list" id="todoList"></ul>
    <div class="stats" id="stats"></div>

    <!-- AI Section -->
    <div class="ai-section">
      <h2>&#x2728; AI åŠ©æ‰‹</h2>
      <div id="aiKeyArea"></div>
      <div class="ai-bar">
        <button class="ai-btn" id="aiBreakdownBtn" title="æ‹†è§£é€‰ä¸­ä»»åŠ¡æˆ–è¾“å…¥æ–°ä»»åŠ¡">&#127919; æ‹†è§£ä»»åŠ¡</button>
        <button class="ai-btn" id="aiExecuteBtn" title="AI ç”Ÿæˆé€‰ä¸­ä»»åŠ¡çš„æ‰§è¡Œæ­¥éª¤">&#9889; ä»»åŠ¡æ‰§è¡Œ</button>
        <button class="ai-btn" id="aiPlanBtn" title="AI æ ¹æ®å¾…åŠç”Ÿæˆä»Šæ—¥è§„åˆ’">&#128197; æ¯æ—¥è§„åˆ’</button>
      </div>
      <div id="aiResult"></div>
    </div>

    <div class="footer-bar">
      <button class="footer-btn" id="exportBtn">&#128230; å¯¼å‡º</button>
      <button class="footer-btn" id="importBtn">&#128229; å¯¼å…¥</button>
      <input type="file" id="importFile" accept=".json" style="display:none">
    </div>
  </div>
</div>

<!-- AI Plan Modal -->
<div class="modal-overlay" id="aiModal">
  <div class="modal-box">
    <h3 id="aiModalTitle">AI è§„åˆ’ <button class="speak-btn" id="modalSpeakBtn" title="æœ—è¯»">&#128264;</button></h3>
    <div class="ai-result" id="aiModalContent"></div>
    <div style="display:flex;gap:8px;justify-content:center;margin-top:14px">
      <button class="modal-close" onclick="document.getElementById('aiModal').classList.remove('show');speechSynthesis.cancel()">å…³é—­</button>
    </div>
  </div>
</div>

<!-- Smart Add Modal -->
<div class="modal-overlay" id="smartAddModal">
  <div class="modal-box">
    <h3>&#x2728; æ™ºèƒ½æ·»åŠ </h3>
    <p style="font-size:13px;color:#64748b;margin-bottom:12px">ç²˜è´´æ–‡å­—æˆ–è¯­éŸ³è¾“å…¥ï¼ŒAI è‡ªåŠ¨è¯†åˆ«å¹¶ç”Ÿæˆå¾…åŠäº‹é¡¹</p>
    <div style="position:relative">
      <textarea class="smart-modal-textarea" id="smartAddText" placeholder="åœ¨æ­¤ç²˜è´´æˆ–è¾“å…¥æ–‡å­—...&#10;ä¾‹å¦‚ï¼šæ˜å¤©ä¸‹åˆå¼€ä¼šè®¨è®ºé¡¹ç›®è¿›åº¦ï¼Œåå¤©äº¤å‘¨æŠ¥ï¼Œä»Šå¤©ä¹°èœåšé¥­"></textarea>
      <button class="mic-btn" id="smartMicBtn" style="position:absolute;right:8px;bottom:8px" title="è¯­éŸ³è¾“å…¥">&#127908;</button>
    </div>
    <div class="smart-modal-actions">
      <button class="smart-parse-btn" id="smartParseBtn">&#129302; AI è§£æ</button>
      <span class="smart-parse-hint" id="smartParseHint"></span>
    </div>
    <div id="smartAddResult"></div>
    <div style="display:flex;gap:8px;justify-content:center;margin-top:14px">
      <button class="modal-close" id="smartAddClose">å…³é—­</button>
    </div>
  </div>
</div>

<script>
(function () {
  var STORAGE_KEY = 'my_todo_items';

  var input = document.getElementById('todoInput');
  var dueDateInput = document.getElementById('dueDateInput');
  var categoryInput = document.getElementById('categoryInput');
  var addBtn = document.getElementById('addBtn');
  var listEl = document.getElementById('todoList');
  var statsEl = document.getElementById('stats');
  var searchInput = document.getElementById('searchInput');
  var catFilter = document.getElementById('catFilter');
  var exportBtn = document.getElementById('exportBtn');
  var importBtn = document.getElementById('importBtn');
  var importFile = document.getElementById('importFile');
  var aiKeyArea = document.getElementById('aiKeyArea');
  var aiResultEl = document.getElementById('aiResult');
  var modalSpeakBtn = document.getElementById('modalSpeakBtn');
  var aiBreakdownBtn = document.getElementById('aiBreakdownBtn');
  var aiExecuteBtn = document.getElementById('aiExecuteBtn');
  var aiPlanBtn = document.getElementById('aiPlanBtn');
  var selectBar = document.getElementById('selectBar');
  var smartAddBtn = document.getElementById('smartAddBtn');
  var smartAddModal = document.getElementById('smartAddModal');
  var smartAddText = document.getElementById('smartAddText');
  var smartMicBtn = document.getElementById('smartMicBtn');
  var smartParseBtn = document.getElementById('smartParseBtn');
  var smartParseHint = document.getElementById('smartParseHint');
  var smartAddResult = document.getElementById('smartAddResult');
  var smartAddClose = document.getElementById('smartAddClose');

  var currentFilter = 'all';
  var dragSrcIndex = null;
  var editingId = null;
  var selectedIds = new Set();

  var CATEGORIES = { work: 'å·¥ä½œ', life: 'ç”Ÿæ´»', study: 'å­¦ä¹ ', other: 'å…¶ä»–' };
  var CAT_KEYS = ['work', 'life', 'study', 'other'];

  // ===== Data =====
  var todos = load();

  function load() {
    var raw = localStorage.getItem(STORAGE_KEY);
    if (!raw) return [];
    try {
      var items = JSON.parse(raw);
      return items.map(function (item, i) {
        if (!item.id) item.id = Date.now() + i;
        if (!item.category) item.category = 'other';
        if (item.dueDate === undefined) item.dueDate = '';
        if (!item.createdAt) item.createdAt = new Date().toISOString();
        if (item.parentId === undefined) item.parentId = null;
        return item;
      });
    } catch (e) { return []; }
  }

  function save() { localStorage.setItem(STORAGE_KEY, JSON.stringify(todos)); }

  // ===== Date Helpers =====
  function todayStr() {
    var d = new Date();
    return d.getFullYear() + '-' + String(d.getMonth()+1).padStart(2,'0') + '-' + String(d.getDate()).padStart(2,'0');
  }
  function formatDate(s) { if (!s) return ''; var p=s.split('-'); return p[1]+'/'+p[2]; }
  function formatDateFull(s) {
    if (!s) return 'æœªè®¾å®šæ—¥æœŸ';
    var today = todayStr(), p = s.split('-');
    var wd = ['æ—¥','ä¸€','äºŒ','ä¸‰','å››','äº”','å…­'];
    var d = new Date(+p[0], +p[1]-1, +p[2]);
    var label = p[0]+'å¹´'+parseInt(p[1])+'æœˆ'+parseInt(p[2])+'æ—¥ å‘¨'+wd[d.getDay()];
    if (s === today) label = 'ä»Šå¤© - ' + label;
    return label;
  }
  function dateHeaderClass(s) { if(!s) return ''; var t=todayStr(); if(s<t) return 'is-overdue'; if(s===t) return 'is-today'; return ''; }
  function dueDateClass(s,done) { if(!s||done) return 'due-future'; var t=todayStr(); if(s<t) return 'due-overdue'; if(s===t) return 'due-today'; return 'due-future'; }

  // ===== AI Configuration =====
  var API_BACKEND = 'https://my-todo-api-sooty.vercel.app/api/chat';

  function renderKeyArea() {
    aiKeyArea.innerHTML = '<div class="ai-key-hint">AI å·²å°±ç»ª &#x2705;</div>';
  }

  // ===== AI API Call =====
  function callAI(prompt, callback) {
    fetch(API_BACKEND, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ prompt: prompt })
    })
    .then(function(r) { return r.json(); })
    .then(function(data) {
      if (data.error) { callback(null, data.error); return; }
      callback(data.text || '', null);
    })
    .catch(function(err) { callback(null, err.message); });
  }

  // ===== AI Feature 1: Task Breakdown =====
  function aiBreakdown() {
    var sel = getSelectedTodos();
    if (sel.length > 0) { aiBreakdownSelected(); return; }
    var task = prompt('è¯·è¾“å…¥è¦æ‹†è§£çš„å¤§ä»»åŠ¡ï¼š');
    if (!task) return;
    doBreakdown(task, null);
  }

  function aiBreakdownSelected() {
    var sel = getSelectedTodos();
    if (sel.length === 0) { alert('è¯·å…ˆå‹¾é€‰è¦æ‹†è§£çš„ä»»åŠ¡'); return; }
    var taskText = sel.map(function(t) { return t.text; }).join('ã€');
    var parentId = sel.length === 1 ? sel[0].id : null;
    doBreakdown(taskText, parentId);
  }

  function doBreakdown(task, parentId) {
    aiBreakdownBtn.disabled = true;
    aiBreakdownBtn.classList.add('loading');
    aiBreakdownBtn.textContent = 'æ‹†è§£ä¸­...';

    var today = todayStr();
    var p = 'ä½ æ˜¯ä¸€ä¸ªä»»åŠ¡ç®¡ç†åŠ©æ‰‹ã€‚ç”¨æˆ·è¾“å…¥äº†ä¸€ä¸ªå¤§ä»»åŠ¡ï¼ˆå¯èƒ½åŒ…å«å¤šä¸ªï¼‰ï¼Œè¯·å°†å…¶æ‹†è§£ä¸º3-7ä¸ªå…·ä½“çš„å­ä»»åŠ¡ã€‚\n\n' +
      'ä»Šå¤©æ—¥æœŸ: ' + today + '\n' +
      'ä»»åŠ¡: ' + task + '\n\n' +
      'è¯·ä»¥JSONæ•°ç»„æ ¼å¼è¿”å›ï¼Œæ¯ä¸ªå­ä»»åŠ¡åŒ…å«:\n' +
      '- text: å­ä»»åŠ¡æè¿°ï¼ˆç®€æ´ï¼Œä¸­æ–‡ï¼‰\n' +
      '- category: åˆ†ç±»ï¼ˆwork/life/study/other ä¹‹ä¸€ï¼‰\n' +
      '- dueDate: å»ºè®®æˆªæ­¢æ—¥æœŸï¼ˆYYYY-MM-DDæ ¼å¼ï¼Œæ ¹æ®åˆç†æ€§å®‰æ’ï¼‰\n\n' +
      'åªè¿”å›JSONæ•°ç»„ï¼Œä¸è¦å…¶ä»–å†…å®¹ã€‚ç¤ºä¾‹:\n' +
      '[{"text":"è°ƒç ”ç«å“","category":"work","dueDate":"2026-02-10"}]';

    callAI(p, function(text, err) {
      aiBreakdownBtn.disabled = false;
      aiBreakdownBtn.classList.remove('loading');
      aiBreakdownBtn.textContent = '\u{1F3AF} æ‹†è§£ä»»åŠ¡';

      if (err) { aiResultEl.innerHTML = '<div class="ai-result">é”™è¯¯: ' + err + '</div>'; return; }

      try {
        var match = text.match(/\[[\s\S]*\]/);
        var tasks = JSON.parse(match[0]);
        var html = '<div class="ai-result">';
        html += '<div style="font-weight:600;margin-bottom:8px;color:#7c3aed">AI æ‹†è§£: ' + task + '</div>';
        tasks.forEach(function(t, i) {
          html += '<div class="ai-task-item">' +
            '<span style="flex:1">' + (i+1) + '. ' + t.text +
            ' <span class="cat-badge cat-' + (t.category||'other') + '">' + (CATEGORIES[t.category]||'å…¶ä»–') + '</span>' +
            (t.dueDate ? ' <span class="due-badge due-future">' + formatDate(t.dueDate) + '</span>' : '') +
            '</span>' +
            '<button class="ai-add-btn" data-idx="' + i + '">+ æ·»åŠ </button></div>';
        });
        html += '</div>';
        aiResultEl.innerHTML = html;

        // "å…¨éƒ¨æ·»åŠ " button
        var addAllHtml = '<div style="margin-top:8px;text-align:right"><button class="ai-add-btn" id="aiAddAll">å…¨éƒ¨æ·»åŠ ä¸ºå­ä»»åŠ¡</button></div>';
        aiResultEl.querySelector('.ai-result').insertAdjacentHTML('beforeend', addAllHtml);

        function addSubtask(idx, btnEl) {
          var t = tasks[idx];
          todos.push({
            id: Date.now() + idx, text: t.text, done: false,
            category: t.category || 'other', dueDate: t.dueDate || '',
            createdAt: new Date().toISOString(), parentId: parentId || null
          });
          if (btnEl) { btnEl.textContent = 'å·²æ·»åŠ '; btnEl.disabled = true; btnEl.style.background = '#94a3b8'; }
        }

        aiResultEl.querySelectorAll('.ai-add-btn[data-idx]').forEach(function(btn) {
          btn.addEventListener('click', function() {
            addSubtask(parseInt(this.getAttribute('data-idx')), this);
            save(); render();
          });
        });

        document.getElementById('aiAddAll').addEventListener('click', function() {
          tasks.forEach(function(t, i) { addSubtask(i, null); });
          save(); render();
          this.textContent = 'å·²å…¨éƒ¨æ·»åŠ '; this.disabled = true; this.style.background = '#94a3b8';
          aiResultEl.querySelectorAll('.ai-add-btn[data-idx]').forEach(function(b) {
            b.textContent = 'å·²æ·»åŠ '; b.disabled = true; b.style.background = '#94a3b8';
          });
        });
      } catch(e) {
        aiResultEl.innerHTML = '<div class="ai-result">' + text + '</div>';
      }
    });
  }

  // ===== AI Feature: Task Execution =====
  function aiExecuteSelected() {
    var sel = getSelectedTodos();
    if (sel.length === 0) { alert('è¯·å…ˆå‹¾é€‰è¦æ‰§è¡Œçš„ä»»åŠ¡'); return; }

    aiExecuteBtn.disabled = true;
    aiExecuteBtn.classList.add('loading');
    aiExecuteBtn.textContent = 'æ‰§è¡Œä¸­...';

    var today = todayStr();
    var taskList = sel.map(function(t, i) {
      return (i+1) + '. ' + t.text +
        ' [åˆ†ç±»:' + (CATEGORIES[t.category]||'å…¶ä»–') + ']' +
        (t.dueDate ? ' [æˆªæ­¢:' + t.dueDate + ']' : '');
    }).join('\n');

    var p = 'ä½ æ˜¯ä¸€ä¸ªå…¨èƒ½å·¥ä½œåŠ©æ‰‹ã€‚ç”¨æˆ·é€‰ä¸­äº†ä»¥ä¸‹å¾…åŠä»»åŠ¡ï¼Œè¯·ç›´æ¥å¸®ç”¨æˆ·å®Œæˆè¿™äº›ä»»åŠ¡ï¼Œäº§å‡ºå®é™…å¯ç”¨çš„å·¥ä½œæˆæœã€‚\n\n' +
      'ä»Šå¤©æ—¥æœŸ: ' + today + '\n\n' +
      'éœ€è¦æ‰§è¡Œçš„ä»»åŠ¡:\n' + taskList + '\n\n' +
      'é‡è¦è¦æ±‚ï¼šä¸è¦å‘Šè¯‰ç”¨æˆ·"ä½ åº”è¯¥æ€ä¹ˆåš"ï¼Œè€Œæ˜¯ç›´æ¥äº§å‡ºæˆæœã€‚ä¾‹å¦‚ï¼š\n' +
      '- å¦‚æœä»»åŠ¡æ˜¯"å†™å‘¨æŠ¥" â†’ ç›´æ¥å†™å‡ºä¸€ä»½å‘¨æŠ¥\n' +
      '- å¦‚æœä»»åŠ¡æ˜¯"å‡†å¤‡ä¼šè®®è®®ç¨‹" â†’ ç›´æ¥å†™å‡ºè®®ç¨‹å†…å®¹\n' +
      '- å¦‚æœä»»åŠ¡æ˜¯"è°ƒç ”XX" â†’ ç›´æ¥ç»™å‡ºè°ƒç ”æŠ¥å‘Š\n' +
      '- å¦‚æœä»»åŠ¡æ˜¯"å†™é‚®ä»¶ç»™XX" â†’ ç›´æ¥å†™å‡ºé‚®ä»¶å…¨æ–‡\n' +
      '- å¦‚æœä»»åŠ¡æ˜¯"åšPPTå¤§çº²" â†’ ç›´æ¥å†™å‡ºå®Œæ•´å¤§çº²\n' +
      '- å¦‚æœä»»åŠ¡æ˜¯"åˆ¶å®šè®¡åˆ’" â†’ ç›´æ¥å†™å‡ºè¯¦ç»†è®¡åˆ’\n' +
      '- å¦‚æœä»»åŠ¡æ˜¯"æ•´ç†èµ„æ–™" â†’ ç›´æ¥ç»™å‡ºæ•´ç†å¥½çš„æ¡†æ¶å’Œå†…å®¹\n\n' +
      'å¯¹äºæ¯ä¸ªä»»åŠ¡ï¼Œå…ˆç”¨æ ‡é¢˜æ ‡æ˜ä»»åŠ¡åï¼Œç„¶åç›´æ¥ç»™å‡ºå®Œæ•´çš„å·¥ä½œæˆæœï¼ˆå¯ä»¥ç›´æ¥å¤åˆ¶ä½¿ç”¨çš„ç¨‹åº¦ï¼‰ã€‚\n' +
      'ç”¨ä¸­æ–‡å›ç­”ï¼Œå†…å®¹ä¸“ä¸šã€è¯¦å®ï¼Œæ ¼å¼æ¸…æ™°ã€‚å¦‚æœä»»åŠ¡æè¿°ä¿¡æ¯ä¸è¶³ï¼Œè¯·åŸºäºåˆç†å‡è®¾è¡¥å……å®Œæ•´ã€‚';

    callAI(p, function(text, err) {
      aiExecuteBtn.disabled = false;
      aiExecuteBtn.classList.remove('loading');
      aiExecuteBtn.textContent = '\u26A1 ä»»åŠ¡æ‰§è¡Œ';

      if (err) { alert('AI é”™è¯¯: ' + err); return; }

      document.getElementById('aiModalTitle').textContent = 'âš¡ ä»»åŠ¡æ‰§è¡Œç»“æœ';
      document.getElementById('aiModalContent').textContent = text;
      document.getElementById('aiModal').classList.add('show');
    });
  }

  // ===== AI Feature 2: Daily Plan =====
  function aiDailyPlan() {
    var pending = todos.filter(function(t) { return !t.done; });
    if (pending.length === 0) { alert('æ²¡æœ‰æœªå®Œæˆçš„å¾…åŠäº‹é¡¹'); return; }

    aiPlanBtn.disabled = true;
    aiPlanBtn.classList.add('loading');
    aiPlanBtn.textContent = 'è§„åˆ’ä¸­...';

    var today = todayStr();
    var todoList = pending.map(function(t) {
      return '- ' + t.text + ' [åˆ†ç±»:' + (CATEGORIES[t.category]||'å…¶ä»–') + ']' +
        (t.dueDate ? ' [æˆªæ­¢:' + t.dueDate + ']' : ' [æ— æˆªæ­¢æ—¥æœŸ]');
    }).join('\n');

    var p = 'ä½ æ˜¯ä¸€ä¸ªæ—¶é—´ç®¡ç†ä¸“å®¶ã€‚æ ¹æ®ç”¨æˆ·çš„å¾…åŠäº‹é¡¹åˆ—è¡¨ï¼Œç”Ÿæˆä¸€ä»½ä»Šæ—¥è¡ŒåŠ¨è®¡åˆ’ã€‚\n\n' +
      'ä»Šå¤©æ—¥æœŸ: ' + today + '\n\n' +
      'å¾…åŠäº‹é¡¹:\n' + todoList + '\n\n' +
      'è¯·ç”Ÿæˆ:\n' +
      '1. ä»Šæ—¥ä¼˜å…ˆçº§æ’åºï¼ˆè€ƒè™‘æˆªæ­¢æ—¥æœŸç´§è¿«æ€§ï¼‰\n' +
      '2. å»ºè®®çš„æ—¶é—´å®‰æ’ï¼ˆä¸Šåˆ/ä¸‹åˆ/æ™šä¸Šï¼‰\n' +
      '3. ä¸€å¥è¯æ¿€åŠ±\n\n' +
      'ç”¨ä¸­æ–‡å›ç­”ï¼Œæ ¼å¼æ¸…æ™°ï¼Œä½¿ç”¨ emoji è®©å†…å®¹æ›´ç”ŸåŠ¨ã€‚';

    callAI(p, function(text, err) {
      aiPlanBtn.disabled = false;
      aiPlanBtn.classList.remove('loading');
      aiPlanBtn.textContent = '\u{1F4C5} æ¯æ—¥è§„åˆ’';

      if (err) { alert('AI é”™è¯¯: ' + err); return; }

      document.getElementById('aiModalTitle').textContent = 'ğŸ“‹ ä»Šæ—¥è§„åˆ’';
      document.getElementById('aiModalContent').textContent = text;
      document.getElementById('aiModal').classList.add('show');
    });
  }

  // ===== Smart Add Modal =====
  function openSmartAdd() {
    smartAddText.value = '';
    smartAddResult.innerHTML = '';
    smartParseHint.textContent = '';
    smartParseHint.style.color = '';
    smartAddModal.classList.add('show');
    setTimeout(function() { smartAddText.focus(); }, 100);
  }

  function closeSmartAdd() {
    smartAddModal.classList.remove('show');
    if (recognition && isListening) recognition.stop();
  }

  function smartParse() {
    var text = smartAddText.value.trim();
    if (!text) { smartParseHint.textContent = 'è¯·å…ˆè¾“å…¥å†…å®¹'; smartParseHint.style.color = '#f87171'; return; }

    smartParseBtn.disabled = true;
    smartParseBtn.textContent = 'è§£æä¸­...';
    smartParseBtn.classList.add('loading');
    smartParseHint.textContent = '';
    smartParseHint.style.color = '';

    var today = todayStr();
    var d = new Date();
    var tomorrow = new Date(d); tomorrow.setDate(d.getDate()+1);
    var dayAfter = new Date(d); dayAfter.setDate(d.getDate()+2);
    function fmt(dt) { return dt.getFullYear()+'-'+String(dt.getMonth()+1).padStart(2,'0')+'-'+String(dt.getDate()).padStart(2,'0'); }

    var p = 'ä½ æ˜¯ä¸€ä¸ªå¾…åŠäº‹é¡¹è§£æåŠ©æ‰‹ã€‚ç”¨æˆ·è¾“å…¥äº†ä¸€æ®µæ–‡å­—ï¼Œè¯·æå–æ‰€æœ‰å¾…åŠäº‹é¡¹ä¿¡æ¯ã€‚\n\n' +
      'ä»Šå¤©æ—¥æœŸ: ' + today + 'ï¼ˆ' + fmt(d) + 'ï¼‰\n' +
      'æ˜å¤©æ—¥æœŸ: ' + fmt(tomorrow) + '\n' +
      'åå¤©æ—¥æœŸ: ' + fmt(dayAfter) + '\n\n' +
      'ç”¨æˆ·è¾“å…¥: "' + text + '"\n\n' +
      'è¯·æå–å¹¶è¿”å›JSONï¼ˆå¯èƒ½åŒ…å«å¤šä¸ªå¾…åŠï¼‰:\n' +
      '{"items":[{"text":"ä»»åŠ¡æè¿°","dueDate":"YYYY-MM-DD","category":"work/life/study/other"}]}\n\n' +
      'è§„åˆ™:\n' +
      '- text: ç®€æ´çš„ä»»åŠ¡æè¿°ï¼Œå»æ‰æ—¶é—´è¯ï¼ˆä»Šå¤©ã€æ˜å¤©ã€åå¤©ã€ä¸‹å‘¨ç­‰ï¼‰\n' +
      '- dueDate: æ ¹æ®æ–‡å­—ä¸­çš„æ—¶é—´è¯æ¨ç®—å…·ä½“æ—¥æœŸã€‚"ä»Šå¤©"=' + today + 'ï¼Œ"æ˜å¤©"=' + fmt(tomorrow) + 'ï¼Œ"åå¤©"=' + fmt(dayAfter) + 'ã€‚"ä¸‹å‘¨X"è¯·è®¡ç®—å…·ä½“æ—¥æœŸã€‚æ²¡æåˆ°æ—¶é—´å°±ç•™ç©ºå­—ç¬¦ä¸²\n' +
      '- category: work(å·¥ä½œ/å¼€ä¼š/é¡¹ç›®/æ±‡æŠ¥), life(ç”Ÿæ´»/ä¹°/åƒ/è¿åŠ¨), study(å­¦ä¹ /çœ‹ä¹¦/è¯¾ç¨‹), other(å…¶ä»–)\n' +
      '- å¦‚æœå†…å®¹åŒ…å«å¤šä¸ªä»»åŠ¡ï¼Œæ‹†åˆ†ä¸ºå¤šä¸ªitems\n' +
      '- å¦‚æœåªæœ‰ä¸€ä¸ªä»»åŠ¡ä¹Ÿè¦è¿”å›æ•°ç»„æ ¼å¼\n\n' +
      'åªè¿”å›JSONï¼Œä¸è¦å…¶ä»–å†…å®¹ã€‚';

    callAI(p, function(result, err) {
      smartParseBtn.disabled = false;
      smartParseBtn.innerHTML = '&#129302; AI è§£æ';
      smartParseBtn.classList.remove('loading');

      if (err) {
        smartParseHint.textContent = 'è§£æå¤±è´¥: ' + err;
        smartParseHint.style.color = '#f87171';
        return;
      }

      try {
        var match = result.match(/\{[\s\S]*\}/);
        var data = JSON.parse(match[0]);
        var items = data.items || [];
        if (items.length === 0) throw new Error('empty');
        renderSmartResults(items);
      } catch(e) {
        smartParseHint.textContent = 'è§£æå¤±è´¥ï¼Œè¯·é‡è¯•';
        smartParseHint.style.color = '#f87171';
      }
    });
  }

  function renderSmartResults(items) {
    var today = todayStr();
    var d = new Date();
    var tomorrow = new Date(d); tomorrow.setDate(d.getDate()+1);
    var dayAfter = new Date(d); dayAfter.setDate(d.getDate()+2);
    function fmt(dt) { return dt.getFullYear()+'-'+String(dt.getMonth()+1).padStart(2,'0')+'-'+String(dt.getDate()).padStart(2,'0'); }

    var html = '<div class="ai-result" style="margin-top:12px">';
    html += '<div style="font-weight:600;margin-bottom:8px;color:#7c3aed">è§£æç»“æœ (' + items.length + ' æ¡å¾…åŠ)</div>';

    items.forEach(function(item, i) {
      var dateLabel = '';
      if (item.dueDate) {
        if (item.dueDate === today) dateLabel = 'ä»Šå¤©';
        else if (item.dueDate === fmt(tomorrow)) dateLabel = 'æ˜å¤©';
        else if (item.dueDate === fmt(dayAfter)) dateLabel = 'åå¤©';
        else dateLabel = formatDate(item.dueDate);
      }
      html += '<div class="ai-task-item">' +
        '<span style="flex:1">' + (i+1) + '. ' + item.text +
        ' <span class="cat-badge cat-' + (item.category||'other') + '">' + (CATEGORIES[item.category]||'å…¶ä»–') + '</span>' +
        (dateLabel ? ' <span class="due-badge ' + dueDateClass(item.dueDate, false) + '">' + dateLabel + '</span>' : '') +
        '</span>' +
        '<button class="ai-add-btn" data-sidx="' + i + '">+ æ·»åŠ </button></div>';
    });

    html += '<div style="margin-top:10px;text-align:right">' +
      '<button class="ai-add-btn" id="smartAddAllBtn" style="padding:5px 16px;font-size:12px">å…¨éƒ¨æ·»åŠ </button></div>';
    html += '</div>';

    smartAddResult.innerHTML = html;
    smartParseHint.textContent = '';
    smartParseHint.style.color = '';

    smartAddResult.querySelectorAll('.ai-add-btn[data-sidx]').forEach(function(btn) {
      btn.addEventListener('click', function() {
        var idx = parseInt(this.getAttribute('data-sidx'));
        var item = items[idx];
        todos.push({
          id: Date.now() + idx, text: item.text, done: false,
          category: item.category || 'other', dueDate: item.dueDate || '',
          createdAt: new Date().toISOString(), parentId: null
        });
        save(); render();
        this.textContent = 'å·²æ·»åŠ '; this.disabled = true; this.style.background = '#94a3b8';
      });
    });

    document.getElementById('smartAddAllBtn').addEventListener('click', function() {
      items.forEach(function(item, i) {
        todos.push({
          id: Date.now() + i, text: item.text, done: false,
          category: item.category || 'other', dueDate: item.dueDate || '',
          createdAt: new Date().toISOString(), parentId: null
        });
      });
      save(); render();
      this.textContent = 'å·²å…¨éƒ¨æ·»åŠ '; this.disabled = true; this.style.background = '#94a3b8';
      smartAddResult.querySelectorAll('.ai-add-btn[data-sidx]').forEach(function(b) {
        b.textContent = 'å·²æ·»åŠ '; b.disabled = true; b.style.background = '#94a3b8';
      });
    });
  }

  // ===== Filtering =====
  function getFiltered() {
    var search = searchInput.value.trim().toLowerCase();
    var cat = catFilter.value;
    return todos.filter(function(todo) {
      if (currentFilter === 'active' && todo.done) return false;
      if (currentFilter === 'done' && !todo.done) return false;
      if (cat !== 'all' && todo.category !== cat) return false;
      if (search && todo.text.toLowerCase().indexOf(search) === -1) return false;
      return true;
    });
  }

  // ===== Selection =====
  function getSelectedTodos() {
    return todos.filter(function(t) { return selectedIds.has(t.id); });
  }

  function renderSelectBar() {
    var count = selectedIds.size;
    if (count === 0) { selectBar.style.display = 'none'; return; }
    selectBar.style.display = 'flex';
    selectBar.innerHTML =
      '<span class="select-count">å·²é€‰ ' + count + ' é¡¹</span>' +
      '<button class="select-action" id="selBreakdown">&#127919; æ‹†è§£</button>' +
      '<button class="select-action" id="selExecute">&#9889; æ‰§è¡Œ</button>' +
      '<button class="select-action" id="selDone">&#x2705; å…¨éƒ¨å®Œæˆ</button>' +
      '<button class="select-action danger" id="selDelete">&#x2715; åˆ é™¤</button>' +
      '<button class="select-cancel" id="selClear">å–æ¶ˆé€‰æ‹©</button>';
    document.getElementById('selBreakdown').addEventListener('click', function() { aiBreakdownSelected(); });
    document.getElementById('selExecute').addEventListener('click', function() { aiExecuteSelected(); });
    document.getElementById('selDone').addEventListener('click', function() {
      getSelectedTodos().forEach(function(t) { t.done = true; });
      selectedIds.clear(); save(); render();
    });
    document.getElementById('selDelete').addEventListener('click', function() {
      if (!confirm('ç¡®å®šåˆ é™¤é€‰ä¸­çš„ ' + count + ' é¡¹ï¼Ÿ')) return;
      var ids = new Set(selectedIds);
      todos = todos.filter(function(t) { return !ids.has(t.id) && !ids.has(t.parentId); });
      selectedIds.clear(); save(); render();
    });
    document.getElementById('selClear').addEventListener('click', function() {
      selectedIds.clear(); render();
    });
  }

  // ===== Render =====
  function render() {
    listEl.innerHTML = '';
    var filtered = getFiltered();

    if (todos.length === 0) {
      listEl.innerHTML = '<li class="empty">æš‚æ— å¾…åŠäº‹é¡¹ï¼Œæ·»åŠ ä¸€ä¸ªå§</li>';
      statsEl.textContent = '';
      return;
    }
    if (filtered.length === 0) {
      listEl.innerHTML = '<li class="empty">æ²¡æœ‰åŒ¹é…çš„å¾…åŠäº‹é¡¹</li>';
      var r = todos.filter(function(t){return !t.done;}).length;
      statsEl.textContent = r + ' é¡¹æœªå®Œæˆ / å…± ' + todos.length + ' é¡¹';
      return;
    }

    // Separate parents and subtasks
    var parents = filtered.filter(function(t) { return !t.parentId; });
    var childMap = {};
    filtered.forEach(function(t) {
      if (t.parentId) {
        if (!childMap[t.parentId]) childMap[t.parentId] = [];
        childMap[t.parentId].push(t);
      }
    });

    var sorted = parents.slice().sort(function(a,b) {
      var da = a.dueDate || '\uffff', db = b.dueDate || '\uffff';
      return da < db ? -1 : da > db ? 1 : 0;
    });

    var lastDate = null;
    sorted.forEach(function(todo) {
      var dateKey = todo.dueDate || '';

      if (dateKey !== lastDate) {
        lastDate = dateKey;
        var header = document.createElement('li');
        header.className = 'date-header';
        var lbl = document.createElement('span');
        lbl.className = 'date-header-label ' + dateHeaderClass(dateKey);
        lbl.textContent = formatDateFull(dateKey);
        var ln = document.createElement('span');
        ln.className = 'date-header-line';
        header.appendChild(lbl);
        header.appendChild(ln);
        listEl.appendChild(header);
      }

      // Render parent
      appendTodoLi(todo, false);
      // Render subtasks
      var children = childMap[todo.id] || [];
      children.forEach(function(child) { appendTodoLi(child, true); });
    });

    function appendTodoLi(todo, isSubtask) {
      var realIndex = todos.indexOf(todo);
      var li = document.createElement('li');
      li.className = 'todo-item' + (isSubtask ? ' subtask' : '');
      li.setAttribute('data-index', realIndex);
      var isEditing = editingId === todo.id;

      if (!isEditing) {
        li.setAttribute('draggable', 'true');
        li.addEventListener('dragstart', handleDragStart);
        li.addEventListener('dragover', handleDragOver);
        li.addEventListener('dragleave', handleDragLeave);
        li.addEventListener('drop', handleDrop);
        li.addEventListener('dragend', handleDragEnd);

        var chk = document.createElement('input');
        chk.type = 'checkbox';
        chk.className = 'todo-checkbox';
        chk.checked = selectedIds.has(todo.id);
        (function(tid) {
          chk.addEventListener('change', function() {
            if (this.checked) selectedIds.add(tid); else selectedIds.delete(tid);
            renderSelectBar();
          });
        })(todo.id);

        var handle = document.createElement('span');
        handle.className = 'drag-handle';
        handle.textContent = '\u2807';

        var content = document.createElement('div');
        content.className = 'item-content';
        var textSpan = document.createElement('span');
        textSpan.className = 'todo-text' + (todo.done ? ' done' : '');
        textSpan.textContent = todo.text;
        var meta = document.createElement('div');
        meta.className = 'item-meta';
        var catBadge = document.createElement('span');
        catBadge.className = 'cat-badge cat-' + todo.category;
        catBadge.textContent = CATEGORIES[todo.category] || 'å…¶ä»–';
        meta.appendChild(catBadge);
        content.appendChild(textSpan);
        content.appendChild(meta);

        var compBtn = document.createElement('button');
        compBtn.className = 'complete-btn' + (todo.done ? ' is-done' : '');
        compBtn.textContent = todo.done ? 'å·²å®Œæˆ' : 'å®Œæˆ';
        compBtn.addEventListener('click', function() { todo.done = !todo.done; save(); render(); });

        var eb = document.createElement('button');
        eb.className = 'edit-btn';
        eb.innerHTML = '&#9998;';
        eb.addEventListener('click', function() { editingId = todo.id; render(); });

        var db = document.createElement('button');
        db.className = 'del-btn';
        db.innerHTML = '&#x2715;';
        db.addEventListener('click', function() {
          var tid = todo.id;
          todos = todos.filter(function(t) { return t.id !== tid && t.parentId !== tid; });
          selectedIds.delete(tid); save(); render();
        });

        li.appendChild(chk);
        li.appendChild(handle);
        li.appendChild(content);
        li.appendChild(compBtn);
        li.appendChild(eb);
        li.appendChild(db);
      } else {
        var er = document.createElement('div');
        er.className = 'edit-row';
        var et = document.createElement('input'); et.type='text'; et.value=todo.text;
        var ed = document.createElement('input'); ed.type='date'; ed.value=todo.dueDate||'';
        var ec = document.createElement('select');
        CAT_KEYS.forEach(function(k){ var o=document.createElement('option'); o.value=k; o.textContent=CATEGORIES[k]; if(todo.category===k) o.selected=true; ec.appendChild(o); });
        var sb = document.createElement('button'); sb.className='save-edit-btn'; sb.textContent='ä¿å­˜';
        sb.addEventListener('click', function(){ var v=et.value.trim(); if(!v)return; todo.text=v; todo.dueDate=ed.value||''; todo.category=ec.value; editingId=null; save(); render(); });
        var cb2 = document.createElement('button'); cb2.className='cancel-edit-btn'; cb2.textContent='å–æ¶ˆ';
        cb2.addEventListener('click', function(){ editingId=null; render(); });
        et.addEventListener('keydown', function(e){ if(e.key==='Enter') sb.click(); if(e.key==='Escape') cb2.click(); });
        er.appendChild(et); er.appendChild(ed); er.appendChild(ec); er.appendChild(sb); er.appendChild(cb2);
        li.appendChild(er);
        setTimeout(function(){ et.focus(); et.select(); }, 0);
      }
      listEl.appendChild(li);
    }

    var remaining = todos.filter(function(t){return !t.done;}).length;
    statsEl.textContent = remaining + ' é¡¹æœªå®Œæˆ / å…± ' + todos.length + ' é¡¹';
    renderSelectBar();
  }

  // ===== Add Todo =====
  function addTodo() {
    var text = input.value.trim();
    if (!text) return;
    todos.push({
      id: Date.now(), text: text, done: false,
      category: categoryInput.value, dueDate: dueDateInput.value || '',
      createdAt: new Date().toISOString(), parentId: null
    });
    input.value = '';
    dueDateInput.value = '';
    save(); render();
    input.focus();
  }

  // ===== Drag & Drop =====
  function handleDragStart(e) { dragSrcIndex=parseInt(this.getAttribute('data-index')); this.classList.add('dragging'); e.dataTransfer.effectAllowed='move'; e.dataTransfer.setData('text/plain',dragSrcIndex); }
  function handleDragOver(e) { e.preventDefault(); e.dataTransfer.dropEffect='move'; this.classList.add('drag-over'); }
  function handleDragLeave() { this.classList.remove('drag-over'); }
  function handleDrop(e) { e.preventDefault(); this.classList.remove('drag-over'); var t=parseInt(this.getAttribute('data-index')); if(dragSrcIndex===null||dragSrcIndex===t) return; var item=todos.splice(dragSrcIndex,1)[0]; todos.splice(t,0,item); save(); render(); }
  function handleDragEnd() { this.classList.remove('dragging'); dragSrcIndex=null; listEl.querySelectorAll('.todo-item').forEach(function(i){i.classList.remove('drag-over');}); }

  // ===== Export / Import =====
  function exportData() {
    var blob = new Blob([JSON.stringify(todos,null,2)], {type:'application/json'});
    var url = URL.createObjectURL(blob);
    var a = document.createElement('a'); a.href=url; a.download='my-todo-backup.json';
    document.body.appendChild(a); a.click(); document.body.removeChild(a); URL.revokeObjectURL(url);
  }
  function importData(file) {
    var reader = new FileReader();
    reader.onload = function(e) {
      try {
        var data = JSON.parse(e.target.result);
        if (!Array.isArray(data)) { alert('æ— æ•ˆçš„æ•°æ®æ ¼å¼'); return; }
        if (!confirm('å¯¼å…¥å°†æ›¿æ¢å½“å‰æ‰€æœ‰æ•°æ®ï¼Œç¡®å®šç»§ç»­å—ï¼Ÿ')) return;
        todos = data.map(function(item,i) {
          if(!item.id) item.id=Date.now()+i; if(!item.category) item.category='other';
          if(item.dueDate===undefined) item.dueDate=''; if(!item.createdAt) item.createdAt=new Date().toISOString();
          if(item.done===undefined) item.done=false; if(!item.text) item.text='';
          if(item.parentId===undefined) item.parentId=null; return item;
        });
        save(); render();
        alert('å¯¼å…¥æˆåŠŸï¼å…± ' + todos.length + ' æ¡è®°å½•');
      } catch(err) { alert('æ–‡ä»¶è§£æå¤±è´¥ï¼š' + err.message); }
    };
    reader.readAsText(file);
  }

  // ===== Voice Input for Smart Add Modal =====
  var SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
  var recognition = null;
  var isListening = false;

  if (SpeechRecognition) {
    recognition = new SpeechRecognition();
    recognition.lang = 'zh-CN';
    recognition.continuous = false;
    recognition.interimResults = true;

    recognition.onstart = function() {
      isListening = true;
      smartMicBtn.classList.add('listening');
      smartParseHint.textContent = 'æ­£åœ¨è†å¬...';
      smartParseHint.style.color = '#7c3aed';
    };

    recognition.onresult = function(event) {
      var transcript = '';
      for (var i = event.resultIndex; i < event.results.length; i++) {
        transcript += event.results[i][0].transcript;
      }
      var current = smartAddText.value;
      if (current && !current.endsWith('\n') && !current.endsWith('ï¼Œ') && !current.endsWith('ã€‚')) {
        smartAddText.value = current + 'ï¼Œ' + transcript;
      } else {
        smartAddText.value = current + transcript;
      }
      if (event.results[event.results.length - 1].isFinal) {
        smartParseHint.textContent = 'è¯­éŸ³å·²å½•å…¥ï¼Œç‚¹å‡» "AI è§£æ" ç”Ÿæˆå¾…åŠ';
        smartParseHint.style.color = '#16a34a';
      }
    };

    recognition.onerror = function(event) {
      isListening = false;
      smartMicBtn.classList.remove('listening');
      smartParseHint.style.color = '#f87171';
      if (event.error === 'not-allowed') {
        smartParseHint.textContent = 'è¯·å…è®¸éº¦å…‹é£æƒé™';
      } else if (event.error === 'no-speech') {
        smartParseHint.textContent = 'æœªæ£€æµ‹åˆ°è¯­éŸ³ï¼Œè¯·é‡è¯•';
      } else {
        smartParseHint.textContent = 'è¯­éŸ³è¯†åˆ«å‡ºé”™: ' + event.error;
      }
    };

    recognition.onend = function() {
      isListening = false;
      smartMicBtn.classList.remove('listening');
    };
  } else {
    smartMicBtn.classList.add('unsupported');
    smartMicBtn.title = 'æ‚¨çš„æµè§ˆå™¨ä¸æ”¯æŒè¯­éŸ³è¾“å…¥';
  }

  function toggleSmartVoice() {
    if (!recognition) { alert('æ‚¨çš„æµè§ˆå™¨ä¸æ”¯æŒè¯­éŸ³è¾“å…¥ï¼Œè¯·ä½¿ç”¨ Chrome'); return; }
    if (isListening) {
      recognition.stop();
    } else {
      recognition.start();
    }
  }

  // ===== Text-to-Speech =====
  function speakText(text) {
    if (!window.speechSynthesis) { alert('æ‚¨çš„æµè§ˆå™¨ä¸æ”¯æŒè¯­éŸ³æœ—è¯»'); return; }
    speechSynthesis.cancel();
    var utterance = new SpeechSynthesisUtterance(text);
    utterance.lang = 'zh-CN';
    utterance.rate = 1.0;
    utterance.onstart = function() { modalSpeakBtn.classList.add('speaking'); modalSpeakBtn.innerHTML = '&#128266;'; };
    utterance.onend = function() { modalSpeakBtn.classList.remove('speaking'); modalSpeakBtn.innerHTML = '&#128264;'; };
    utterance.onerror = function() { modalSpeakBtn.classList.remove('speaking'); modalSpeakBtn.innerHTML = '&#128264;'; };
    speechSynthesis.speak(utterance);
  }

  // ===== Event Listeners =====
  addBtn.addEventListener('click', addTodo);
  input.addEventListener('keydown', function(e) { if(e.key==='Enter') addTodo(); });

  smartAddBtn.addEventListener('click', openSmartAdd);
  smartMicBtn.addEventListener('click', toggleSmartVoice);
  smartParseBtn.addEventListener('click', smartParse);
  smartAddClose.addEventListener('click', closeSmartAdd);

  modalSpeakBtn.addEventListener('click', function() {
    if (speechSynthesis.speaking) {
      speechSynthesis.cancel();
      modalSpeakBtn.classList.remove('speaking');
      modalSpeakBtn.innerHTML = '&#128264;';
    } else {
      var text = document.getElementById('aiModalContent').textContent;
      if (text) speakText(text);
    }
  });

  document.querySelectorAll('.filter-btn').forEach(function(btn) {
    btn.addEventListener('click', function() {
      document.querySelectorAll('.filter-btn').forEach(function(b){b.classList.remove('active');});
      btn.classList.add('active');
      currentFilter = btn.getAttribute('data-filter');
      render();
    });
  });

  searchInput.addEventListener('input', render);
  catFilter.addEventListener('change', render);

  exportBtn.addEventListener('click', exportData);
  importBtn.addEventListener('click', function() { importFile.click(); });
  importFile.addEventListener('change', function() { if(this.files&&this.files[0]){importData(this.files[0]);this.value='';} });

  aiBreakdownBtn.addEventListener('click', aiBreakdown);
  aiExecuteBtn.addEventListener('click', function() { aiExecuteSelected(); });
  aiPlanBtn.addEventListener('click', aiDailyPlan);

  renderKeyArea();
  render();
})();
</script>

</body>
</html>
