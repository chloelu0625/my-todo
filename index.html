<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>待办事项</title>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<style>
  * { margin: 0; padding: 0; box-sizing: border-box; }

  body {
    font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
    background: linear-gradient(135deg, #e0f2fe 0%, #f0fdf4 50%, #fef9c3 100%);
    min-height: 100vh;
    display: flex;
    justify-content: center;
    padding: 40px 16px;
  }

  .container { width: 100%; max-width: 580px; align-self: flex-start; }

  .card {
    background: #fff;
    border-radius: 16px;
    box-shadow: 0 8px 30px rgba(0,0,0,0.08), inset 0 1px 0 rgba(255,255,255,0.6);
    padding: 32px 28px;
  }

  h1 { font-size: 26px; font-weight: 700; color: #1e293b; text-align: center; margin-bottom: 24px; }

  /* ===== Auth Overlay ===== */
  .auth-overlay {
    position: fixed; top: 0; left: 0; right: 0; bottom: 0;
    background: linear-gradient(135deg, #e0f2fe 0%, #f0fdf4 50%, #fef9c3 100%);
    z-index: 2000; display: flex; align-items: center; justify-content: center;
  }
  .auth-overlay.hidden { display: none; }
  .auth-box {
    background: #fff; border-radius: 16px; padding: 36px 32px; width: 90%; max-width: 400px;
    box-shadow: 0 8px 30px rgba(0,0,0,0.1);
  }
  .auth-box h2 { text-align: center; font-size: 24px; color: #1e293b; margin-bottom: 6px; }
  .auth-box .auth-subtitle { text-align: center; font-size: 13px; color: #94a3b8; margin-bottom: 20px; }
  .auth-tabs { display: flex; gap: 0; margin-bottom: 20px; border-bottom: 2px solid #e2e8f0; }
  .auth-tab {
    flex: 1; padding: 10px; text-align: center; font-size: 14px; font-weight: 600;
    color: #94a3b8; background: none; border: none; cursor: pointer;
    border-bottom: 2px solid transparent; margin-bottom: -2px; transition: all 0.2s;
  }
  .auth-tab.active { color: #3b82f6; border-bottom-color: #3b82f6; }
  .auth-tab:hover { color: #3b82f6; }
  .auth-field { margin-bottom: 14px; }
  .auth-field label { display: block; font-size: 13px; font-weight: 500; color: #64748b; margin-bottom: 5px; }
  .auth-field input {
    width: 100%; padding: 10px 14px; border: 2px solid #e2e8f0; border-radius: 10px;
    font-size: 14px; outline: none; transition: border-color 0.2s;
  }
  .auth-field input:focus { border-color: #60a5fa; }
  .auth-submit {
    width: 100%; padding: 12px; background: #3b82f6; color: #fff; border: none; border-radius: 10px;
    font-size: 15px; font-weight: 600; cursor: pointer; transition: background 0.2s; margin-top: 6px;
  }
  .auth-submit:hover { background: #2563eb; }
  .auth-submit:disabled { opacity: 0.5; cursor: not-allowed; }
  .auth-error { color: #dc2626; font-size: 13px; margin-top: 10px; text-align: center; min-height: 20px; }
  .auth-loading { text-align: center; color: #94a3b8; font-size: 14px; padding: 20px 0; }

  /* ===== User Bar ===== */
  .user-bar {
    display: flex; align-items: center; justify-content: flex-end; gap: 10px;
    margin-bottom: 16px; padding: 0 2px;
  }
  .user-bar .user-email { font-size: 12px; color: #64748b; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; max-width: 200px; }
  .user-bar .logout-btn {
    padding: 4px 12px; border: 1.5px solid #e2e8f0; border-radius: 6px; background: #fff;
    font-size: 12px; cursor: pointer; color: #64748b; transition: all 0.2s;
  }
  .user-bar .logout-btn:hover { border-color: #fca5a5; color: #dc2626; background: #fef2f2; }

  /* ===== Input Row ===== */
  .input-row { display: flex; gap: 8px; margin-bottom: 12px; flex-wrap: wrap; }
  .input-row input[type="text"] {
    flex: 1; min-width: 160px; padding: 10px 14px; border: 2px solid #e2e8f0;
    border-radius: 10px; font-size: 15px; outline: none; transition: border-color 0.2s;
  }
  .input-row input[type="text"]:focus { border-color: #60a5fa; }
  .input-row input[type="date"] {
    padding: 10px 10px; border: 2px solid #e2e8f0; border-radius: 10px; font-size: 13px;
    outline: none; transition: border-color 0.2s; color: #64748b; max-width: 150px;
  }
  .input-row input[type="date"]:focus { border-color: #60a5fa; }
  .input-row select {
    padding: 10px 10px; border: 2px solid #e2e8f0; border-radius: 10px; font-size: 13px;
    outline: none; background: #fff; cursor: pointer; color: #64748b; transition: border-color 0.2s;
  }
  .input-row select:focus { border-color: #60a5fa; }
  .input-row .add-btn {
    padding: 10px 18px; background: #3b82f6; color: #fff; border: none; border-radius: 10px;
    font-size: 15px; font-weight: 600; cursor: pointer; transition: background 0.2s; white-space: nowrap;
  }
  .input-row .add-btn:hover { background: #2563eb; }
  .mic-btn {
    padding: 10px 14px; background: #f1f5f9; border: 2px solid #e2e8f0; border-radius: 10px;
    font-size: 16px; cursor: pointer; transition: all 0.2s; line-height: 1; flex-shrink: 0;
  }
  .mic-btn:hover { background: #e2e8f0; }
  .mic-btn.listening { background: #fee2e2; border-color: #fca5a5; animation: pulse 1s ease-in-out infinite; }
  .mic-btn.unsupported { opacity: 0.3; cursor: not-allowed; }
  .speak-btn {
    background: none; border: none; font-size: 16px; cursor: pointer; padding: 2px 6px;
    opacity: 0.5; transition: opacity 0.2s; vertical-align: middle;
  }
  .speak-btn:hover { opacity: 1; }
  .speak-btn.speaking { opacity: 1; animation: pulse 1s ease-in-out infinite; }
  .smart-add-trigger {
    padding: 10px 14px; background: #f5f3ff; border: 2px solid #c4b5fd; border-radius: 10px;
    font-size: 15px; cursor: pointer; color: #7c3aed; font-weight: 600; transition: all 0.2s;
    white-space: nowrap; line-height: 1; flex-shrink: 0;
  }
  .smart-add-trigger:hover { background: #ede9fe; border-color: #a78bfa; }
  .smart-modal-textarea {
    width: 100%; min-height: 120px; padding: 12px; padding-right: 50px; border: 2px solid #e2e8f0;
    border-radius: 10px; font-size: 14px; resize: vertical; outline: none; font-family: inherit;
    transition: border-color 0.2s; line-height: 1.6;
  }
  .smart-modal-textarea:focus { border-color: #a78bfa; }
  .smart-modal-actions { display: flex; gap: 10px; margin-top: 12px; align-items: center; }
  .smart-parse-btn {
    padding: 8px 20px; background: #7c3aed; color: #fff; border: none; border-radius: 8px;
    font-size: 14px; font-weight: 600; cursor: pointer; transition: background 0.2s;
  }
  .smart-parse-btn:hover { background: #6d28d9; }
  .smart-parse-btn:disabled { opacity: 0.5; cursor: not-allowed; }
  .smart-parse-btn.loading { animation: pulse 1.2s ease-in-out infinite; }
  .smart-parse-hint { font-size: 12px; color: #94a3b8; }

  /* ===== Filter Toolbar ===== */
  .toolbar { display: flex; gap: 8px; margin-bottom: 16px; flex-wrap: wrap; align-items: center; }
  .toolbar .search-input {
    flex: 1; min-width: 120px; padding: 7px 12px; border: 1.5px solid #e2e8f0;
    border-radius: 8px; font-size: 13px; outline: none; transition: border-color 0.2s;
  }
  .toolbar .search-input:focus { border-color: #60a5fa; }
  .filter-btns { display: flex; gap: 4px; }
  .filter-btn {
    padding: 5px 12px; border: 1.5px solid #e2e8f0; border-radius: 8px; background: #fff;
    font-size: 12px; cursor: pointer; color: #64748b; transition: all 0.2s; white-space: nowrap;
  }
  .filter-btn:hover { border-color: #93c5fd; color: #3b82f6; }
  .filter-btn.active { background: #3b82f6; color: #fff; border-color: #3b82f6; }
  .toolbar select {
    padding: 5px 8px; border: 1.5px solid #e2e8f0; border-radius: 8px; font-size: 12px;
    background: #fff; cursor: pointer; color: #64748b; outline: none;
  }

  /* ===== Todo List ===== */
  .todo-list { list-style: none; }
  .todo-item {
    display: flex; align-items: center; gap: 10px; padding: 12px 4px;
    border-bottom: 1px solid #f1f5f9; animation: fadeIn 0.25s ease;
    transition: opacity 0.2s, background 0.15s; border-radius: 8px;
  }
  .todo-item:last-child { border-bottom: none; }
  .todo-item.dragging { opacity: 0.4; background: #f0f9ff; }
  .todo-item.drag-over { border-top: 2px solid #3b82f6; }
  @keyframes fadeIn { from { opacity:0; transform:translateY(-6px); } to { opacity:1; transform:translateY(0); } }

  .drag-handle { cursor: grab; color: #cbd5e1; font-size: 14px; user-select: none; flex-shrink: 0; padding: 2px; transition: color 0.2s; line-height: 1; }
  .drag-handle:hover { color: #94a3b8; }
  .drag-handle:active { cursor: grabbing; }

  .todo-checkbox {
    width: 18px; height: 18px; cursor: pointer; flex-shrink: 0; accent-color: #7c3aed;
  }
  .complete-btn {
    padding: 3px 10px; border-radius: 6px; font-size: 11px; font-weight: 500; cursor: pointer;
    border: 1.5px solid #d1d5db; background: #fff; color: #64748b; transition: all 0.2s; flex-shrink: 0; white-space: nowrap;
  }
  .complete-btn:hover { border-color: #34d399; color: #16a34a; background: #f0fdf4; }
  .complete-btn.is-done { border-color: #bbf7d0; background: #dcfce7; color: #16a34a; }

  .select-bar {
    display: flex; gap: 8px; align-items: center; padding: 8px 12px; margin-bottom: 10px;
    background: #f5f3ff; border: 1.5px solid #e9d5ff; border-radius: 10px; flex-wrap: wrap;
  }
  .select-bar .select-count { font-size: 13px; font-weight: 600; color: #7c3aed; margin-right: 4px; }
  .select-bar .select-action {
    padding: 4px 12px; border: 1.5px solid #c4b5fd; border-radius: 6px; background: #faf5ff;
    font-size: 11px; cursor: pointer; color: #7c3aed; font-weight: 500; transition: all 0.2s;
  }
  .select-bar .select-action:hover { background: #ede9fe; border-color: #a78bfa; }
  .select-bar .select-action.danger { border-color: #fca5a5; color: #dc2626; background: #fef2f2; }
  .select-bar .select-action.danger:hover { background: #fee2e2; }
  .select-bar .select-cancel { background: none; border: none; color: #94a3b8; font-size: 12px; cursor: pointer; margin-left: auto; }

  .todo-item.subtask { margin-left: 28px; border-left: 2px solid #e9d5ff; padding-left: 12px; }
  .todo-item.subtask .todo-text { font-size: 13px; }

  .item-content { flex: 1; min-width: 0; }
  .todo-text { font-size: 14px; color: #334155; word-break: break-word; transition: color 0.2s; }
  .todo-text.done { text-decoration: line-through; color: #94a3b8; }
  .item-meta { display: flex; gap: 6px; margin-top: 4px; flex-wrap: wrap; align-items: center; }

  .cat-badge { display: inline-block; padding: 1px 8px; border-radius: 10px; font-size: 11px; font-weight: 500; line-height: 1.6; }
  .cat-work { background: #dbeafe; color: #2563eb; }
  .cat-life { background: #dcfce7; color: #16a34a; }
  .cat-study { background: #f3e8ff; color: #9333ea; }
  .cat-other { background: #f1f5f9; color: #64748b; }

  .due-badge { display: inline-block; padding: 1px 8px; border-radius: 10px; font-size: 11px; font-weight: 500; line-height: 1.6; }
  .due-overdue { background: #fee2e2; color: #dc2626; }
  .due-today { background: #ffedd5; color: #ea580c; }
  .due-future { background: #f1f5f9; color: #64748b; }

  .del-btn, .edit-btn { background: none; border: none; color: #cbd5e1; cursor: pointer; padding: 4px; line-height: 1; transition: color 0.2s; flex-shrink: 0; }
  .del-btn { font-size: 16px; }
  .del-btn:hover { color: #f87171; }
  .edit-btn { font-size: 14px; }
  .edit-btn:hover { color: #60a5fa; }

  /* Inline Edit */
  .edit-row { display: flex; gap: 6px; flex-wrap: wrap; align-items: center; width: 100%; }
  .edit-row input[type="text"] { flex:1; min-width:100px; padding:6px 10px; border:1.5px solid #93c5fd; border-radius:6px; font-size:14px; outline:none; }
  .edit-row input[type="date"] { padding:6px 8px; border:1.5px solid #93c5fd; border-radius:6px; font-size:12px; outline:none; max-width:140px; }
  .edit-row select { padding:6px 8px; border:1.5px solid #93c5fd; border-radius:6px; font-size:12px; outline:none; background:#fff; }
  .edit-row .save-edit-btn { padding:5px 12px; background:#34d399; color:#fff; border:none; border-radius:6px; font-size:12px; font-weight:600; cursor:pointer; }
  .edit-row .cancel-edit-btn { padding:5px 12px; background:#e2e8f0; color:#64748b; border:none; border-radius:6px; font-size:12px; cursor:pointer; }

  /* Stats & Empty */
  .stats { text-align: center; margin-top: 16px; font-size: 13px; color: #94a3b8; }
  .empty { text-align: center; padding: 32px 0; color: #cbd5e1; font-size: 14px; }

  /* Date Group Header */
  .date-header { display: flex; align-items: center; gap: 10px; padding: 10px 4px 6px; margin-top: 8px; font-size: 13px; font-weight: 600; color: #64748b; }
  .date-header:first-child { margin-top: 0; }
  .date-header-line { flex: 1; height: 1px; background: #e2e8f0; }
  .date-header-label { white-space: nowrap; }
  .date-header-label.is-overdue { color: #dc2626; }
  .date-header-label.is-today { color: #ea580c; font-weight: 700; }

  /* ===== Footer ===== */
  .footer-bar { display: flex; justify-content: center; gap: 8px; margin-top: 16px; padding-top: 14px; border-top: 1px solid #f1f5f9; flex-wrap: wrap; }
  .footer-btn {
    padding: 6px 14px; border: 1.5px solid #e2e8f0; border-radius: 8px; background: #fff;
    font-size: 12px; cursor: pointer; color: #64748b; transition: all 0.2s;
  }
  .footer-btn:hover { border-color: #93c5fd; color: #3b82f6; }

  /* ===== AI Section ===== */
  .ai-section {
    margin-top: 20px; padding-top: 16px; border-top: 2px solid #e0f2fe;
  }
  .ai-section h2 {
    font-size: 15px; font-weight: 700; color: #7c3aed; margin-bottom: 12px; display: flex; align-items: center; gap: 6px;
  }
  .ai-bar { display: flex; gap: 8px; flex-wrap: wrap; margin-bottom: 10px; }
  .ai-btn {
    padding: 7px 14px; border: 1.5px solid #c4b5fd; border-radius: 8px; background: #faf5ff;
    font-size: 12px; cursor: pointer; color: #7c3aed; font-weight: 500; transition: all 0.2s;
  }
  .ai-btn:hover { background: #ede9fe; border-color: #a78bfa; }
  .ai-btn:disabled { opacity: 0.5; cursor: not-allowed; }
  .ai-btn.loading { animation: pulse 1.2s ease-in-out infinite; }
  @keyframes pulse { 0%,100% { opacity:1; } 50% { opacity:0.5; } }

  .ai-key-hint { font-size: 11px; color: #94a3b8; margin-bottom: 10px; }

  .ai-result {
    background: #faf5ff; border: 1px solid #e9d5ff; border-radius: 10px; padding: 14px 16px;
    font-size: 13px; line-height: 1.7; color: #334155; white-space: pre-wrap; max-height: 350px;
    overflow-y: auto; margin-top: 8px;
  }
  .ai-result .ai-task-item {
    display: flex; align-items: center; gap: 8px; padding: 6px 0; border-bottom: 1px solid #f3e8ff;
  }
  .ai-result .ai-task-item:last-child { border-bottom: none; }
  .ai-add-btn {
    padding: 3px 10px; background: #7c3aed; color: #fff; border: none; border-radius: 6px;
    font-size: 11px; cursor: pointer; white-space: nowrap; flex-shrink: 0;
  }
  .ai-add-btn:hover { background: #6d28d9; }

  /* ===== Modal ===== */
  .modal-overlay {
    display: none; position: fixed; top:0; left:0; right:0; bottom:0;
    background: rgba(0,0,0,0.4); z-index: 1000; align-items: center; justify-content: center;
  }
  .modal-overlay.show { display: flex; }
  .modal-box {
    background: #fff; border-radius: 14px; padding: 28px; width: 90%; max-width: 480px;
    box-shadow: 0 20px 60px rgba(0,0,0,0.2); max-height: 80vh; overflow-y: auto;
  }
  .modal-box h3 { font-size: 18px; margin-bottom: 14px; color: #7c3aed; }
  .modal-box .ai-result { max-height: 50vh; }
  .modal-close {
    display: block; margin: 14px auto 0; padding: 8px 24px; background: #e2e8f0; border: none;
    border-radius: 8px; font-size: 13px; cursor: pointer; color: #64748b;
  }

  /* ===== Responsive ===== */
  @media (max-width: 480px) {
    body { padding: 16px 8px; }
    .card { padding: 20px 16px; }
    .input-row input[type="date"] { max-width: 130px; }
  }
</style>
</head>
<body>

<!-- Auth Overlay -->
<div class="auth-overlay" id="authOverlay">
  <div class="auth-box">
    <h2>&#128221; 待办事项</h2>
    <p class="auth-subtitle">登录后数据云端同步，多设备访问</p>
    <div class="auth-tabs">
      <button class="auth-tab active" id="loginTab">登录</button>
      <button class="auth-tab" id="registerTab">注册</button>
    </div>
    <div id="authForm">
      <div class="auth-field">
        <label for="authEmail">邮箱</label>
        <input type="email" id="authEmail" placeholder="your@email.com" autocomplete="email">
      </div>
      <div class="auth-field">
        <label for="authPassword">密码</label>
        <input type="password" id="authPassword" placeholder="至少6位密码" autocomplete="current-password">
      </div>
      <button class="auth-submit" id="authSubmit">登录</button>
      <div class="auth-error" id="authError"></div>
    </div>
    <div class="auth-loading hidden" id="authLoading">正在检查登录状态...</div>
  </div>
</div>

<div class="container">
  <div class="card">
    <div class="user-bar" id="userBar" style="display:none">
      <span class="user-email" id="userEmail"></span>
      <button class="logout-btn" id="logoutBtn">退出登录</button>
    </div>

    <h1>&#128221; 待办事项</h1>

    <div class="input-row">
      <input id="todoInput" type="text" placeholder="添加新的待办事项..." autocomplete="off">
      <input id="dueDateInput" type="date" title="截止日期">
      <select id="categoryInput" title="分类">
        <option value="other">其他</option>
        <option value="work">工作</option>
        <option value="life">生活</option>
        <option value="study">学习</option>
      </select>
      <button class="add-btn" id="addBtn">添加</button>
      <button class="smart-add-trigger" id="smartAddBtn" title="智能添加 / 语音输入">&#x2728; 智能添加（支持语音）</button>
    </div>

    <div class="toolbar">
      <input class="search-input" id="searchInput" type="text" placeholder="搜索..." autocomplete="off">
      <div class="filter-btns">
        <button class="filter-btn active" data-filter="all">全部</button>
        <button class="filter-btn" data-filter="active">未完成</button>
        <button class="filter-btn" data-filter="done">已完成</button>
      </div>
      <select id="catFilter" title="按分类筛选">
        <option value="all">全部分类</option>
        <option value="work">工作</option>
        <option value="life">生活</option>
        <option value="study">学习</option>
        <option value="other">其他</option>
      </select>
    </div>

    <div id="selectBar" class="select-bar" style="display:none"></div>
    <ul class="todo-list" id="todoList"></ul>
    <div class="stats" id="stats"></div>

    <!-- AI Section -->
    <div class="ai-section">
      <h2>&#x2728; AI 助手</h2>
      <div id="aiKeyArea"></div>
      <div class="ai-bar">
        <button class="ai-btn" id="aiBreakdownBtn" title="拆解选中任务或输入新任务">&#127919; 拆解任务</button>
        <button class="ai-btn" id="aiExecuteBtn" title="AI 生成选中任务的执行步骤">&#9889; 任务执行</button>
        <button class="ai-btn" id="aiPlanBtn" title="AI 根据待办生成今日规划">&#128197; 每日规划</button>
      </div>
      <div id="aiResult"></div>
    </div>

    <div class="footer-bar">
      <button class="footer-btn" id="exportBtn">&#128230; 导出</button>
      <button class="footer-btn" id="importBtn">&#128229; 导入</button>
      <input type="file" id="importFile" accept=".json" style="display:none">
    </div>
  </div>
</div>

<!-- AI Plan Modal -->
<div class="modal-overlay" id="aiModal">
  <div class="modal-box">
    <h3 id="aiModalTitle">AI 规划 <button class="speak-btn" id="modalSpeakBtn" title="朗读">&#128264;</button></h3>
    <div class="ai-result" id="aiModalContent"></div>
    <div style="display:flex;gap:8px;justify-content:center;margin-top:14px">
      <button class="modal-close" onclick="document.getElementById('aiModal').classList.remove('show');speechSynthesis.cancel()">关闭</button>
    </div>
  </div>
</div>

<!-- Smart Add Modal -->
<div class="modal-overlay" id="smartAddModal">
  <div class="modal-box">
    <h3>&#x2728; 智能添加</h3>
    <p style="font-size:13px;color:#64748b;margin-bottom:12px">粘贴文字或语音输入，AI 自动识别并生成待办事项</p>
    <div style="position:relative">
      <textarea class="smart-modal-textarea" id="smartAddText" placeholder="在此粘贴或输入文字...&#10;例如：明天下午开会讨论项目进度，后天交周报，今天买菜做饭"></textarea>
      <button class="mic-btn" id="smartMicBtn" style="position:absolute;right:8px;bottom:8px" title="语音输入">&#127908;</button>
    </div>
    <div class="smart-modal-actions">
      <button class="smart-parse-btn" id="smartParseBtn">&#129302; AI 解析</button>
      <span class="smart-parse-hint" id="smartParseHint"></span>
    </div>
    <div id="smartAddResult"></div>
    <div style="display:flex;gap:8px;justify-content:center;margin-top:14px">
      <button class="modal-close" id="smartAddClose">关闭</button>
    </div>
  </div>
</div>

<script>
(function () {
  // ===== Supabase Configuration =====
  var SUPABASE_URL = 'https://cokplvhmunogtjubuuud.supabase.co';
  var SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImNva3BsdmhtdW5vZ3RqdWJ1dXVkIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzA2MjE2NzksImV4cCI6MjA4NjE5NzY3OX0.dLYyQzWk8r-CLaitelSPrgQZPnrRwpRaGJ3SIeJKeGs';
  var supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
  var currentUser = null;

  // ===== Auth =====
  var authOverlay = document.getElementById('authOverlay');
  var authLoading = document.getElementById('authLoading');
  var authForm = document.getElementById('authForm');
  var loginTab = document.getElementById('loginTab');
  var registerTab = document.getElementById('registerTab');
  var authEmail = document.getElementById('authEmail');
  var authPassword = document.getElementById('authPassword');
  var authSubmit = document.getElementById('authSubmit');
  var authError = document.getElementById('authError');
  var userBar = document.getElementById('userBar');
  var userEmailEl = document.getElementById('userEmail');
  var logoutBtn = document.getElementById('logoutBtn');

  var isLoginMode = true;

  loginTab.addEventListener('click', function() {
    isLoginMode = true;
    loginTab.classList.add('active');
    registerTab.classList.remove('active');
    authSubmit.textContent = '登录';
    authError.textContent = '';
  });

  registerTab.addEventListener('click', function() {
    isLoginMode = false;
    registerTab.classList.add('active');
    loginTab.classList.remove('active');
    authSubmit.textContent = '注册';
    authError.textContent = '';
  });

  authPassword.addEventListener('keydown', function(e) {
    if (e.key === 'Enter') authSubmit.click();
  });

  authSubmit.addEventListener('click', async function() {
    var email = authEmail.value.trim();
    var password = authPassword.value;
    if (!email || !password) { authError.textContent = '请填写邮箱和密码'; return; }
    if (password.length < 6) { authError.textContent = '密码至少6位'; return; }

    authSubmit.disabled = true;
    authError.textContent = '';

    try {
      var result;
      if (isLoginMode) {
        result = await supabaseClient.auth.signInWithPassword({ email: email, password: password });
      } else {
        result = await supabaseClient.auth.signUp({ email: email, password: password });
      }

      if (result.error) {
        var msg = result.error.message;
        if (msg.includes('Invalid login')) msg = '邮箱或密码错误';
        else if (msg.includes('already registered')) msg = '该邮箱已注册，请直接登录';
        else if (msg.includes('Email not confirmed')) msg = '请先前往邮箱验证账号';
        else if (msg.includes('Password should')) msg = '密码至少6位';
        authError.textContent = msg;
      } else if (result.data && result.data.user) {
        if (!isLoginMode && result.data.user.identities && result.data.user.identities.length === 0) {
          authError.textContent = '该邮箱已注册，请直接登录';
        } else if (!isLoginMode && !result.data.session) {
          authError.textContent = '注册成功！请前往邮箱点击验证链接后登录';
          authError.style.color = '#16a34a';
        }
        // onAuthStateChange will handle the rest
      }
    } catch(e) {
      authError.textContent = '网络错误，请重试';
    }
    authSubmit.disabled = false;
  });

  logoutBtn.addEventListener('click', async function() {
    if (!supabaseClient) return;
    await supabaseClient.auth.signOut();
    // onAuthStateChange will handle UI
  });

  function showApp(user) {
    currentUser = user;
    authOverlay.classList.add('hidden');
    userBar.style.display = 'flex';
    userEmailEl.textContent = user.email;
    loadTodosFromDB();
  }

  function showAuth() {
    currentUser = null;
    todos = [];
    authOverlay.classList.remove('hidden');
    authForm.classList.remove('hidden');
    authLoading.classList.add('hidden');
    userBar.style.display = 'none';
    render();
  }

  async function checkAuth() {
    authForm.classList.add('hidden');
    authLoading.classList.remove('hidden');

    try {
      var { data: { session } } = await supabaseClient.auth.getSession();
      if (session && session.user) {
        showApp(session.user);
      } else {
        showAuth();
      }
    } catch(e) {
      showAuth();
    }

    // Listen for auth state changes
    supabaseClient.auth.onAuthStateChange(function(event, session) {
      if (event === 'SIGNED_IN' && session && session.user) {
        showApp(session.user);
      } else if (event === 'SIGNED_OUT') {
        showAuth();
      }
    });
  }

  // ===== DOM refs =====
  var input = document.getElementById('todoInput');
  var dueDateInput = document.getElementById('dueDateInput');
  var categoryInput = document.getElementById('categoryInput');
  var addBtn = document.getElementById('addBtn');
  var listEl = document.getElementById('todoList');
  var statsEl = document.getElementById('stats');
  var searchInput = document.getElementById('searchInput');
  var catFilter = document.getElementById('catFilter');
  var exportBtn = document.getElementById('exportBtn');
  var importBtn = document.getElementById('importBtn');
  var importFile = document.getElementById('importFile');
  var aiKeyArea = document.getElementById('aiKeyArea');
  var aiResultEl = document.getElementById('aiResult');
  var modalSpeakBtn = document.getElementById('modalSpeakBtn');
  var aiBreakdownBtn = document.getElementById('aiBreakdownBtn');
  var aiExecuteBtn = document.getElementById('aiExecuteBtn');
  var aiPlanBtn = document.getElementById('aiPlanBtn');
  var selectBar = document.getElementById('selectBar');
  var smartAddBtn = document.getElementById('smartAddBtn');
  var smartAddModal = document.getElementById('smartAddModal');
  var smartAddText = document.getElementById('smartAddText');
  var smartMicBtn = document.getElementById('smartMicBtn');
  var smartParseBtn = document.getElementById('smartParseBtn');
  var smartParseHint = document.getElementById('smartParseHint');
  var smartAddResult = document.getElementById('smartAddResult');
  var smartAddClose = document.getElementById('smartAddClose');

  var currentFilter = 'all';
  var dragSrcIndex = null;
  var editingId = null;
  var selectedIds = new Set();

  var CATEGORIES = { work: '工作', life: '生活', study: '学习', other: '其他' };
  var CAT_KEYS = ['work', 'life', 'study', 'other'];

  // ===== Data =====
  var todos = [];

  async function loadTodosFromDB() {
    if (!supabaseClient || !currentUser) return;
    try {
      var { data, error } = await supabaseClient
        .from('todos')
        .select('*')
        .order('sort_order', { ascending: true });
      if (error) { console.error('Load error:', error); return; }
      todos = (data || []).map(function(row) {
        return {
          id: row.id,
          text: row.text,
          done: row.done || false,
          category: row.category || 'other',
          dueDate: row.due_date || '',
          createdAt: row.created_at || new Date().toISOString(),
          parentId: row.parent_id || null,
          sortOrder: row.sort_order || 0
        };
      });
      render();
    } catch(e) {
      console.error('Load error:', e);
    }
  }

  async function saveTodoDB(todo) {
    if (!supabaseClient || !currentUser) return;
    var row = {
      id: todo.id,
      user_id: currentUser.id,
      text: todo.text,
      done: todo.done,
      category: todo.category,
      due_date: todo.dueDate || '',
      parent_id: todo.parentId || null,
      sort_order: todo.sortOrder || 0
    };
    var { error } = await supabaseClient.from('todos').upsert(row);
    if (error) console.error('Save error:', error);
  }

  async function deleteTodoDB(id) {
    if (!supabaseClient || !currentUser) return;
    var { error } = await supabaseClient.from('todos').delete().eq('id', id);
    if (error) console.error('Delete error:', error);
  }

  async function updateTodoDB(id, fields) {
    if (!supabaseClient || !currentUser) return;
    var dbFields = {};
    if ('done' in fields) dbFields.done = fields.done;
    if ('text' in fields) dbFields.text = fields.text;
    if ('category' in fields) dbFields.category = fields.category;
    if ('dueDate' in fields) dbFields.due_date = fields.dueDate;
    if ('parentId' in fields) dbFields.parent_id = fields.parentId;
    if ('sortOrder' in fields) dbFields.sort_order = fields.sortOrder;
    var { error } = await supabaseClient.from('todos').update(dbFields).eq('id', id);
    if (error) console.error('Update error:', error);
  }

  async function saveAllSortOrders() {
    if (!supabaseClient || !currentUser) return;
    var promises = todos.map(function(t, i) {
      t.sortOrder = i;
      return supabaseClient.from('todos').update({ sort_order: i }).eq('id', t.id);
    });
    await Promise.all(promises);
  }

  // ===== Date Helpers =====
  function todayStr() {
    var d = new Date();
    return d.getFullYear() + '-' + String(d.getMonth()+1).padStart(2,'0') + '-' + String(d.getDate()).padStart(2,'0');
  }
  function formatDate(s) { if (!s) return ''; var p=s.split('-'); return p[1]+'/'+p[2]; }
  function formatDateFull(s) {
    if (!s) return '未设定日期';
    var today = todayStr(), p = s.split('-');
    var wd = ['日','一','二','三','四','五','六'];
    var d = new Date(+p[0], +p[1]-1, +p[2]);
    var label = p[0]+'年'+parseInt(p[1])+'月'+parseInt(p[2])+'日 周'+wd[d.getDay()];
    if (s === today) label = '今天 - ' + label;
    return label;
  }
  function dateHeaderClass(s) { if(!s) return ''; var t=todayStr(); if(s<t) return 'is-overdue'; if(s===t) return 'is-today'; return ''; }
  function dueDateClass(s,done) { if(!s||done) return 'due-future'; var t=todayStr(); if(s<t) return 'due-overdue'; if(s===t) return 'due-today'; return 'due-future'; }

  // ===== AI Configuration =====
  var API_BACKEND = 'https://my-todo-api-sooty.vercel.app/api/chat';

  function renderKeyArea() {
    aiKeyArea.innerHTML = '<div class="ai-key-hint">AI 已就绪 &#x2705;</div>';
  }

  // ===== AI API Call =====
  function callAI(prompt, callback) {
    fetch(API_BACKEND, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ prompt: prompt })
    })
    .then(function(r) { return r.json(); })
    .then(function(data) {
      if (data.error) { callback(null, data.error); return; }
      callback(data.text || '', null);
    })
    .catch(function(err) { callback(null, err.message); });
  }

  // ===== AI Feature 1: Task Breakdown =====
  function aiBreakdown() {
    var sel = getSelectedTodos();
    if (sel.length > 0) { aiBreakdownSelected(); return; }
    var task = prompt('请输入要拆解的大任务：');
    if (!task) return;
    doBreakdown(task, null);
  }

  function aiBreakdownSelected() {
    var sel = getSelectedTodos();
    if (sel.length === 0) { alert('请先勾选要拆解的任务'); return; }
    var taskText = sel.map(function(t) { return t.text; }).join('、');
    var parentId = sel.length === 1 ? sel[0].id : null;
    doBreakdown(taskText, parentId);
  }

  function doBreakdown(task, parentId) {
    aiBreakdownBtn.disabled = true;
    aiBreakdownBtn.classList.add('loading');
    aiBreakdownBtn.textContent = '拆解中...';

    var today = todayStr();
    var p = '你是一个任务管理助手。用户输入了一个大任务（可能包含多个），请将其拆解为3-7个具体的子任务。\n\n' +
      '今天日期: ' + today + '\n' +
      '任务: ' + task + '\n\n' +
      '请以JSON数组格式返回，每个子任务包含:\n' +
      '- text: 子任务描述（简洁，中文）\n' +
      '- category: 分类（work/life/study/other 之一）\n' +
      '- dueDate: 建议截止日期（YYYY-MM-DD格式，根据合理性安排）\n\n' +
      '只返回JSON数组，不要其他内容。示例:\n' +
      '[{"text":"调研竞品","category":"work","dueDate":"2026-02-10"}]';

    callAI(p, function(text, err) {
      aiBreakdownBtn.disabled = false;
      aiBreakdownBtn.classList.remove('loading');
      aiBreakdownBtn.textContent = '\u{1F3AF} 拆解任务';

      if (err) { aiResultEl.innerHTML = '<div class="ai-result">错误: ' + err + '</div>'; return; }

      try {
        var match = text.match(/\[[\s\S]*\]/);
        var tasks = JSON.parse(match[0]);
        var html = '<div class="ai-result">';
        html += '<div style="font-weight:600;margin-bottom:8px;color:#7c3aed">AI 拆解: ' + task + '</div>';
        tasks.forEach(function(t, i) {
          html += '<div class="ai-task-item">' +
            '<span style="flex:1">' + (i+1) + '. ' + t.text +
            ' <span class="cat-badge cat-' + (t.category||'other') + '">' + (CATEGORIES[t.category]||'其他') + '</span>' +
            (t.dueDate ? ' <span class="due-badge due-future">' + formatDate(t.dueDate) + '</span>' : '') +
            '</span>' +
            '<button class="ai-add-btn" data-idx="' + i + '">+ 添加</button></div>';
        });
        html += '</div>';
        aiResultEl.innerHTML = html;

        var addAllHtml = '<div style="margin-top:8px;text-align:right"><button class="ai-add-btn" id="aiAddAll">全部添加为子任务</button></div>';
        aiResultEl.querySelector('.ai-result').insertAdjacentHTML('beforeend', addAllHtml);

        async function addSubtask(idx, btnEl) {
          var t = tasks[idx];
          var newTodo = {
            id: Date.now() + idx, text: t.text, done: false,
            category: t.category || 'other', dueDate: t.dueDate || '',
            createdAt: new Date().toISOString(), parentId: parentId || null,
            sortOrder: todos.length + idx
          };
          todos.push(newTodo);
          await saveTodoDB(newTodo);
          if (btnEl) { btnEl.textContent = '已添加'; btnEl.disabled = true; btnEl.style.background = '#94a3b8'; }
        }

        aiResultEl.querySelectorAll('.ai-add-btn[data-idx]').forEach(function(btn) {
          btn.addEventListener('click', async function() {
            await addSubtask(parseInt(this.getAttribute('data-idx')), this);
            render();
          });
        });

        document.getElementById('aiAddAll').addEventListener('click', async function() {
          var btns = aiResultEl.querySelectorAll('.ai-add-btn[data-idx]');
          for (var i = 0; i < tasks.length; i++) {
            if (btns[i] && btns[i].disabled) continue;
            await addSubtask(i, null);
          }
          render();
          this.textContent = '已全部添加'; this.disabled = true; this.style.background = '#94a3b8';
          aiResultEl.querySelectorAll('.ai-add-btn[data-idx]').forEach(function(b) {
            b.textContent = '已添加'; b.disabled = true; b.style.background = '#94a3b8';
          });
        });
      } catch(e) {
        aiResultEl.innerHTML = '<div class="ai-result">' + text + '</div>';
      }
    });
  }

  // ===== AI Feature: Task Execution =====
  function aiExecuteSelected() {
    var sel = getSelectedTodos();
    if (sel.length === 0) { alert('请先勾选要执行的任务'); return; }

    aiExecuteBtn.disabled = true;
    aiExecuteBtn.classList.add('loading');
    aiExecuteBtn.textContent = '执行中...';

    var today = todayStr();
    var taskList = sel.map(function(t, i) {
      return (i+1) + '. ' + t.text +
        ' [分类:' + (CATEGORIES[t.category]||'其他') + ']' +
        (t.dueDate ? ' [截止:' + t.dueDate + ']' : '');
    }).join('\n');

    var p = '你是一个全能工作助手。用户选中了以下待办任务，请直接帮用户完成这些任务，产出实际可用的工作成果。\n\n' +
      '今天日期: ' + today + '\n\n' +
      '需要执行的任务:\n' + taskList + '\n\n' +
      '重要要求：不要告诉用户"你应该怎么做"，而是直接产出成果。例如：\n' +
      '- 如果任务是"写周报" → 直接写出一份周报\n' +
      '- 如果任务是"准备会议议程" → 直接写出议程内容\n' +
      '- 如果任务是"调研XX" → 直接给出调研报告\n' +
      '- 如果任务是"写邮件给XX" → 直接写出邮件全文\n' +
      '- 如果任务是"做PPT大纲" → 直接写出完整大纲\n' +
      '- 如果任务是"制定计划" → 直接写出详细计划\n' +
      '- 如果任务是"整理资料" → 直接给出整理好的框架和内容\n\n' +
      '对于每个任务，先用标题标明任务名，然后直接给出完整的工作成果（可以直接复制使用的程度）。\n' +
      '用中文回答，内容专业、详实，格式清晰。如果任务描述信息不足，请基于合理假设补充完整。';

    callAI(p, function(text, err) {
      aiExecuteBtn.disabled = false;
      aiExecuteBtn.classList.remove('loading');
      aiExecuteBtn.textContent = '\u26A1 任务执行';

      if (err) { alert('AI 错误: ' + err); return; }

      document.getElementById('aiModalTitle').textContent = '\u26A1 任务执行结果';
      document.getElementById('aiModalContent').textContent = text;
      document.getElementById('aiModal').classList.add('show');
    });
  }

  // ===== AI Feature 2: Daily Plan =====
  function aiDailyPlan() {
    var pending = todos.filter(function(t) { return !t.done; });
    if (pending.length === 0) { alert('没有未完成的待办事项'); return; }

    aiPlanBtn.disabled = true;
    aiPlanBtn.classList.add('loading');
    aiPlanBtn.textContent = '规划中...';

    var today = todayStr();
    var todoList = pending.map(function(t) {
      return '- ' + t.text + ' [分类:' + (CATEGORIES[t.category]||'其他') + ']' +
        (t.dueDate ? ' [截止:' + t.dueDate + ']' : ' [无截止日期]');
    }).join('\n');

    var p = '你是一个时间管理专家。根据用户的待办事项列表，生成一份今日行动计划。\n\n' +
      '今天日期: ' + today + '\n\n' +
      '待办事项:\n' + todoList + '\n\n' +
      '请生成:\n' +
      '1. 今日优先级排序（考虑截止日期紧迫性）\n' +
      '2. 建议的时间安排（上午/下午/晚上）\n' +
      '3. 一句话激励\n\n' +
      '用中文回答，格式清晰，使用 emoji 让内容更生动。';

    callAI(p, function(text, err) {
      aiPlanBtn.disabled = false;
      aiPlanBtn.classList.remove('loading');
      aiPlanBtn.textContent = '\u{1F4C5} 每日规划';

      if (err) { alert('AI 错误: ' + err); return; }

      document.getElementById('aiModalTitle').textContent = '\u{1F4CB} 今日规划';
      document.getElementById('aiModalContent').textContent = text;
      document.getElementById('aiModal').classList.add('show');
    });
  }

  // ===== Smart Add Modal =====
  function openSmartAdd() {
    smartAddText.value = '';
    smartAddResult.innerHTML = '';
    smartParseHint.textContent = '';
    smartParseHint.style.color = '';
    smartAddModal.classList.add('show');
    setTimeout(function() { smartAddText.focus(); }, 100);
  }

  function closeSmartAdd() {
    smartAddModal.classList.remove('show');
    if (recognition && isListening) recognition.stop();
  }

  function smartParse() {
    var text = smartAddText.value.trim();
    if (!text) { smartParseHint.textContent = '请先输入内容'; smartParseHint.style.color = '#f87171'; return; }

    smartParseBtn.disabled = true;
    smartParseBtn.textContent = '解析中...';
    smartParseBtn.classList.add('loading');
    smartParseHint.textContent = '';
    smartParseHint.style.color = '';

    var today = todayStr();
    var d = new Date();
    var tomorrow = new Date(d); tomorrow.setDate(d.getDate()+1);
    var dayAfter = new Date(d); dayAfter.setDate(d.getDate()+2);
    function fmt(dt) { return dt.getFullYear()+'-'+String(dt.getMonth()+1).padStart(2,'0')+'-'+String(dt.getDate()).padStart(2,'0'); }

    var p = '你是一个待办事项解析助手。用户输入了一段文字，请提取所有待办事项信息。\n\n' +
      '今天日期: ' + today + '（' + fmt(d) + '）\n' +
      '明天日期: ' + fmt(tomorrow) + '\n' +
      '后天日期: ' + fmt(dayAfter) + '\n\n' +
      '用户输入: "' + text + '"\n\n' +
      '请提取并返回JSON（可能包含多个待办）:\n' +
      '{"items":[{"text":"任务描述","dueDate":"YYYY-MM-DD","category":"work/life/study/other"}]}\n\n' +
      '规则:\n' +
      '- text: 简洁的任务描述，去掉时间词（今天、明天、后天、下周等）\n' +
      '- dueDate: 根据文字中的时间词推算具体日期。"今天"=' + today + '，"明天"=' + fmt(tomorrow) + '，"后天"=' + fmt(dayAfter) + '。"下周X"请计算具体日期。没提到时间就留空字符串\n' +
      '- category: work(工作/开会/项目/汇报), life(生活/买/吃/运动), study(学习/看书/课程), other(其他)\n' +
      '- 如果内容包含多个任务，拆分为多个items\n' +
      '- 如果只有一个任务也要返回数组格式\n\n' +
      '只返回JSON，不要其他内容。';

    callAI(p, function(result, err) {
      smartParseBtn.disabled = false;
      smartParseBtn.innerHTML = '&#129302; AI 解析';
      smartParseBtn.classList.remove('loading');

      if (err) {
        smartParseHint.textContent = '解析失败: ' + err;
        smartParseHint.style.color = '#f87171';
        return;
      }

      try {
        var match = result.match(/\{[\s\S]*\}/);
        var data = JSON.parse(match[0]);
        var items = data.items || [];
        if (items.length === 0) throw new Error('empty');
        renderSmartResults(items);
      } catch(e) {
        smartParseHint.textContent = '解析失败，请重试';
        smartParseHint.style.color = '#f87171';
      }
    });
  }

  function renderSmartResults(items) {
    var today = todayStr();
    var d = new Date();
    var tomorrow = new Date(d); tomorrow.setDate(d.getDate()+1);
    var dayAfter = new Date(d); dayAfter.setDate(d.getDate()+2);
    function fmt(dt) { return dt.getFullYear()+'-'+String(dt.getMonth()+1).padStart(2,'0')+'-'+String(dt.getDate()).padStart(2,'0'); }

    var html = '<div class="ai-result" style="margin-top:12px">';
    html += '<div style="font-weight:600;margin-bottom:8px;color:#7c3aed">解析结果 (' + items.length + ' 条待办)</div>';

    items.forEach(function(item, i) {
      var dateLabel = '';
      if (item.dueDate) {
        if (item.dueDate === today) dateLabel = '今天';
        else if (item.dueDate === fmt(tomorrow)) dateLabel = '明天';
        else if (item.dueDate === fmt(dayAfter)) dateLabel = '后天';
        else dateLabel = formatDate(item.dueDate);
      }
      html += '<div class="ai-task-item">' +
        '<span style="flex:1">' + (i+1) + '. ' + item.text +
        ' <span class="cat-badge cat-' + (item.category||'other') + '">' + (CATEGORIES[item.category]||'其他') + '</span>' +
        (dateLabel ? ' <span class="due-badge ' + dueDateClass(item.dueDate, false) + '">' + dateLabel + '</span>' : '') +
        '</span>' +
        '<button class="ai-add-btn" data-sidx="' + i + '">+ 添加</button></div>';
    });

    html += '<div style="margin-top:10px;text-align:right">' +
      '<button class="ai-add-btn" id="smartAddAllBtn" style="padding:5px 16px;font-size:12px">全部添加</button></div>';
    html += '</div>';

    smartAddResult.innerHTML = html;
    smartParseHint.textContent = '';
    smartParseHint.style.color = '';

    smartAddResult.querySelectorAll('.ai-add-btn[data-sidx]').forEach(function(btn) {
      btn.addEventListener('click', async function() {
        var idx = parseInt(this.getAttribute('data-sidx'));
        var item = items[idx];
        var newTodo = {
          id: Date.now() + idx, text: item.text, done: false,
          category: item.category || 'other', dueDate: item.dueDate || '',
          createdAt: new Date().toISOString(), parentId: null,
          sortOrder: todos.length
        };
        todos.push(newTodo);
        await saveTodoDB(newTodo);
        render();
        this.textContent = '已添加'; this.disabled = true; this.style.background = '#94a3b8';
      });
    });

    document.getElementById('smartAddAllBtn').addEventListener('click', async function() {
      var btns = smartAddResult.querySelectorAll('.ai-add-btn[data-sidx]');
      for (var i = 0; i < items.length; i++) {
        if (btns[i] && btns[i].disabled) continue;
        var item = items[i];
        var newTodo = {
          id: Date.now() + i, text: item.text, done: false,
          category: item.category || 'other', dueDate: item.dueDate || '',
          createdAt: new Date().toISOString(), parentId: null,
          sortOrder: todos.length + i
        };
        todos.push(newTodo);
        await saveTodoDB(newTodo);
      }
      render();
      this.textContent = '已全部添加'; this.disabled = true; this.style.background = '#94a3b8';
      smartAddResult.querySelectorAll('.ai-add-btn[data-sidx]').forEach(function(b) {
        b.textContent = '已添加'; b.disabled = true; b.style.background = '#94a3b8';
      });
    });
  }

  // ===== Filtering =====
  function getFiltered() {
    var search = searchInput.value.trim().toLowerCase();
    var cat = catFilter.value;
    return todos.filter(function(todo) {
      if (currentFilter === 'active' && todo.done) return false;
      if (currentFilter === 'done' && !todo.done) return false;
      if (cat !== 'all' && todo.category !== cat) return false;
      if (search && todo.text.toLowerCase().indexOf(search) === -1) return false;
      return true;
    });
  }

  // ===== Selection =====
  function getSelectedTodos() {
    return todos.filter(function(t) { return selectedIds.has(t.id); });
  }

  function renderSelectBar() {
    var count = selectedIds.size;
    if (count === 0) { selectBar.style.display = 'none'; return; }
    selectBar.style.display = 'flex';
    selectBar.innerHTML =
      '<span class="select-count">已选 ' + count + ' 项</span>' +
      '<button class="select-action" id="selBreakdown">&#127919; 拆解</button>' +
      '<button class="select-action" id="selExecute">&#9889; 执行</button>' +
      '<button class="select-action" id="selDone">&#x2705; 全部完成</button>' +
      '<button class="select-action danger" id="selDelete">&#x2715; 删除</button>' +
      '<button class="select-cancel" id="selClear">取消选择</button>';
    document.getElementById('selBreakdown').addEventListener('click', function() { aiBreakdownSelected(); });
    document.getElementById('selExecute').addEventListener('click', function() { aiExecuteSelected(); });
    document.getElementById('selDone').addEventListener('click', async function() {
      var sel = getSelectedTodos();
      for (var i = 0; i < sel.length; i++) {
        sel[i].done = true;
        await updateTodoDB(sel[i].id, { done: true });
      }
      selectedIds.clear(); render();
    });
    document.getElementById('selDelete').addEventListener('click', async function() {
      if (!confirm('确定删除选中的 ' + count + ' 项？')) return;
      var ids = new Set(selectedIds);
      var toDelete = todos.filter(function(t) { return ids.has(t.id) || ids.has(t.parentId); });
      for (var i = 0; i < toDelete.length; i++) {
        await deleteTodoDB(toDelete[i].id);
      }
      todos = todos.filter(function(t) { return !ids.has(t.id) && !ids.has(t.parentId); });
      selectedIds.clear(); render();
    });
    document.getElementById('selClear').addEventListener('click', function() {
      selectedIds.clear(); render();
    });
  }

  // ===== Render =====
  function render() {
    listEl.innerHTML = '';
    var filtered = getFiltered();

    if (todos.length === 0) {
      listEl.innerHTML = '<li class="empty">暂无待办事项，添加一个吧</li>';
      statsEl.textContent = '';
      return;
    }
    if (filtered.length === 0) {
      listEl.innerHTML = '<li class="empty">没有匹配的待办事项</li>';
      var r = todos.filter(function(t){return !t.done;}).length;
      statsEl.textContent = r + ' 项未完成 / 共 ' + todos.length + ' 项';
      return;
    }

    var parents = filtered.filter(function(t) { return !t.parentId; });
    var childMap = {};
    filtered.forEach(function(t) {
      if (t.parentId) {
        if (!childMap[t.parentId]) childMap[t.parentId] = [];
        childMap[t.parentId].push(t);
      }
    });

    var sorted = parents.slice().sort(function(a,b) {
      var da = a.dueDate || '\uffff', db = b.dueDate || '\uffff';
      return da < db ? -1 : da > db ? 1 : 0;
    });

    var lastDate = null;
    sorted.forEach(function(todo) {
      var dateKey = todo.dueDate || '';

      if (dateKey !== lastDate) {
        lastDate = dateKey;
        var header = document.createElement('li');
        header.className = 'date-header';
        var lbl = document.createElement('span');
        lbl.className = 'date-header-label ' + dateHeaderClass(dateKey);
        lbl.textContent = formatDateFull(dateKey);
        var ln = document.createElement('span');
        ln.className = 'date-header-line';
        header.appendChild(lbl);
        header.appendChild(ln);
        listEl.appendChild(header);
      }

      appendTodoLi(todo, false);
      var children = childMap[todo.id] || [];
      children.forEach(function(child) { appendTodoLi(child, true); });
    });

    function appendTodoLi(todo, isSubtask) {
      var realIndex = todos.indexOf(todo);
      var li = document.createElement('li');
      li.className = 'todo-item' + (isSubtask ? ' subtask' : '');
      li.setAttribute('data-index', realIndex);
      var isEditing = editingId === todo.id;

      if (!isEditing) {
        li.setAttribute('draggable', 'true');
        li.addEventListener('dragstart', handleDragStart);
        li.addEventListener('dragover', handleDragOver);
        li.addEventListener('dragleave', handleDragLeave);
        li.addEventListener('drop', handleDrop);
        li.addEventListener('dragend', handleDragEnd);

        var chk = document.createElement('input');
        chk.type = 'checkbox';
        chk.className = 'todo-checkbox';
        chk.checked = selectedIds.has(todo.id);
        (function(tid) {
          chk.addEventListener('change', function() {
            if (this.checked) selectedIds.add(tid); else selectedIds.delete(tid);
            renderSelectBar();
          });
        })(todo.id);

        var handle = document.createElement('span');
        handle.className = 'drag-handle';
        handle.textContent = '\u2807';

        var content = document.createElement('div');
        content.className = 'item-content';
        var textSpan = document.createElement('span');
        textSpan.className = 'todo-text' + (todo.done ? ' done' : '');
        textSpan.textContent = todo.text;
        var meta = document.createElement('div');
        meta.className = 'item-meta';
        var catBadge = document.createElement('span');
        catBadge.className = 'cat-badge cat-' + todo.category;
        catBadge.textContent = CATEGORIES[todo.category] || '其他';
        meta.appendChild(catBadge);
        content.appendChild(textSpan);
        content.appendChild(meta);

        var compBtn = document.createElement('button');
        compBtn.className = 'complete-btn' + (todo.done ? ' is-done' : '');
        compBtn.textContent = todo.done ? '已完成' : '完成';
        compBtn.addEventListener('click', async function() {
          todo.done = !todo.done;
          await updateTodoDB(todo.id, { done: todo.done });
          render();
        });

        var eb = document.createElement('button');
        eb.className = 'edit-btn';
        eb.innerHTML = '&#9998;';
        eb.addEventListener('click', function() { editingId = todo.id; render(); });

        var db = document.createElement('button');
        db.className = 'del-btn';
        db.innerHTML = '&#x2715;';
        db.addEventListener('click', async function() {
          var tid = todo.id;
          var children = todos.filter(function(t) { return t.parentId === tid; });
          await deleteTodoDB(tid);
          for (var i = 0; i < children.length; i++) {
            await deleteTodoDB(children[i].id);
          }
          todos = todos.filter(function(t) { return t.id !== tid && t.parentId !== tid; });
          selectedIds.delete(tid); render();
        });

        li.appendChild(chk);
        li.appendChild(handle);
        li.appendChild(content);
        li.appendChild(compBtn);
        li.appendChild(eb);
        li.appendChild(db);
      } else {
        var er = document.createElement('div');
        er.className = 'edit-row';
        var et = document.createElement('input'); et.type='text'; et.value=todo.text;
        var ed = document.createElement('input'); ed.type='date'; ed.value=todo.dueDate||'';
        var ec = document.createElement('select');
        CAT_KEYS.forEach(function(k){ var o=document.createElement('option'); o.value=k; o.textContent=CATEGORIES[k]; if(todo.category===k) o.selected=true; ec.appendChild(o); });
        var sb = document.createElement('button'); sb.className='save-edit-btn'; sb.textContent='保存';
        sb.addEventListener('click', async function(){
          var v=et.value.trim(); if(!v)return;
          todo.text=v; todo.dueDate=ed.value||''; todo.category=ec.value;
          editingId=null;
          await updateTodoDB(todo.id, { text: v, dueDate: ed.value||'', category: ec.value });
          render();
        });
        var cb2 = document.createElement('button'); cb2.className='cancel-edit-btn'; cb2.textContent='取消';
        cb2.addEventListener('click', function(){ editingId=null; render(); });
        et.addEventListener('keydown', function(e){ if(e.key==='Enter') sb.click(); if(e.key==='Escape') cb2.click(); });
        er.appendChild(et); er.appendChild(ed); er.appendChild(ec); er.appendChild(sb); er.appendChild(cb2);
        li.appendChild(er);
        setTimeout(function(){ et.focus(); et.select(); }, 0);
      }
      listEl.appendChild(li);
    }

    var remaining = todos.filter(function(t){return !t.done;}).length;
    statsEl.textContent = remaining + ' 项未完成 / 共 ' + todos.length + ' 项';
    renderSelectBar();
  }

  // ===== Add Todo =====
  async function addTodo() {
    var text = input.value.trim();
    if (!text) return;
    var newTodo = {
      id: Date.now(), text: text, done: false,
      category: categoryInput.value, dueDate: dueDateInput.value || '',
      createdAt: new Date().toISOString(), parentId: null,
      sortOrder: todos.length
    };
    todos.push(newTodo);
    input.value = '';
    dueDateInput.value = '';
    render();
    input.focus();
    await saveTodoDB(newTodo);
  }

  // ===== Drag & Drop =====
  function handleDragStart(e) { dragSrcIndex=parseInt(this.getAttribute('data-index')); this.classList.add('dragging'); e.dataTransfer.effectAllowed='move'; e.dataTransfer.setData('text/plain',dragSrcIndex); }
  function handleDragOver(e) { e.preventDefault(); e.dataTransfer.dropEffect='move'; this.classList.add('drag-over'); }
  function handleDragLeave() { this.classList.remove('drag-over'); }
  async function handleDrop(e) {
    e.preventDefault(); this.classList.remove('drag-over');
    var t=parseInt(this.getAttribute('data-index'));
    if(dragSrcIndex===null||dragSrcIndex===t) return;
    var item=todos.splice(dragSrcIndex,1)[0];
    todos.splice(t,0,item);
    render();
    await saveAllSortOrders();
  }
  function handleDragEnd() { this.classList.remove('dragging'); dragSrcIndex=null; listEl.querySelectorAll('.todo-item').forEach(function(i){i.classList.remove('drag-over');}); }

  // ===== Export / Import =====
  function exportData() {
    var blob = new Blob([JSON.stringify(todos,null,2)], {type:'application/json'});
    var url = URL.createObjectURL(blob);
    var a = document.createElement('a'); a.href=url; a.download='my-todo-backup.json';
    document.body.appendChild(a); a.click(); document.body.removeChild(a); URL.revokeObjectURL(url);
  }
  async function importData(file) {
    var reader = new FileReader();
    reader.onload = async function(e) {
      try {
        var data = JSON.parse(e.target.result);
        if (!Array.isArray(data)) { alert('无效的数据格式'); return; }
        if (!confirm('导入将替换当前所有数据，确定继续吗？')) return;

        // Delete all existing todos from DB
        for (var i = 0; i < todos.length; i++) {
          await deleteTodoDB(todos[i].id);
        }

        todos = data.map(function(item,idx) {
          if(!item.id) item.id=Date.now()+idx; if(!item.category) item.category='other';
          if(item.dueDate===undefined) item.dueDate=''; if(!item.createdAt) item.createdAt=new Date().toISOString();
          if(item.done===undefined) item.done=false; if(!item.text) item.text='';
          if(item.parentId===undefined) item.parentId=null;
          item.sortOrder = idx;
          return item;
        });

        // Save all to DB
        for (var j = 0; j < todos.length; j++) {
          await saveTodoDB(todos[j]);
        }

        render();
        alert('导入成功！共 ' + todos.length + ' 条记录');
      } catch(err) { alert('文件解析失败：' + err.message); }
    };
    reader.readAsText(file);
  }

  // ===== Voice Input for Smart Add Modal =====
  var SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
  var recognition = null;
  var isListening = false;

  if (SpeechRecognition) {
    recognition = new SpeechRecognition();
    recognition.lang = 'zh-CN';
    recognition.continuous = false;
    recognition.interimResults = true;

    recognition.onstart = function() {
      isListening = true;
      smartMicBtn.classList.add('listening');
      smartParseHint.textContent = '正在聆听...';
      smartParseHint.style.color = '#7c3aed';
    };

    recognition.onresult = function(event) {
      var transcript = '';
      for (var i = event.resultIndex; i < event.results.length; i++) {
        transcript += event.results[i][0].transcript;
      }
      var current = smartAddText.value;
      if (current && !current.endsWith('\n') && !current.endsWith('，') && !current.endsWith('。')) {
        smartAddText.value = current + '，' + transcript;
      } else {
        smartAddText.value = current + transcript;
      }
      if (event.results[event.results.length - 1].isFinal) {
        smartParseHint.textContent = '语音已录入，点击 "AI 解析" 生成待办';
        smartParseHint.style.color = '#16a34a';
      }
    };

    recognition.onerror = function(event) {
      isListening = false;
      smartMicBtn.classList.remove('listening');
      smartParseHint.style.color = '#f87171';
      if (event.error === 'not-allowed') {
        smartParseHint.textContent = '请允许麦克风权限';
      } else if (event.error === 'no-speech') {
        smartParseHint.textContent = '未检测到语音，请重试';
      } else {
        smartParseHint.textContent = '语音识别出错: ' + event.error;
      }
    };

    recognition.onend = function() {
      isListening = false;
      smartMicBtn.classList.remove('listening');
    };
  } else {
    smartMicBtn.classList.add('unsupported');
    smartMicBtn.title = '您的浏览器不支持语音输入';
  }

  function toggleSmartVoice() {
    if (!recognition) { alert('您的浏览器不支持语音输入，请使用 Chrome'); return; }
    if (isListening) {
      recognition.stop();
    } else {
      recognition.start();
    }
  }

  // ===== Text-to-Speech =====
  function speakText(text) {
    if (!window.speechSynthesis) { alert('您的浏览器不支持语音朗读'); return; }
    speechSynthesis.cancel();
    var utterance = new SpeechSynthesisUtterance(text);
    utterance.lang = 'zh-CN';
    utterance.rate = 1.0;
    utterance.onstart = function() { modalSpeakBtn.classList.add('speaking'); modalSpeakBtn.innerHTML = '&#128266;'; };
    utterance.onend = function() { modalSpeakBtn.classList.remove('speaking'); modalSpeakBtn.innerHTML = '&#128264;'; };
    utterance.onerror = function() { modalSpeakBtn.classList.remove('speaking'); modalSpeakBtn.innerHTML = '&#128264;'; };
    speechSynthesis.speak(utterance);
  }

  // ===== Event Listeners =====
  addBtn.addEventListener('click', addTodo);
  input.addEventListener('keydown', function(e) { if(e.key==='Enter') addTodo(); });

  smartAddBtn.addEventListener('click', openSmartAdd);
  smartMicBtn.addEventListener('click', toggleSmartVoice);
  smartParseBtn.addEventListener('click', smartParse);
  smartAddClose.addEventListener('click', closeSmartAdd);

  modalSpeakBtn.addEventListener('click', function() {
    if (speechSynthesis.speaking) {
      speechSynthesis.cancel();
      modalSpeakBtn.classList.remove('speaking');
      modalSpeakBtn.innerHTML = '&#128264;';
    } else {
      var text = document.getElementById('aiModalContent').textContent;
      if (text) speakText(text);
    }
  });

  document.querySelectorAll('.filter-btn').forEach(function(btn) {
    btn.addEventListener('click', function() {
      document.querySelectorAll('.filter-btn').forEach(function(b){b.classList.remove('active');});
      btn.classList.add('active');
      currentFilter = btn.getAttribute('data-filter');
      render();
    });
  });

  searchInput.addEventListener('input', render);
  catFilter.addEventListener('change', render);

  exportBtn.addEventListener('click', exportData);
  importBtn.addEventListener('click', function() { importFile.click(); });
  importFile.addEventListener('change', function() { if(this.files&&this.files[0]){importData(this.files[0]);this.value='';} });

  aiBreakdownBtn.addEventListener('click', aiBreakdown);
  aiExecuteBtn.addEventListener('click', function() { aiExecuteSelected(); });
  aiPlanBtn.addEventListener('click', aiDailyPlan);

  renderKeyArea();

  // ===== Init =====
  checkAuth();
})();
</script>

</body>
</html>
